<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SwingTreeContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree</a> &gt; <span class="el_source">SwingTreeContext.java</span></div><h1>SwingTreeContext.java</h1><pre class="source lang-java linenums">package swingtree;

import swingtree.style.StyleSheet;
import swingtree.threading.EventProcessor;

import javax.swing.*;
import javax.swing.plaf.DimensionUIResource;
import javax.swing.plaf.FontUIResource;
import javax.swing.plaf.InsetsUIResource;
import javax.swing.plaf.UIResource;
import java.awt.*;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeSupport;
import java.lang.reflect.Method;
import java.util.Locale;
import java.util.Objects;
import java.util.Optional;
import java.util.StringTokenizer;

/**
 *  A {@link SwingTreeContext} is a singleton that holds global configuration for the SwingTree library.
 *  This includes the {@link EventProcessor} that is used to process events, as well as the
 *  {@link StyleSheet} that is used to style components.
 *
 * @author Daniel Nepp
 */
public final class SwingTreeContext
{
<span class="fc" id="L30">	private static SwingTreeContext _INSTANCES = null;</span>

	/**
	 * Returns the singleton instance of the {@link SwingTreeContext}.
	 * Note that this method will create the singleton if it does not exist.
	 * @return the singleton instance of the {@link SwingTreeContext}.
	 */
	public static SwingTreeContext get() {
		// We make sure this method is thread-safe by using the double-checked locking idiom.
<span class="fc bfc" id="L39" title="All 2 branches covered.">		if ( _INSTANCES == null ) {</span>
<span class="fc" id="L40">			synchronized ( SwingTreeContext.class ) {</span>
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">				if ( _INSTANCES == null ) {</span>
<span class="fc" id="L42">					_INSTANCES = new SwingTreeContext();</span>
				}
<span class="fc" id="L44">			}</span>
		}
<span class="fc" id="L46">		return _INSTANCES;</span>
	}

    public static void reset() {
<span class="fc" id="L50">        _INSTANCES = null;</span>
<span class="fc" id="L51">    }</span>


<span class="fc" id="L54">	private EventProcessor _eventProcessor = EventProcessor.COUPLED_STRICT;</span>
<span class="fc" id="L55">	private StyleSheet _styleSheet = null;</span>

    private final UIScale uiScale;


<span class="fc" id="L60">	private SwingTreeContext() {</span>
<span class="fc" id="L61">        this.uiScale = new UIScale();</span>
<span class="fc" id="L62">    }</span>

<span class="fc" id="L64">    public UIScale getUIScale() { return uiScale; }</span>

	/**
	 * @return The currently configured {@link EventProcessor} that is used to process
	 *         GUI and application events.
	 */
	public EventProcessor getEventProcessor() {
<span class="fc" id="L71">		return _eventProcessor;</span>
	}

	/**
	 * Sets the {@link EventProcessor} that is used to process GUI and application events.
	 * @param eventProcessor the {@link EventProcessor} that is used to process GUI and application events.
	 */
	public void setEventProcessor( EventProcessor eventProcessor ) {
<span class="fc" id="L79">		_eventProcessor = Objects.requireNonNull(eventProcessor);</span>
<span class="fc" id="L80">	}</span>

	/**
	 * @return The currently configured {@link StyleSheet} that is used to style components.
	 */
	public Optional&lt;StyleSheet&gt; getStyleSheet() {
<span class="fc" id="L86">		return Optional.ofNullable(_styleSheet);</span>
	}

	/**
	 * Sets the {@link StyleSheet} that is used to style components.
	 * @param styleSheet the {@link StyleSheet} that is used to style components.
	 */
	public void setStyleSheet(StyleSheet styleSheet) {
<span class="fc" id="L94">		_styleSheet = styleSheet;</span>
<span class="fc" id="L95">	}</span>

    /**
     * This class handles scaling in Swing UIs.
     * It computes user scaling factor based on font size and
     * provides methods to scale integer, float, {@link Dimension} and {@link Insets}.
     * This class is look and feel independent.
     * &lt;p&gt;
     * Two scaling modes are supported by SwingTree for HiDPI displays:
     *
     * &lt;h2&gt;1) system scaling mode&lt;/h2&gt;
     *
     * This mode is supported since Java 9 on all platforms and in some Java 8 VMs
     * (e.g. Apple and JetBrains). The JRE determines the scale factor per-display and
     * adds a scaling transformation to the graphics object.
     * E.g. invokes {@code java.awt.Graphics2D.scale( 1.5, 1.5 )} for 150%.
     * So the JRE does the scaling itself.
     * E.g. when you draw a 10px line, a 15px line is drawn on screen.
     * The scale factor may be different for each connected display.
     * The scale factor may change for a window when moving the window from one display to another one.
     *
     * &lt;h2&gt;2) user scaling mode&lt;/h2&gt;
     *
     * This mode is mainly for Java 8 compatibility, but is also used on Linux
     * or if the default font is changed.
     * The user scale factor is computed based on the used font.
     * The JRE does not scale anything.
     * So we have to invoke {@link #scale(float)} where necessary.
     * There is only one user scale factor for all displays.
     * The user scale factor may change if the active LaF, &quot;defaultFont&quot; or &quot;Label.font&quot; has changed.
     * If system scaling mode is available the user scale factor is usually 1,
     * but may be larger on Linux or if the default font is changed.
     *
     * @author Daniel Nepp, but a derivative work originally from Karl Tauber (com.formdev.flatlaf.util.UIScale)
     */
    public static final class UIScale
    {
<span class="fc" id="L132">        private final boolean DEBUG = false;</span>

        private PropertyChangeSupport changeSupport;

        private Boolean jreHiDPI;

<span class="fc" id="L138">        private float scaleFactor = 1;</span>
        private boolean initialized;


<span class="fc" id="L142">        private UIScale() {} // prevent instantiation</span>

        public void addPropertyChangeListener( PropertyChangeListener listener ) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if( changeSupport == null )</span>
<span class="nc" id="L146">                changeSupport = new PropertyChangeSupport( UIScale.class );</span>
<span class="nc" id="L147">            changeSupport.addPropertyChangeListener( listener );</span>
<span class="nc" id="L148">        }</span>

        public void removePropertyChangeListener( PropertyChangeListener listener ) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if( changeSupport == null )</span>
<span class="nc" id="L152">                return;</span>
<span class="nc" id="L153">            changeSupport.removePropertyChangeListener( listener );</span>
<span class="nc" id="L154">        }</span>

        //---- system scaling (Java 9) --------------------------------------------

        /**
         * Returns whether system scaling is enabled.
         */
        public boolean isSystemScalingEnabled() {
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if( jreHiDPI != null )</span>
<span class="nc" id="L163">                return jreHiDPI;</span>

<span class="nc" id="L165">            jreHiDPI = false;</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">            if( SystemInfo.isJava_9_orLater ) {</span>
                // Java 9 and later supports per-monitor scaling
<span class="nc" id="L169">                jreHiDPI = true;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            } else if( SystemInfo.isJetBrainsJVM ) {</span>
                // IntelliJ IDEA ships its own JetBrains Java 8 JRE that may support per-monitor scaling
                // see com.intellij.ui.JreHiDpiUtil.isJreHiDPIEnabled()
                try {
<span class="nc" id="L174">                    GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();</span>
<span class="nc" id="L175">                    Class&lt;?&gt; sunGeClass = Class.forName( &quot;sun.java2d.SunGraphicsEnvironment&quot; );</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                    if( sunGeClass.isInstance( ge ) ) {</span>
<span class="nc" id="L177">                        Method m = sunGeClass.getDeclaredMethod( &quot;isUIScaleOn&quot; );</span>
<span class="nc" id="L178">                        jreHiDPI = (Boolean) m.invoke( ge );</span>
                    }
<span class="nc" id="L180">                } catch( Throwable ex ) {</span>
                    // ignore
<span class="nc" id="L182">                }</span>
            }

<span class="nc" id="L185">            return jreHiDPI;</span>
        }

        /**
         * Returns the system scale factor for the given graphics context.
         */
        public double getSystemScaleFactor( Graphics2D g ) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">            return isSystemScalingEnabled() ? getSystemScaleFactor( g.getDeviceConfiguration() ) : 1;</span>
        }

        /**
         * Returns the system scale factor for the given graphics configuration.
         */
        public double getSystemScaleFactor( GraphicsConfiguration gc ) {
<span class="nc bnc" id="L199" title="All 4 branches missed.">            return (isSystemScalingEnabled() &amp;&amp; gc != null) ? gc.getDefaultTransform().getScaleX() : 1;</span>
        }

        //---- user scaling (Java 8) ----------------------------------------------

        private void initialize() {
<span class="fc bfc" id="L205" title="All 2 branches covered.">            if( initialized )</span>
<span class="fc" id="L206">                return;</span>
<span class="fc" id="L207">            initialized = true;</span>

<span class="pc bpc" id="L209" title="1 of 2 branches missed.">            if( !isUserScalingEnabled() )</span>
<span class="nc" id="L210">                return;</span>

            // listener to update scale factor if LaF changed, &quot;defaultFont&quot; or &quot;Label.font&quot; changed
<span class="fc" id="L213">            PropertyChangeListener listener = new PropertyChangeListener() {</span>
                @Override
                public void propertyChange( PropertyChangeEvent e ) {
<span class="pc bpc" id="L216" title="1 of 3 branches missed.">                    switch( e.getPropertyName() ) {</span>
                        case &quot;lookAndFeel&quot;:
                            // it is not necessary (and possible) to remove listener of old LaF defaults
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">                            if( e.getNewValue() instanceof LookAndFeel)</span>
<span class="fc" id="L220">                                UIManager.getLookAndFeelDefaults().addPropertyChangeListener( this );</span>
<span class="fc" id="L221">                            updateScaleFactor();</span>
<span class="fc" id="L222">                            break;</span>

                        case &quot;defaultFont&quot;:
                        case &quot;Label.font&quot;:
<span class="nc" id="L226">                            updateScaleFactor();</span>
                            break;
                    }
<span class="fc" id="L229">                }</span>
            };
<span class="fc" id="L231">            UIManager.addPropertyChangeListener( listener );</span>
<span class="fc" id="L232">            UIManager.getDefaults().addPropertyChangeListener( listener );</span>
<span class="fc" id="L233">            UIManager.getLookAndFeelDefaults().addPropertyChangeListener( listener );</span>

<span class="fc" id="L235">            updateScaleFactor();</span>
<span class="fc" id="L236">        }</span>

        public void reset() {
<span class="nc" id="L239">            scaleFactor = 1;</span>
<span class="nc" id="L240">            initialized = false;</span>
<span class="nc" id="L241">        }</span>

        private void updateScaleFactor() {
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if( !isUserScalingEnabled() )</span>
<span class="nc" id="L245">                return;</span>

            // apply custom scale factor specified in system property &quot;style.uiScale&quot;
<span class="fc" id="L248">            float customScaleFactor = getCustomScaleFactor();</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">            if( customScaleFactor &gt; 0 ) {</span>
<span class="nc" id="L250">                setUserScaleFactor( customScaleFactor, false );</span>
<span class="nc" id="L251">                return;</span>
            }

            // use font size to calculate scale factor (instead of DPI)
            // because even if we are on a HiDPI display it is not sure
            // that a larger font size is set by the current LaF
            // (e.g. can avoid large icons with small text)
<span class="fc" id="L258">            Font font = UIManager.getFont( &quot;defaultFont&quot; );</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">            if( font == null )</span>
<span class="fc" id="L260">                font = UIManager.getFont( &quot;Label.font&quot; );</span>

<span class="fc" id="L262">            setUserScaleFactor( computeFontScaleFactor( font ), true );</span>
<span class="fc" id="L263">        }</span>

        /**
         * For internal use only.
         *
         * @since 2
         */
        public float computeFontScaleFactor( Font font ) {
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">            if( SystemInfo.isWindows ) {</span>
                // Special handling for Windows to be compatible with OS scaling,
                // which distinguish between &quot;screen scaling&quot; and &quot;text scaling&quot;.
                //  - Windows &quot;screen scaling&quot; scales everything (text, icon, gaps, etc)
                //    and may have different scaling factors for each screen.
                //  - Windows &quot;text scaling&quot; increases only the font size, but on all screens.
                //
                // Both can be changed by the user in the Windows 10 Settings:
                //  - Settings &gt; Display &gt; Scale and layout
                //  - Settings &gt; Ease of Access &gt; Display &gt; Make text bigger (100% - 225%)
<span class="nc bnc" id="L281" title="All 2 branches missed.">                if( font instanceof UIResource) {</span>
<span class="nc" id="L282">                    Font uiFont = (Font) Toolkit.getDefaultToolkit().getDesktopProperty( &quot;win.messagebox.font&quot; );</span>
<span class="nc bnc" id="L283" title="All 4 branches missed.">                    if( uiFont == null || uiFont.getSize() == font.getSize() ) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                        if( isSystemScalingEnabled() ) {</span>
                            // Do not apply own scaling if the JRE scales using Windows screen scale factor.
                            // If user increases font size in Windows 10 settings, desktop property
                            // &quot;win.messagebox.font&quot; is changed and FlatLaf uses the larger font.
<span class="nc" id="L288">                            return 1;</span>
                        } else {
                            // If the JRE does not scale (Java 8), the size of the UI font
                            // (usually from desktop property &quot;win.messagebox.font&quot;)
                            // combines the Windows screen and text scale factors.
                            // But the font in desktop property &quot;win.defaultGUI.font&quot; is only
                            // scaled with the Windows screen scale factor. So use it to compute
                            // our scale factor that is equal to Windows screen scale factor.
<span class="nc" id="L296">                            Font winFont = (Font) Toolkit.getDefaultToolkit().getDesktopProperty( &quot;win.defaultGUI.font&quot; );</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                            return computeScaleFactor( (winFont != null) ? winFont : font );</span>
                        }
                    }
                }

                // If font was explicitly set from outside (is not a UIResource),
                // or was set in FlatLaf properties files (is a UIResource),
                // use it to compute scale factor. This allows applications to
                // use custom fonts (e.g. that the user can change in UI) and
                // get scaling if a larger font size is used.
                // E.g. FlatLaf Demo supports increasing font size in &quot;Font&quot; menu and UI scales.
            }

<span class="fc" id="L310">            return computeScaleFactor( font );</span>
        }

        private static float computeScaleFactor( Font font ) {
            // default font size
<span class="fc" id="L315">            float fontSizeDivider = 12f;</span>

<span class="pc bpc" id="L317" title="1 of 2 branches missed.">            if( SystemInfo.isWindows ) {</span>
                // Windows LaF uses Tahoma font rather than the actual Windows system font (Segoe UI),
                // and its size is always ca. 10% smaller than the actual system font size.
                // Tahoma 11 is used at 100%
<span class="nc bnc" id="L321" title="All 2 branches missed.">                if( &quot;Tahoma&quot;.equals( font.getFamily() ) )</span>
<span class="nc" id="L322">                    fontSizeDivider = 11f;</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">            } else if( SystemInfo.isMacOS ) {</span>
                // default font size on macOS is 13
<span class="nc" id="L325">                fontSizeDivider = 13f;</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">            } else if( SystemInfo.isLinux ) {</span>
                // default font size for Unity and Gnome is 15 and for KDE it is 13
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">                fontSizeDivider = SystemInfo.isKDE ? 13f : 15f;</span>
            }

<span class="fc" id="L331">            return font.getSize() / fontSizeDivider;</span>
        }

        private static boolean isUserScalingEnabled() {
<span class="fc" id="L335">            return SystemProperties.getBoolean( SystemProperties.UI_SCALE_ENABLED, true );</span>
        }

        /**
         * Applies a custom scale factor given in system property &quot;style.uiScale&quot;
         * to the given font.
         */
        public FontUIResource applyCustomScaleFactor(FontUIResource font ) {
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if( !isUserScalingEnabled() )</span>
<span class="nc" id="L344">                return font;</span>

<span class="nc" id="L346">            float scaleFactor = getCustomScaleFactor();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if( scaleFactor &lt;= 0 )</span>
<span class="nc" id="L348">                return font;</span>

<span class="nc" id="L350">            float fontScaleFactor = computeScaleFactor( font );</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            if( scaleFactor == fontScaleFactor )</span>
<span class="nc" id="L352">                return font;</span>

<span class="nc" id="L354">            int newFontSize = Math.max( Math.round( (font.getSize() / fontScaleFactor) * scaleFactor ), 1 );</span>
<span class="nc" id="L355">            return new FontUIResource( font.deriveFont( (float) newFontSize ) );</span>
        }

        /**
         * Get custom scale factor specified in system property &quot;style.uiScale&quot;.
         */
        private static float getCustomScaleFactor() {
<span class="fc" id="L362">            return parseScaleFactor( System.getProperty( SystemProperties.UI_SCALE ) );</span>
        }

        /**
         * Similar to sun.java2d.SunGraphicsEnvironment.getScaleFactor(String)
         */
        private static float parseScaleFactor( String s ) {
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">            if( s == null )</span>
<span class="fc" id="L370">                return -1;</span>

<span class="nc" id="L372">            float units = 1;</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if( s.endsWith( &quot;x&quot; ) )</span>
<span class="nc" id="L374">                s = s.substring( 0, s.length() - 1 );</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            else if( s.endsWith( &quot;dpi&quot; ) ) {</span>
<span class="nc" id="L376">                units = 96;</span>
<span class="nc" id="L377">                s = s.substring( 0, s.length() - 3 );</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            } else if( s.endsWith( &quot;%&quot; ) ) {</span>
<span class="nc" id="L379">                units = 100;</span>
<span class="nc" id="L380">                s = s.substring( 0, s.length() - 1 );</span>
            }

            try {
<span class="nc" id="L384">                float scale = Float.parseFloat( s );</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                return scale &gt; 0 ? scale / units : -1;</span>
<span class="nc" id="L386">            } catch( NumberFormatException ex ) {</span>
<span class="nc" id="L387">                return -1;</span>
            }
        }

        /**
         * Returns the user scale factor.
         */
        public float getUserScaleFactor() {
<span class="fc" id="L395">            initialize();</span>
<span class="fc" id="L396">            return scaleFactor;</span>
        }

        public void setUserScaleFactor( float scaleFactor ) {
<span class="fc" id="L400">            initialize();</span>
<span class="fc" id="L401">            setUserScaleFactor( scaleFactor, true );</span>
<span class="fc" id="L402">        }</span>

        /**
         * Sets the user scale factor.
         */
        private void setUserScaleFactor( float scaleFactor, boolean normalize ) {
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">            if( normalize ) {</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">                if( scaleFactor &lt; 1f ) {</span>
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">                    scaleFactor = SystemProperties.getBoolean( SystemProperties.UI_SCALE_ALLOW_SCALE_DOWN, false )</span>
<span class="pc" id="L411">                            ? Math.round( scaleFactor * 10f ) / 10f // round small scale factor to 1/10</span>
                            : 1f;
<span class="fc bfc" id="L413" title="All 2 branches covered.">                } else if( scaleFactor &gt; 1f ) // round scale factor to 1/4</span>
<span class="fc" id="L414">                    scaleFactor = Math.round( scaleFactor * 4f ) / 4f;</span>
            }

            // minimum scale factor
<span class="fc" id="L418">            scaleFactor = Math.max( scaleFactor, 0.1f );</span>

<span class="fc" id="L420">            float oldScaleFactor = this.scaleFactor;</span>
<span class="fc" id="L421">            this.scaleFactor = scaleFactor;</span>

            if( DEBUG )
                System.out.println( &quot;HiDPI scale factor &quot; + scaleFactor );

<span class="pc bpc" id="L426" title="1 of 2 branches missed.">            if( changeSupport != null )</span>
<span class="nc" id="L427">                changeSupport.firePropertyChange( &quot;userScaleFactor&quot;, oldScaleFactor, scaleFactor );</span>
<span class="fc" id="L428">        }</span>

        /**
         * Multiplies the given value by the user scale factor.
         */
        public float scale( float value ) {
<span class="nc" id="L434">            initialize();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">            return (scaleFactor == 1) ? value : (value * scaleFactor);</span>
        }

        /**
         * Multiplies the given value by the user scale factor.
         */
        public double scale( double value ) {
<span class="nc" id="L442">            initialize();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">            return (scaleFactor == 1) ? value : (value * scaleFactor);</span>
        }

        /**
         * Multiplies the given value by the user scale factor and rounds the result.
         */
        public int scale( int value ) {
<span class="fc" id="L450">            initialize();</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">            return (scaleFactor == 1) ? value : Math.round( value * scaleFactor );</span>
        }

        /**
         * Similar as {@link #scale(int)} but always &quot;rounds down&quot;.
         * &lt;p&gt;
         * For use in special cases. {@link #scale(int)} is the preferred method.
         */
        public int scale2( int value ) {
<span class="nc" id="L460">            initialize();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            return (scaleFactor == 1) ? value : (int) (value * scaleFactor);</span>
        }

        /**
         * Divides the given value by the user scale factor.
         */
        public float unscale( float value ) {
<span class="nc" id="L468">            initialize();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">            return (scaleFactor == 1f) ? value : (value / scaleFactor);</span>
        }

        /**
         * Divides the given value by the user scale factor and rounds the result.
         */
        public int unscale( int value ) {
<span class="nc" id="L476">            initialize();</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">            return (scaleFactor == 1f) ? value : Math.round( value / scaleFactor );</span>
        }

        /**
         * If user scale factor is not 1, scale the given graphics context by invoking
         * {@link Graphics2D#scale(double, double)} with user scale factor.
         */
        public void scaleGraphics( Graphics2D g ) {
<span class="nc" id="L485">            initialize();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if( scaleFactor != 1f )</span>
<span class="nc" id="L487">                g.scale( scaleFactor, scaleFactor );</span>
<span class="nc" id="L488">        }</span>

        /**
         * Scales the given dimension with the user scale factor.
         * &lt;p&gt;
         * If user scale factor is 1, then the given dimension is simply returned.
         * Otherwise, a new instance of {@link Dimension} or {@link DimensionUIResource}
         * is returned, depending on whether the passed dimension implements {@link UIResource}.
         */
        public Dimension scale( Dimension dimension ) {
<span class="fc" id="L498">            initialize();</span>
<span class="pc bpc" id="L499" title="2 of 6 branches missed.">            return (dimension == null || scaleFactor == 1f)</span>
                    ? dimension
                    : (dimension instanceof UIResource
<span class="pc" id="L502">                    ? new DimensionUIResource( scale( dimension.width ), scale( dimension.height ) )</span>
<span class="fc" id="L503">                    : new Dimension          ( scale( dimension.width ), scale( dimension.height ) ));</span>
        }

        /**
         * Scales the given insets with the user scale factor.
         * &lt;p&gt;
         * If user scale factor is 1, then the given insets is simply returned.
         * Otherwise, a new instance of {@link Insets} or {@link InsetsUIResource}
         * is returned, depending on whether the passed dimension implements {@link UIResource}.
         */
        public Insets scale( Insets insets ) {
<span class="nc" id="L514">            initialize();</span>
<span class="nc bnc" id="L515" title="All 6 branches missed.">            return (insets == null || scaleFactor == 1f)</span>
                    ? insets
                    : (insets instanceof UIResource
<span class="nc" id="L518">                    ? new InsetsUIResource( scale( insets.top ), scale( insets.left ), scale( insets.bottom ), scale( insets.right ) )</span>
<span class="nc" id="L519">                    : new Insets          ( scale( insets.top ), scale( insets.left ), scale( insets.bottom ), scale( insets.right ) ));</span>
        }
    }

    /**
     * Defines/documents own system properties used in SwingTree.
     *
     * @author Daniel Nepp, but originally a derivative work of Karl Tauber
     */
    private static interface SystemProperties
    {
        /**
         * Specifies a custom scale factor used to scale the UI.
         * &lt;p&gt;
         * If Java runtime scales (Java 9 or later), this scale factor is applied on top
         * of the Java system scale factor. Java 8 does not scale and this scale factor
         * replaces the user scale factor that FlatLaf computes based on the font.
         * To replace the Java 9+ system scale factor, use system property &quot;sun.java2d.uiScale&quot;,
         * which has the same syntax as this one.
         * &lt;p&gt;
         * &lt;strong&gt;Allowed Values&lt;/strong&gt; e.g. {@code 1.5}, {@code 1.5x}, {@code 150%} or {@code 144dpi} (96dpi is 100%)&lt;br&gt;
         */
        String UI_SCALE = &quot;swingtree.uiScale&quot;;

        /**
         * Specifies whether user scaling mode is enabled.
         * &lt;p&gt;
         * &lt;strong&gt;Allowed Values&lt;/strong&gt; {@code false} and {@code true}&lt;br&gt;
         * &lt;strong&gt;Default&lt;/strong&gt; {@code true}
         */
        String UI_SCALE_ENABLED = &quot;swingtree.uiScale.enabled&quot;;

        /**
         * Specifies whether values smaller than 100% are allowed for the user scale factor
         * (see {@link UI#scale()}).
         * &lt;p&gt;
         * &lt;strong&gt;Allowed Values&lt;/strong&gt; {@code false} and {@code true}&lt;br&gt;
         * &lt;strong&gt;Default&lt;/strong&gt; {@code false}
         */
        String UI_SCALE_ALLOW_SCALE_DOWN = &quot;swingtree.uiScale.allowScaleDown&quot;;

        /**
         * Checks whether a system property is set and returns {@code true} if its value
         * is {@code &quot;true&quot;} (case-insensitive), otherwise it returns {@code false}.
         * If the system property is not set, {@code defaultValue} is returned.
         */
        static boolean getBoolean( String key, boolean defaultValue ) {
<span class="fc" id="L566">            String value = System.getProperty( key );</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">            return (value != null) ? Boolean.parseBoolean( value ) : defaultValue;</span>
        }
    }

    /**
     * Provides information about the current system.
     *
     * @author Daniel Nepp, but originally a derivative work of
     *         Karl Tauber (com.formdev.flatlaf.util.SystemInfo)
     */
<span class="nc" id="L577">    static final class SystemInfo</span>
    {
        // platforms
        public static final boolean isWindows;
        public static final boolean isMacOS;
        public static final boolean isLinux;

        // OS versions
        public static final long osVersion;
        public static final boolean isWindows_10_orLater;
        /** &lt;strong&gt;Note&lt;/strong&gt;: This requires Java 8u321, 11.0.14, 17.0.2 or 18 (or later).
         * (see https://bugs.openjdk.java.net/browse/JDK-8274840)
         **/ public static final boolean isWindows_11_orLater;
        public static final boolean isMacOS_10_11_ElCapitan_orLater;
        public static final boolean isMacOS_10_14_Mojave_orLater;
        public static final boolean isMacOS_10_15_Catalina_orLater;

        // OS architecture
        public static final boolean isX86;
        public static final boolean isX86_64;
        public static final boolean isAARCH64;

        // Java versions
        public static final long javaVersion;
        public static final boolean isJava_9_orLater;
        public static final boolean isJava_11_orLater;
        public static final boolean isJava_15_orLater;
        public static final boolean isJava_17_orLater;
        public static final boolean isJava_18_orLater;

        // Java VMs
        public static final boolean isJetBrainsJVM;
        public static final boolean isJetBrainsJVM_11_orLater;

        // UI toolkits
        public static final boolean isKDE;

        // other
        public static final boolean isProjector;
        public static final boolean isWebswing;
        public static final boolean isWinPE;

        static {
            // platforms
<span class="fc" id="L621">            String osName = System.getProperty( &quot;os.name&quot; ).toLowerCase( Locale.ENGLISH );</span>
<span class="fc" id="L622">            isWindows = osName.startsWith( &quot;windows&quot; );</span>
<span class="fc" id="L623">            isMacOS = osName.startsWith( &quot;mac&quot; );</span>
<span class="fc" id="L624">            isLinux = osName.startsWith( &quot;linux&quot; );</span>

            // OS versions
<span class="fc" id="L627">            osVersion = scanVersion( System.getProperty( &quot;os.version&quot; ) );</span>
<span class="pc bpc" id="L628" title="3 of 4 branches missed.">            isWindows_10_orLater = (isWindows &amp;&amp; osVersion &gt;= toVersion( 10, 0, 0, 0 ));</span>
<span class="pc bpc" id="L629" title="3 of 4 branches missed.">            isWindows_11_orLater = (isWindows_10_orLater &amp;&amp; osName.length() &gt; &quot;windows &quot;.length() &amp;&amp;</span>
<span class="pc bnc" id="L630" title="All 2 branches missed.">                    scanVersion( osName.substring( &quot;windows &quot;.length() ) ) &gt;= toVersion( 11, 0, 0, 0 ));</span>
<span class="pc bpc" id="L631" title="3 of 4 branches missed.">            isMacOS_10_11_ElCapitan_orLater = (isMacOS &amp;&amp; osVersion &gt;= toVersion( 10, 11, 0, 0 ));</span>
<span class="pc bpc" id="L632" title="3 of 4 branches missed.">            isMacOS_10_14_Mojave_orLater = (isMacOS &amp;&amp; osVersion &gt;= toVersion( 10, 14, 0, 0 ));</span>
<span class="pc bpc" id="L633" title="3 of 4 branches missed.">            isMacOS_10_15_Catalina_orLater = (isMacOS &amp;&amp; osVersion &gt;= toVersion( 10, 15, 0, 0 ));</span>

            // OS architecture
<span class="fc" id="L636">            String osArch = System.getProperty( &quot;os.arch&quot; );</span>
<span class="fc" id="L637">            isX86 = osArch.equals( &quot;x86&quot; );</span>
<span class="pc bpc" id="L638" title="3 of 4 branches missed.">            isX86_64 = osArch.equals( &quot;amd64&quot; ) || osArch.equals( &quot;x86_64&quot; );</span>
<span class="fc" id="L639">            isAARCH64 = osArch.equals( &quot;aarch64&quot; );</span>

            // Java versions
<span class="fc" id="L642">            javaVersion = scanVersion( System.getProperty( &quot;java.version&quot; ) );</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">            isJava_9_orLater = (javaVersion &gt;= toVersion( 9, 0, 0, 0 ));</span>
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">            isJava_11_orLater = (javaVersion &gt;= toVersion( 11, 0, 0, 0 ));</span>
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">            isJava_15_orLater = (javaVersion &gt;= toVersion( 15, 0, 0, 0 ));</span>
<span class="pc bpc" id="L646" title="1 of 2 branches missed.">            isJava_17_orLater = (javaVersion &gt;= toVersion( 17, 0, 0, 0 ));</span>
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">            isJava_18_orLater = (javaVersion &gt;= toVersion( 18, 0, 0, 0 ));</span>

            // Java VMs
<span class="fc" id="L650">            isJetBrainsJVM = System.getProperty( &quot;java.vm.vendor&quot;, &quot;Unknown&quot; )</span>
<span class="fc" id="L651">                    .toLowerCase( Locale.ENGLISH ).contains( &quot;jetbrains&quot; );</span>
<span class="pc bpc" id="L652" title="3 of 4 branches missed.">            isJetBrainsJVM_11_orLater = isJetBrainsJVM &amp;&amp; isJava_11_orLater;</span>

            // UI toolkits
<span class="pc bpc" id="L655" title="2 of 4 branches missed.">            isKDE = (isLinux &amp;&amp; System.getenv( &quot;KDE_FULL_SESSION&quot; ) != null);</span>

            // other
<span class="fc" id="L658">            isProjector = Boolean.getBoolean( &quot;org.jetbrains.projector.server.enable&quot; );</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">            isWebswing = (System.getProperty( &quot;webswing.rootDir&quot; ) != null);</span>
<span class="pc bpc" id="L660" title="3 of 4 branches missed.">            isWinPE = isWindows &amp;&amp; &quot;X:\\Windows\\System32&quot;.equalsIgnoreCase( System.getProperty( &quot;user.dir&quot; ) );</span>
<span class="fc" id="L661">        }</span>

        public static long scanVersion( String version ) {
<span class="fc" id="L664">            int major = 1;</span>
<span class="fc" id="L665">            int minor = 0;</span>
<span class="fc" id="L666">            int micro = 0;</span>
<span class="fc" id="L667">            int patch = 0;</span>
            try {
<span class="fc" id="L669">                StringTokenizer st = new StringTokenizer( version, &quot;._-+&quot; );</span>
<span class="fc" id="L670">                major = Integer.parseInt( st.nextToken() );</span>
<span class="fc" id="L671">                minor = Integer.parseInt( st.nextToken() );</span>
<span class="fc" id="L672">                micro = Integer.parseInt( st.nextToken() );</span>
<span class="fc" id="L673">                patch = Integer.parseInt( st.nextToken() );</span>
<span class="nc" id="L674">            } catch( Exception ex ) {</span>
                // ignore
<span class="fc" id="L676">            }</span>

<span class="fc" id="L678">            return toVersion( major, minor, micro, patch );</span>
        }

        public static long toVersion( int major, int minor, int micro, int patch ) {
<span class="fc" id="L682">            return ((long) major &lt;&lt; 48) + ((long) minor &lt;&lt; 32) + ((long) micro &lt;&lt; 16) + patch;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>