<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComponentExtension.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree</a> &gt; <span class="el_source">ComponentExtension.java</span></div><h1>ComponentExtension.java</h1><pre class="source lang-java linenums">package swingtree;

import net.miginfocom.swing.MigLayout;
import swingtree.style.Style;
import swingtree.style.StyleDelegate;
import swingtree.style.StyleRenderer;

import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.border.EmptyBorder;
import javax.swing.text.JTextComponent;
import java.awt.*;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.function.Consumer;
import java.util.function.Function;

/**
 *  Is attached to UI components in the form of a client property.
 *  It exists to give Swing-Tree components some custom rendering
 *  in a declarative fashion.
 */
public class ComponentExtension&lt;C extends JComponent&gt;
{
    /**
     * Returns the {@link ComponentExtension} associated with the given component.
     * If the component does not have an extension, a new one is created and associated with the component.
     */
    public static &lt;C extends JComponent&gt; ComponentExtension&lt;C&gt; from( C comp ) {
<span class="fc" id="L31">        ComponentExtension&lt;C&gt; ext = (ComponentExtension&lt;C&gt;) comp.getClientProperty( ComponentExtension.class );</span>
<span class="fc bfc" id="L32" title="All 2 branches covered.">        if ( ext == null ) {</span>
<span class="fc" id="L33">            ext = new ComponentExtension&lt;&gt;(comp);</span>
<span class="fc" id="L34">            comp.putClientProperty( ComponentExtension.class, ext );</span>
        }
<span class="fc" id="L36">        return ext;</span>
    }

<span class="fc" id="L39">    static void makeSureComponentHasExtension( JComponent comp ) { from(comp); }</span>

    private final C _owner;

<span class="fc" id="L43">    private Function&lt;StyleDelegate&lt;C&gt;, Style&gt; _styling = null;</span>

    private List&lt;Consumer&lt;Graphics2D&gt;&gt; _animationRenderers;

<span class="fc" id="L47">    private String[] _styleGroups = new String[0];</span>


<span class="fc" id="L50">    private ComponentExtension( C owner ) {</span>
<span class="fc" id="L51">        _owner = Objects.requireNonNull(owner);</span>
<span class="fc" id="L52">    }</span>

    void addStyling( Function&lt;StyleDelegate&lt;C&gt;, Style&gt; styler ) {
<span class="fc" id="L55">        Objects.requireNonNull(styler);</span>
<span class="fc" id="L56">        checkIfIsDeclaredInUI();</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if ( _styling == null )</span>
<span class="fc" id="L58">            _styling = styler;</span>
        else
<span class="fc" id="L60">            _styling = _styling.andThen(s -&gt; styler.apply(new StyleDelegate&lt;&gt;(_owner, s)));</span>

<span class="fc" id="L62">        _calculateStyle().ifPresent(this::_applyStyleToComponentState);</span>
<span class="fc" id="L63">    }</span>

    public void setStyleGroups( String... styleName ) {
<span class="fc" id="L66">        _styleGroups = Objects.requireNonNull(styleName);</span>
<span class="fc" id="L67">    }</span>

    public List&lt;String&gt; getStyleGroups() {
<span class="fc" id="L70">        return java.util.Arrays.asList(_styleGroups);</span>
    }

    public void clearAnimationRenderer() {
<span class="fc" id="L74">        _animationRenderers = null;</span>
<span class="fc" id="L75">    }</span>

    void addAnimationRenderer( Consumer&lt;Graphics2D&gt; renderer ) {
<span class="nc" id="L78">        Objects.requireNonNull(renderer);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if ( _animationRenderers == null )</span>
<span class="nc" id="L80">            _animationRenderers = new java.util.ArrayList&lt;&gt;();</span>

<span class="nc" id="L82">        _animationRenderers.add(renderer);</span>
<span class="nc" id="L83">    }</span>

    void render( Graphics g, Runnable superPaint ) {
<span class="nc" id="L86">        Objects.requireNonNull(g);</span>
<span class="nc" id="L87">        Objects.requireNonNull(superPaint);</span>

<span class="nc" id="L89">        Graphics2D g2d = (Graphics2D) g;</span>
        // We remember if antialiasing was enabled before we render:
<span class="nc bnc" id="L91" title="All 2 branches missed.">        boolean antialiasingWasEnabled = g2d.getRenderingHint( RenderingHints.KEY_ANTIALIASING ) == RenderingHints.VALUE_ANTIALIAS_ON;</span>

        // We enable antialiasing:
<span class="nc" id="L94">        g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON );</span>
        {
<span class="nc" id="L96">            _calculateStyle().ifPresent( style -&gt; {</span>
<span class="nc" id="L97">                style = _applyStyleToComponentState( style );</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if ( _componentIsDeclaredInUI(_owner) )</span>
<span class="nc" id="L99">                    new StyleRenderer&lt;&gt;( g2d, _owner ).renderStyle( style );</span>
<span class="nc" id="L100">            });</span>
        }
        // Reset antialiasing to its previous state:
<span class="nc bnc" id="L103" title="All 2 branches missed.">        g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, antialiasingWasEnabled ? RenderingHints.VALUE_ANTIALIAS_ON : RenderingHints.VALUE_ANTIALIAS_OFF );</span>

<span class="nc" id="L105">        superPaint.run();</span>

        // Enable antialiasing again:
<span class="nc" id="L108">        g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON );</span>

        // Animations are last: they are rendered on top of everything else:
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if ( _animationRenderers != null )</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            for ( Consumer&lt;Graphics2D&gt; renderer : _animationRenderers)</span>
<span class="nc" id="L113">                renderer.accept(g2d);</span>

        // Reset antialiasing to its previous state:
<span class="nc bnc" id="L116" title="All 2 branches missed.">        g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, antialiasingWasEnabled ? RenderingHints.VALUE_ANTIALIAS_ON : RenderingHints.VALUE_ANTIALIAS_OFF );</span>
<span class="nc" id="L117">    }</span>

    private Optional&lt;Style&gt; _calculateStyle() {
<span class="fc" id="L120">        Optional&lt;Style&gt; style = UI.SETTINGS()</span>
<span class="fc" id="L121">                                    .getStyleSheet()</span>
<span class="pc" id="L122">                                    .map( ss -&gt; ss.run(_owner) );</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        if ( _styling == null )</span>
<span class="nc" id="L124">            return style;</span>
        else
<span class="fc" id="L126">            return Optional.of( _styling.apply(new StyleDelegate&lt;&gt;(_owner, style.orElse(Style.blank()))) );</span>
    }

    private Style _applyStyleToComponentState( Style style )
    {
        /*
            Note that in SwingTree we do not override the UI classes of Swing to apply styles.
            Instead, we use the &quot;ComponentExtension&quot; class to render styles on components.
            This is because we don't want to means with the current LaF of the application
            and instead simply allow users to carefully replace the LaF with a custom one.
            So when the user has set a border style, we remove the border of the component!
            And if the user has set a background color, we make sure that the component
            is not opaque, so that the background color is visible.
            ... and so on.
        */
<span class="pc bpc" id="L141" title="1 of 4 branches missed.">        boolean hasBorderRadius = style.border().arcWidth() &gt; 0 || style.border().arcHeight() &gt; 0;</span>
        // If the style has a border radius set we need to make sure that we have a background color:
<span class="fc bfc" id="L143" title="All 4 branches covered.">        if ( hasBorderRadius &amp;&amp; !style.background().color().isPresent() )</span>
<span class="fc" id="L144">            style = style.backgroundColor( _owner.getBackground() );</span>

<span class="fc bfc" id="L146" title="All 4 branches covered.">        if ( style.border().width() &gt;= 0 &amp;&amp; !BorderFactory.createEmptyBorder().equals(_owner.getBorder()) )</span>
<span class="fc" id="L147">            _owner.setBorder( BorderFactory.createEmptyBorder() );</span>

<span class="fc bfc" id="L149" title="All 4 branches covered.">        if ( style.border().color().isPresent() &amp;&amp; style.border().width() &gt; 0 ) {</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            if ( !style.background().foundationColor().isPresent() )</span>
<span class="nc" id="L151">                style = style.foundationColor( _owner.getBackground() );</span>
        }

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if ( _owner.isOpaque() ) {</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            if ( style.background().color().isPresent() )</span>
<span class="fc" id="L156">                _owner.setOpaque(false);</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">            if ( style.background().foundationColor().isPresent() )</span>
<span class="fc" id="L159">                _owner.setOpaque(false);</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">            if ( style.background().renderer().isPresent() )</span>
<span class="fc" id="L162">                _owner.setOpaque(false);</span>

<span class="fc bfc" id="L164" title="All 2 branches covered.">            if ( style.shadow().color().isPresent() )</span>
<span class="fc" id="L165">                _owner.setOpaque(false);</span>
        }
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if ( _owner instanceof JTextComponent) {</span>
<span class="fc" id="L168">            JTextComponent tc = (JTextComponent) _owner;</span>
<span class="pc bpc" id="L169" title="2 of 4 branches missed.">            if ( style.font().selectionColor().isPresent() &amp;&amp; ! Objects.equals( tc.getSelectionColor(), style.font().selectionColor().get() ) )</span>
<span class="fc" id="L170">                tc.setSelectionColor(style.font().selectionColor().get());</span>
        }

<span class="fc" id="L173">        style.font()</span>
<span class="fc" id="L174">             .createDerivedFrom(_owner.getFont())</span>
<span class="fc" id="L175">             .ifPresent( newFont -&gt; {</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">                    if ( !newFont.equals(_owner.getFont()) )</span>
<span class="fc" id="L177">                        _owner.setFont( newFont );</span>
<span class="fc" id="L178">                });</span>

<span class="fc" id="L180">        _applyPadding( style );</span>

<span class="fc" id="L182">        return style;</span>
    }

    private void _applyPadding(Style style ) {
<span class="fc bfc" id="L186" title="All 2 branches covered.">        boolean hasBorder        = style.border().width() &gt; 0;</span>
<span class="fc bfc" id="L187" title="All 4 branches covered.">        boolean insTopPresent    = style.margin().top().isPresent()    || style.padding().top().isPresent();</span>
<span class="fc bfc" id="L188" title="All 4 branches covered.">        boolean insLeftPresent   = style.margin().left().isPresent()   || style.padding().left().isPresent();</span>
<span class="fc bfc" id="L189" title="All 4 branches covered.">        boolean insBottomPresent = style.margin().bottom().isPresent() || style.padding().bottom().isPresent();</span>
<span class="fc bfc" id="L190" title="All 4 branches covered.">        boolean insRightPresent  = style.margin().right().isPresent()  || style.padding().right().isPresent();</span>
<span class="fc" id="L191">        int insTop    = Math.max(style.margin().top().orElse(0),    0) + style.padding().top().orElse(0);</span>
<span class="fc" id="L192">        int insLeft   = Math.max(style.margin().left().orElse(0),   0) + style.padding().left().orElse(0);</span>
<span class="fc" id="L193">        int insBottom = Math.max(style.margin().bottom().orElse(0), 0) + style.padding().bottom().orElse(0);</span>
<span class="fc" id="L194">        int insRight  = Math.max(style.margin().right().orElse(0),  0) + style.padding().right().orElse(0);</span>
<span class="pc bpc" id="L195" title="2 of 8 branches missed.">        boolean anyPadding = insTopPresent || insLeftPresent || insBottomPresent || insRightPresent;</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if ( anyPadding ) {</span>
            // Let's adjust for border width:
<span class="fc bfc" id="L198" title="All 2 branches covered.">            if ( hasBorder ) {</span>
<span class="fc" id="L199">                int borderWidth = style.border().width();</span>
<span class="fc" id="L200">                insTop    += borderWidth;</span>
<span class="fc" id="L201">                insLeft   += borderWidth;</span>
<span class="fc" id="L202">                insBottom += borderWidth;</span>
<span class="fc" id="L203">                insRight  += borderWidth;</span>
            }
<span class="fc" id="L205">            Insets insets = Optional.ofNullable(_owner.getInsets()).orElse( new Insets(0,0,0,0) );</span>
<span class="pc bpc" id="L206" title="5 of 8 branches missed.">            boolean alreadyEqual = insets.top == insTop &amp;&amp; insets.left == insLeft &amp;&amp; insets.bottom == insBottom &amp;&amp; insets.right == insRight;</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">            if ( !alreadyEqual ) {</span>
<span class="pc bpc" id="L208" title="1 of 4 branches missed.">                if ( insTopPresent || hasBorder )</span>
<span class="fc" id="L209">                    insets.top = insTop;</span>
<span class="pc bpc" id="L210" title="3 of 4 branches missed.">                if ( insLeftPresent || hasBorder )</span>
<span class="fc" id="L211">                    insets.left = insLeft;</span>
<span class="fc bfc" id="L212" title="All 4 branches covered.">                if ( insBottomPresent || hasBorder )</span>
<span class="fc" id="L213">                    insets.bottom = insBottom;</span>
<span class="pc bpc" id="L214" title="3 of 4 branches missed.">                if ( insRightPresent || hasBorder )</span>
<span class="fc" id="L215">                    insets.right = insRight;</span>

                // We have to let the layout manager know about the new insets,
                // let's go through the various layout managers:
<span class="fc" id="L219">                LayoutManager lm = _owner.getLayout();</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">                if ( lm instanceof MigLayout ) {</span>
<span class="fc" id="L221">                    MigLayout migLayout = (MigLayout) lm;</span>
<span class="fc" id="L222">                    String lc = Optional.ofNullable(migLayout.getLayoutConstraints()).map(Object::toString).orElse(&quot;&quot;);</span>
<span class="fc" id="L223">                    Optional&lt;Insets&gt; found = _parseInsets( lc );</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">                    if ( found.isPresent() ) {</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">                        if ( found.get().equals(insets) )</span>
<span class="nc" id="L226">                            return;</span>

<span class="fc" id="L228">                        Insets old = found.get();</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">                        if ( insTop &lt; 0 )</span>
<span class="nc" id="L230">                            insets.top = old.top;</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">                        if ( insLeft &lt; 0 )</span>
<span class="nc" id="L232">                            insets.left = old.left;</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">                        if ( insBottom &lt; 0 )</span>
<span class="nc" id="L234">                            insets.bottom = old.bottom;</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">                        if ( insRight &lt; 0 )</span>
<span class="nc" id="L236">                            insets.right = old.right;</span>
                    }

<span class="fc" id="L239">                    String newConstr = &quot;insets &quot; + insets.top + &quot; &quot; + insets.left + &quot; &quot; + insets.bottom + &quot; &quot; + insets.right;</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                    if ( lc.isEmpty() )</span>
<span class="nc" id="L241">                        migLayout.setLayoutConstraints( newConstr );</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                    else if ( !lc.contains(&quot;ins&quot;) )</span>
<span class="fc" id="L243">                        migLayout.setLayoutConstraints( lc + &quot;, &quot; + newConstr );</span>
                    else {
<span class="fc" id="L245">                        lc = lc.replace(&quot;insets&quot;, &quot;ins&quot;);</span>
<span class="fc" id="L246">                        String newLayoutConstraints = lc.replaceAll(&quot;ins [0-9]+&quot;, newConstr);</span>
<span class="fc" id="L247">                        migLayout.setLayoutConstraints( newLayoutConstraints );</span>
                    }
                    // Now we need to make sure the layout manager is updated:
<span class="fc" id="L250">                    _owner.revalidate();</span>
<span class="fc" id="L251">                }</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                else if ( lm instanceof GridBagLayout ) {</span>
<span class="nc" id="L253">                    GridBagLayout gridBagLayout = (GridBagLayout) lm;</span>
<span class="nc" id="L254">                    GridBagConstraints gbc = gridBagLayout.getConstraints( _owner );</span>
                    // First let's check if the insets are already equal:
<span class="nc bnc" id="L256" title="All 2 branches missed.">                    if ( gbc.insets.equals(insets) )</span>
<span class="nc" id="L257">                        return;</span>

<span class="nc" id="L259">                    gbc.insets = insets;</span>
<span class="nc" id="L260">                    gridBagLayout.setConstraints( _owner, gbc );</span>
<span class="nc" id="L261">                    _owner.revalidate();</span>
<span class="nc" id="L262">                } else {</span>
                    /*
                        One hacky way to set the insets is to set the border!
                        But we don't want to do this if the user has set their own border.
                        So we are going to check if the current border is null or an empty border,
                        and then we are going to set the border to an empty border with the insets.
                     */
<span class="nc" id="L269">                    Border border = _owner.getBorder();</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">                    if ( border == null || border instanceof EmptyBorder ) {</span>
                        // First let's check if the insets are already equal:
<span class="nc bnc" id="L272" title="All 2 branches missed.">                        if ( border != null ) {</span>
<span class="nc" id="L273">                            EmptyBorder emptyBorder = (EmptyBorder) border;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                            if ( emptyBorder.getBorderInsets().equals(insets) )</span>
<span class="nc" id="L275">                                return;</span>
                        }
<span class="nc" id="L277">                        _owner.setBorder(</span>
<span class="nc" id="L278">                                BorderFactory.createEmptyBorder( insets.top, insets.left, insets.bottom, insets.right )</span>
                            );
<span class="nc" id="L280">                        _owner.revalidate();</span>
                    }
                }
            }
        }
<span class="fc" id="L285">    }</span>

    private Optional&lt;Insets&gt; _parseInsets( String layoutConstraints ) {
<span class="pc bpc" id="L288" title="2 of 4 branches missed.">        if ( layoutConstraints == null || layoutConstraints.isEmpty() )</span>
<span class="nc" id="L289">            return Optional.empty();</span>

        // Now we tokenize the layout constraints:
<span class="fc" id="L292">        String[] tokens = layoutConstraints.split(&quot;,&quot;);</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">        for ( String token : tokens ) {</span>
<span class="fc" id="L294">            token = token.trim();</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">            if ( token.startsWith(&quot;ins&quot;) ) {</span>
<span class="fc" id="L296">                String[] insets = token.split(&quot; &quot;);</span>
<span class="fc" id="L297">                int[] insetsInt = new int[4];</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">                for ( int i = 0; i &lt; insetsInt.length; i++ )</span>
<span class="fc" id="L299">                    insetsInt[i] = Integer.parseInt( insets[ 1 + ( i % ( insets.length - 1 ) ) ] );</span>

<span class="fc" id="L301">                return Optional.of( new Insets( insetsInt[0], insetsInt[1], insetsInt[2], insetsInt[3] ) );</span>
            }
        }
<span class="fc" id="L304">        return Optional.empty();</span>
    }

    private void checkIfIsDeclaredInUI() {
<span class="fc" id="L308">        boolean isSwingTreeComponent = _componentIsDeclaredInUI(_owner);</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">        if ( !isSwingTreeComponent ) // We throw an exception if the component is not a sub-type of any of the classes declared in UI.</span>
<span class="nc" id="L310">            throw new RuntimeException(</span>
                    &quot;Custom (declarative) rendering is only allowed/supported for Swing-Tree components declared in UI.&quot;
                );
<span class="fc" id="L313">    }</span>

    static boolean _componentIsDeclaredInUI(JComponent comp ) {
        // The component must be a subtype of one of the classes enclosed in this UI class!
        // Let's get all the classes declared in UI:
<span class="fc" id="L318">        Class&lt;?&gt;[] declaredInUI = UI.class.getDeclaredClasses();</span>
        // We want to ensure that the component is a sub-type of any of the classes declared in UI.
<span class="fc" id="L320">        Class&lt;?&gt; clazz = comp.getClass();</span>
<span class="fc" id="L321">        boolean isSwingTreeComponent = false;</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">        while ( clazz != null ) {</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">            for ( Class&lt;?&gt; c : declaredInUI )</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">                if ( c.isAssignableFrom(clazz) ) {</span>
<span class="fc" id="L325">                    isSwingTreeComponent = true;</span>
<span class="fc" id="L326">                    break;</span>
                }

<span class="fc" id="L329">            clazz = clazz.getSuperclass();</span>
        }
<span class="fc" id="L331">        return isSwingTreeComponent;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>