<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UIForTabbedPane.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree</a> &gt; <span class="el_source">UIForTabbedPane.java</span></div><h1>UIForTabbedPane.java</h1><pre class="source lang-java linenums">package swingtree;

import swingtree.api.mvvm.Action;
import swingtree.api.mvvm.Val;
import swingtree.api.mvvm.Var;

import javax.swing.*;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.lang.ref.WeakReference;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.function.Consumer;
import java.util.function.Supplier;

/**
 *  A swing tree builder node for {@link JTabbedPane} instances.
 */
public class UIForTabbedPane&lt;P extends JTabbedPane&gt; extends UIForAbstractSwing&lt;UIForTabbedPane&lt;P&gt;, P&gt;
{
<span class="fc" id="L25">    private final List&lt;Consumer&lt;Integer&gt;&gt; _selectionListeners = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L26">    private Var&lt;Integer&gt; _selectedTabIndex = null;</span>

    /**
     * {@link UIForAbstractSwing} (sub)types always wrap
     * a single component for which they are responsible.
     *
     * @param component The {@link JComponent} type which will be wrapped by this builder node.
     */
<span class="fc" id="L34">    public UIForTabbedPane( P component ) { super(component); }</span>


    public final UIForTabbedPane&lt;P&gt; withSelectedIndex( int index ) {
<span class="fc" id="L38">        getComponent().setSelectedIndex(index);</span>
<span class="fc" id="L39">        return this;</span>
    }

    public final UIForTabbedPane&lt;P&gt; withSelectedIndex( Val&lt;Integer&gt; index ) {
<span class="nc" id="L43">        NullUtil.nullArgCheck( index, &quot;index&quot;, Val.class );</span>
<span class="nc" id="L44">        NullUtil.nullPropertyCheck( index, &quot;index&quot;, &quot;Null is not a valid state for modelling a selected index.&quot; );</span>
<span class="nc" id="L45">        _onShow( index, i -&gt; getComponent().setSelectedIndex(i) );</span>
<span class="nc" id="L46">        return withSelectedIndex(index.get());</span>
    }

    public final UIForTabbedPane&lt;P&gt; withSelectedIndex( Var&lt;Integer&gt; index ) {
<span class="fc" id="L50">        NullUtil.nullArgCheck( index, &quot;index&quot;, Var.class );</span>
<span class="fc" id="L51">        NullUtil.nullPropertyCheck( index, &quot;index&quot;, &quot;Null is not a valid state for modelling a selected index.&quot; );</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">        if ( _selectedTabIndex != null )</span>
<span class="nc" id="L53">            throw new IllegalStateException(&quot;A selected index property has already been set for this tabbed pane.&quot;);</span>
<span class="fc" id="L54">        _selectedTabIndex = index;</span>
<span class="fc" id="L55">        _onShow( index, i -&gt; {</span>
<span class="fc" id="L56">            getComponent().setSelectedIndex(i);</span>
<span class="fc" id="L57">            _selectionListeners.forEach( l -&gt; l.accept(i) );</span>
<span class="fc" id="L58">        });</span>
<span class="fc" id="L59">        _onChange( e -&gt; _doApp(()-&gt;{</span>
<span class="fc" id="L60">            index.act(getComponent().getSelectedIndex());</span>
<span class="fc" id="L61">            _selectionListeners.forEach( l -&gt; l.accept(getComponent().getSelectedIndex()) );</span>
<span class="fc" id="L62">        }) );</span>
<span class="fc" id="L63">        return withSelectedIndex(index.get());</span>
    }

    public final UIForTabbedPane&lt;P&gt; with( UI.Position position ) {
<span class="fc" id="L67">        NullUtil.nullArgCheck( position, &quot;position&quot;, UI.Position.class );</span>
<span class="fc" id="L68">        getComponent().setTabPlacement(position.forTabbedPane());</span>
<span class="fc" id="L69">        return this;</span>
    }

    public final UIForTabbedPane&lt;P&gt; withPosition( Val&lt;UI.Position&gt; position ) {
<span class="nc" id="L73">        NullUtil.nullArgCheck(position, &quot;position&quot;, Var.class);</span>
<span class="nc" id="L74">        _onShow(position, v -&gt; with(position.orElseThrow()));</span>
<span class="nc" id="L75">        return with(position.get());</span>
    }

    public final UIForTabbedPane&lt;P&gt; with( UI.OverflowPolicy policy ) {
<span class="nc" id="L79">        NullUtil.nullArgCheck( policy, &quot;policy&quot;, UI.OverflowPolicy.class );</span>
<span class="nc" id="L80">        getComponent().setTabLayoutPolicy(policy.forTabbedPane());</span>
<span class="nc" id="L81">        return this;</span>
    }

    public final UIForTabbedPane&lt;P&gt; withOverflowPolicy( Val&lt;UI.OverflowPolicy&gt; policy ) {
<span class="nc" id="L85">        NullUtil.nullArgCheck(policy, &quot;policy&quot;, Var.class);</span>
<span class="nc" id="L86">        _onShow(policy, v -&gt; with(policy.orElseThrow()));</span>
<span class="nc" id="L87">        return with(policy.orElseThrow());</span>
    }

    private Supplier&lt;Integer&gt; _indexFinderFor(
        WeakReference&lt;P&gt; paneRef,
        WeakReference&lt;JComponent&gt; contentRef
    ) {
<span class="fc" id="L94">        return ()-&gt;{</span>
<span class="fc" id="L95">            P foundPane = paneRef.get();</span>
<span class="fc" id="L96">            JComponent foundContent = contentRef.get();</span>
<span class="pc bpc" id="L97" title="2 of 4 branches missed.">            if ( foundPane != null &amp;&amp; foundContent != null ) {</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">                for ( int i = 0; i &lt; foundPane.getTabCount(); i++ ) {</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                    if ( foundContent == foundPane.getComponentAt(i) ) return i;</span>
                }
            }
<span class="nc" id="L102">            return -1;</span>
        };
    }

    public final UIForTabbedPane&lt;P&gt; add( Tab tab ) {

<span class="fc" id="L108">        JComponent dummyContent = new JPanel();</span>
<span class="fc" id="L109">        WeakReference&lt;P&gt; paneRef = new WeakReference&lt;&gt;(getComponent());</span>
<span class="fc" id="L110">        WeakReference&lt;JComponent&gt; contentRef = new WeakReference&lt;&gt;(tab.contents().orElse(dummyContent));</span>
<span class="fc" id="L111">        Supplier&lt;Integer&gt; indexFinder = _indexFinderFor(paneRef, contentRef);</span>
<span class="fc" id="L112">        tab.onSelection()</span>
<span class="fc" id="L113">           .ifPresent(</span>
               onSelection -&gt;
<span class="fc" id="L115">                   getComponent().addChangeListener(e -&gt; {</span>
<span class="nc" id="L116">                       JTabbedPane tabbedPane = paneRef.get();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                       if ( tabbedPane == null ) return;</span>
<span class="nc" id="L118">                       int index = indexFinder.get();</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">                       if (index &gt;= 0 &amp;&amp; index == tabbedPane.getSelectedIndex())</span>
<span class="nc" id="L120">                           _doApp(()-&gt;onSelection.accept(new SimpleDelegate&lt;&gt;(tabbedPane, e, this::getSiblinghood)));</span>
<span class="nc" id="L121">                   })</span>
           );

<span class="fc" id="L124">        TabMouseClickListener mouseListener = new TabMouseClickListener(getComponent(), indexFinder, tab.onMouseClick().orElse(null));</span>

        // Initial tab setup:
<span class="fc" id="L127">        _doWithoutListeners(()-&gt;</span>
<span class="fc" id="L128">            getComponent().addTab(</span>
<span class="fc" id="L129">                tab.title().map(Val::orElseNull).orElse(null),</span>
<span class="fc" id="L130">                tab.icon().map(Val::orElseNull).orElse(null),</span>
<span class="fc" id="L131">                tab.contents().orElse(dummyContent),</span>
<span class="fc" id="L132">                tab.tip().map(Val::orElseNull).orElse(null)</span>
            )
        );
<span class="fc" id="L135">        tab.isEnabled().ifPresent( isEnabled -&gt; getComponent().setEnabledAt(indexFinder.get(), isEnabled.get()) );</span>
<span class="fc" id="L136">        tab.isSelected().ifPresent( isSelected -&gt; {</span>
<span class="fc" id="L137">            _selectTab( indexFinder.get(), isSelected.get() );</span>
<span class="fc" id="L138">            _selectionListeners.add( i -&gt; isSelected.act(Objects.equals(i, indexFinder.get())) );</span>
            /*
                The above listener will ensure that the isSelected property of the tab is updated when
                the selection index property changes.
             */
<span class="fc" id="L143">        });</span>

        // Now on to binding:
<span class="fc" id="L146">        tab.title()     .ifPresent( title      -&gt; _onShow(title,      t -&gt; getComponent().setTitleAt(indexFinder.get(), t)) );</span>
<span class="fc" id="L147">        tab.icon()      .ifPresent( icon       -&gt; _onShow(icon,       i -&gt; getComponent().setIconAt(indexFinder.get(), i)) );</span>
<span class="fc" id="L148">        tab.tip()       .ifPresent( tip        -&gt; _onShow(tip,        t -&gt; getComponent().setToolTipTextAt(indexFinder.get(), t)) );</span>
<span class="fc" id="L149">        tab.isEnabled() .ifPresent( enabled    -&gt; _onShow(enabled,    e -&gt; getComponent().setEnabledAt(indexFinder.get(), e)) );</span>
<span class="fc" id="L150">        tab.isSelected().ifPresent( isSelected -&gt; _onShow(isSelected, s -&gt; _selectTab(indexFinder.get(), s) ));</span>

<span class="fc" id="L152">        tab.headerContents().ifPresent( c -&gt;</span>
<span class="fc" id="L153">            getComponent()</span>
<span class="fc" id="L154">            .setTabComponentAt(</span>
<span class="fc" id="L155">                getComponent().getTabCount()-1,</span>
<span class="fc" id="L156">                _buildTabHeader( tab, mouseListener )</span>
            )
        );
<span class="fc" id="L159">        return this;</span>
    }

    private void _doWithoutListeners( Runnable r ) {
<span class="fc" id="L163">        ChangeListener[] listeners = getComponent().getChangeListeners();</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        for ( ChangeListener l : listeners ) getComponent().removeChangeListener(l);</span>
<span class="fc" id="L165">        r.run();</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">        for ( ChangeListener l : listeners ) getComponent().addChangeListener(l);</span>
        /*
            This is important because the tabbed pane will fire a change event when a tab is added.
            This is not desirable because the tabbed pane is not yet fully initialized at that point.
        */
<span class="fc" id="L171">    }</span>

    private void _selectTab( int tabIndex, boolean isSelected ) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        int selectedIndex = ( isSelected ? tabIndex : getComponent().getSelectedIndex() );</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if ( _selectedTabIndex != null )</span>
<span class="fc" id="L176">            _selectedTabIndex.act(selectedIndex);</span>
        else
<span class="nc" id="L178">            getComponent().setSelectedIndex(selectedIndex);</span>

<span class="fc" id="L180">        _selectionListeners.forEach(l -&gt; l.accept(selectedIndex));</span>
<span class="fc" id="L181">    }</span>

    private JComponent _buildTabHeader(Tab tab, TabMouseClickListener mouseListener )
    {
<span class="fc" id="L185">        return</span>
<span class="fc" id="L186">            tab.title().map( title -&gt;</span>
                // We want both title and user component in the header!
<span class="fc" id="L188">                UI.panel(&quot;fill, ins 0&quot;).withBackground(new Color(0,0,0,0))</span>
<span class="pc" id="L189">                .applyIfPresent( tab.tip().map( tip -&gt; panel -&gt; panel.withTooltip(tip) ) )</span>
<span class="fc" id="L190">                .peek( it -&gt; {</span>
<span class="fc" id="L191">                    it.addMouseListener(mouseListener);</span>
<span class="fc" id="L192">                    mouseListener.addOwner(it);</span>
<span class="fc" id="L193">                })</span>
<span class="fc" id="L194">                .add(&quot;shrink&quot;,</span>
<span class="fc" id="L195">                    UI.label(title).withBackground(new Color(0,0,0,0))</span>
<span class="pc" id="L196">                    .applyIfPresent( tab.tip().map( tip -&gt; label -&gt; label.withTooltip(tip) ) )</span>
<span class="fc" id="L197">                    .peek( it -&gt; {</span>
<span class="fc" id="L198">                        it.addMouseListener(mouseListener);</span>
<span class="fc" id="L199">                        mouseListener.addOwner(it);</span>
<span class="fc" id="L200">                    })</span>
                )
<span class="fc" id="L202">                .add(&quot;grow&quot;, tab.headerContents().orElse(new JPanel()))</span>
<span class="fc" id="L203">                .getComponent()</span>
            )
<span class="fc" id="L205">            .map( p -&gt; (JComponent) p )</span>
<span class="fc" id="L206">            .orElse(tab.headerContents().orElse(new JPanel()));</span>
    }

    private class TabMouseClickListener extends MouseAdapter
    {
<span class="fc" id="L211">        private final List&lt;WeakReference&lt;JComponent&gt;&gt; ownerRefs = new ArrayList&lt;&gt;();</span>
        private final WeakReference&lt;JTabbedPane&gt; paneRef;
        private final Supplier&lt;Integer&gt; indexFinder;
        private final Action&lt;SimpleDelegate&lt;JTabbedPane, MouseEvent&gt;&gt; mouseClickAction;


        private TabMouseClickListener(
            JTabbedPane pane,
            Supplier&lt;Integer&gt; indexFinder,
            Action&lt;SimpleDelegate&lt;JTabbedPane, MouseEvent&gt;&gt; mouseClickAction
<span class="fc" id="L221">        ) {</span>
<span class="fc" id="L222">            this.paneRef = new WeakReference&lt;&gt;(pane);</span>
<span class="fc" id="L223">            this.indexFinder = indexFinder;</span>
<span class="fc" id="L224">            this.mouseClickAction = mouseClickAction;</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">            if ( mouseClickAction != null ) {</span>
<span class="fc" id="L226">                pane.addMouseListener(new java.awt.event.MouseAdapter() {</span>
                    @Override
                    public void mouseClicked( MouseEvent e ) {
<span class="nc" id="L229">                        JTabbedPane currentPane = paneRef.get();</span>
<span class="nc" id="L230">                        int index = indexFinder.get();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                        if ( index &lt; 0 ) return;</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">                        if ( currentPane != null &amp;&amp; index == currentPane.getSelectedIndex() )</span>
<span class="nc" id="L233">                            _doApp(()-&gt; mouseClickAction.accept(new SimpleDelegate&lt;&gt;(currentPane, e, UIForTabbedPane.this::getSiblinghood)));</span>
<span class="nc" id="L234">                    }</span>
                });
            }
<span class="fc" id="L237">        }</span>

<span class="fc" id="L239">        public void addOwner(JComponent c) { this.ownerRefs.add(new WeakReference&lt;&gt;(c)); }</span>

        @Override
        public void mouseClicked( MouseEvent e ) {
<span class="nc" id="L243">            JTabbedPane pane = this.paneRef.get();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if ( pane == null ) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                for ( WeakReference&lt;JComponent&gt; compRef : this.ownerRefs) {</span>
<span class="nc" id="L246">                    JComponent owner = compRef.get();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                    if ( owner != null )</span>
<span class="nc" id="L248">                        owner.removeMouseListener(this);</span>
<span class="nc" id="L249">                }</span>
            }
<span class="nc" id="L251">            else doAction( pane, e );</span>
<span class="nc" id="L252">        }</span>

        private void doAction(JTabbedPane pane, MouseEvent e) {
<span class="nc" id="L255">            _doApp(()-&gt; {</span>
<span class="nc" id="L256">                int index = indexFinder.get();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                if ( index &lt; 0 ) return;</span>
<span class="nc bnc" id="L258" title="All 4 branches missed.">                if ( index == pane.getSelectedIndex() &amp;&amp; mouseClickAction != null )</span>
<span class="nc" id="L259">                    mouseClickAction.accept(new SimpleDelegate&lt;&gt;(pane, e, UIForTabbedPane.this::getSiblinghood));</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if ( index &lt; pane.getTabCount() )</span>
<span class="nc" id="L261">                    pane.setSelectedIndex(index);</span>
<span class="nc" id="L262">            });</span>
<span class="nc" id="L263">        }</span>
    }

    /**
     * Adds an {@link Action} to the underlying {@link JTabbedPane}
     * through an {@link javax.swing.event.ChangeListener},
     * which will be called when the state of the tabbed pane changes.
     * For more information see {@link JTabbedPane#addChangeListener(javax.swing.event.ChangeListener)}.
     *
     * @param onChange The {@link Action} that will be called through the underlying change event.
     * @return This very instance, which enables builder-style method chaining.
     */
    public final UIForTabbedPane&lt;P&gt; onChange( Action&lt;SimpleDelegate&lt;P, ChangeEvent&gt;&gt; onChange ) {
<span class="nc" id="L276">        NullUtil.nullArgCheck(onChange, &quot;onChange&quot;, Action.class);</span>
<span class="nc" id="L277">        P pane = getComponent();</span>
<span class="nc" id="L278">        _onChange(e -&gt; _doApp(()-&gt;onChange.accept(new SimpleDelegate&lt;&gt;(pane, e, this::getSiblinghood))));</span>
<span class="nc" id="L279">        return this;</span>
    }

    private void _onChange( Consumer&lt;ChangeEvent&gt; action ) {
<span class="fc" id="L283">        getComponent().addChangeListener(action::accept);</span>
<span class="fc" id="L284">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>