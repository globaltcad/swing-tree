<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CellBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree</a> &gt; <span class="el_source">CellBuilder.java</span></div><h1>CellBuilder.java</h1><pre class="source lang-java linenums">package swingtree;

import org.jspecify.annotations.Nullable;
import org.slf4j.Logger;
import swingtree.api.Configurator;

import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.event.CellEditorListener;
import javax.swing.plaf.basic.BasicComboBoxRenderer;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.text.JTextComponent;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.TreeCellEditor;
import javax.swing.tree.TreeCellRenderer;
import java.awt.*;
import java.util.List;
import java.util.*;
import java.util.function.BiConsumer;
import java.util.function.Function;
import java.util.function.Predicate;

/**
 *  A builder type for creating cell renderer for a list, combo box or table
 *  using a fluent API, typically through methods like {@link UIForList#withCells(Configurator)},
 *  {@link UIForCombo#withCells(Configurator)} or {@link UIForTable#withCells(Configurator)},
 *  where the builder is exposed to the configurator lambda. &lt;p&gt;
 *  A typical usage of this API may look something like this:
 *  &lt;pre&gt;{@code
 *      .withCells( it -&gt; it
 *          .when( Number.class )
 *          .asText( cell -&gt; cell.entryAsString()+&quot; km/h&quot; )
 *          .when( String.class )
 *          .as( cell -&gt; {
 *              // do component based rendering:
 *              return cell.view( new JLabel( cell.entryAsString() ) );
 *              // or do 2D graphics rendering directly:
 *              return cell.renderer(Size.of(200,100), g -&gt; {
 *              	// draw something
 *                  g.setColor( UI.color( cell.entryAsString() ) );
 *                  g.fillRect( 0, 0, 200, 100 );
 *              });
 *          })
 *      )
 *  }&lt;/pre&gt;
 * 	&lt;p&gt;
 * 	&lt;b&gt;Please take a look at the &lt;a href=&quot;https://globaltcad.github.io/swing-tree/&quot;&gt;living swing-tree documentation&lt;/a&gt;
 * 	where you can browse a collection of examples demonstrating how to use the API of this class.&lt;/b&gt;
 *
 * @param &lt;C&gt; The type of the component which is used to render the cell.
 * @param &lt;E&gt; The type of the value of the cell.
 */
public final class CellBuilder&lt;C extends JComponent, E&gt; {

<span class="fc" id="L58">    private static final Logger log = org.slf4j.LoggerFactory.getLogger(CellBuilder.class);</span>

    private final Class&lt;C&gt; _componentType;
    private final Class&lt;E&gt; _elementType;
<span class="fc" id="L62">    private final Map&lt;Class&lt;?&gt;, CellView&lt;C&gt;&gt; _rendererLookup = new LinkedHashMap&lt;&gt;(16);</span>

<span class="fc" id="L64">    private static class CellView&lt;C extends JComponent&gt; {</span>
<span class="fc" id="L65">        @Nullable Component _renderer = null;</span>
<span class="fc" id="L66">        @Nullable Component _editor = null;</span>
<span class="fc" id="L67">        final List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; _configurators = new ArrayList&lt;&gt;();</span>
    }

    static &lt;E&gt; CellBuilder&lt;JList&lt;E&gt;,E&gt; forList(Class&lt;E&gt; elementType) {
<span class="fc" id="L71">        return (CellBuilder) new CellBuilder&lt;&gt;(JList.class, elementType);</span>
    }
    static &lt;C extends JComboBox&lt;E&gt;, E&gt; CellBuilder&lt;C,E&gt; forCombo(Class&lt;E&gt; elementType) {
<span class="fc" id="L74">        return (CellBuilder) new CellBuilder&lt;&gt;(JComboBox.class, elementType);</span>
    }
    static &lt;E&gt; CellBuilder&lt;JTable,E&gt; forTable(Class&lt;E&gt; elementType) {
<span class="fc" id="L77">        return (CellBuilder) new CellBuilder&lt;&gt;(JTable.class, elementType);</span>
    }


<span class="fc" id="L81">    private CellBuilder(Class&lt;C&gt; componentType, Class&lt;E&gt; elementType) {</span>
<span class="fc" id="L82">        _componentType = componentType;</span>
<span class="fc" id="L83">        _elementType   = elementType;</span>
<span class="fc" id="L84">    }</span>

    private @Nullable Component findRenderer(@Nullable Object value) {
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        Class type = (value == null ? Object.class : value.getClass());</span>
<span class="fc" id="L88">        return _rendererLookup.computeIfAbsent(type, k -&gt; new CellView&lt;&gt;())._renderer;</span>
    }

    private void safeRenderer(@Nullable Object value, @Nullable Component renderer) {
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">        Class type = (value == null ? Object.class : value.getClass());</span>
<span class="pc" id="L93">        _rendererLookup.computeIfAbsent(type, k -&gt; new CellView&lt;&gt;())._renderer = renderer;</span>
<span class="fc" id="L94">    }</span>

    private @Nullable Component findEditor(@Nullable Object value) {
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        Class type = (value == null ? Object.class : value.getClass());</span>
<span class="fc" id="L98">        return _rendererLookup.computeIfAbsent(type, k -&gt; new CellView&lt;&gt;())._editor;</span>
    }

    private void safeEditor(@Nullable Object value, @Nullable Component editor) {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        Class type = (value == null ? Object.class : value.getClass());</span>
<span class="pc" id="L103">        _rendererLookup.computeIfAbsent(type, k -&gt; new CellView&lt;&gt;())._editor = editor;</span>
<span class="fc" id="L104">    }</span>

    private void _checkTypeValidity( @Nullable Object encounteredValue ) {
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if ( encounteredValue != null ) {</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if ( !_elementType.isAssignableFrom(encounteredValue.getClass()) )</span>
<span class="nc" id="L109">                log.debug(</span>
<span class="nc" id="L110">                    &quot;Encountered an unusual cell entry in component '&quot;+_componentType.getSimpleName()+&quot;'. &quot; +</span>
<span class="nc" id="L111">                    &quot;Expected type '&quot;+_elementType.getSimpleName()+&quot;', but got '&quot;+encounteredValue.getClass().getSimpleName()+&quot;'.&quot;</span>
                );

        }
<span class="fc" id="L115">    }</span>

    /**
     * Use this to specify for which type of cell value you want custom rendering next.
     * The object returned by this method allows you to specify how to render the values.
     *
     * @param valueType The type of cell value, for which you want custom rendering.
     * @param &lt;T&gt;       The type parameter of the cell value, for which you want custom rendering.
     * @return The {@link RenderAs} builder API step which expects you to provide a lambda for customizing how a cell is rendered.
     */
    public &lt;T extends E&gt; RenderAs&lt;C, E, T&gt; when( Class&lt;T&gt; valueType ) {
<span class="fc" id="L126">        NullUtil.nullArgCheck(valueType, &quot;valueType&quot;, Class.class);</span>
<span class="fc" id="L127">        return when(valueType, cell -&gt; true);</span>
    }

    /**
     * Use this to specify a specific type for which you want custom rendering
     * as well as a predicate which tests if a cell value should be rendered.
     * The object returned by this method allows you to specify how to render the values
     * using methods like {@link RenderAs#as(Configurator)} or {@link RenderAs#asText(Function)}.
     *
     * @param valueType      The type of cell value, for which you want custom rendering.
     * @param valueValidator A predicate which should return true if the cell value should be rendered.
     * @param &lt;T&gt;            The type parameter of the cell value, for which you want custom rendering.
     * @return The {@link RenderAs} builder API step which expects you to provide a lambda for customizing how a cell is rendered.
     */
    public &lt;T extends E&gt; RenderAs&lt;C, E, T&gt; when(
        Class&lt;T&gt; valueType,
        Predicate&lt;CellConf&lt;C, T&gt;&gt; valueValidator
    ) {
<span class="fc" id="L145">        NullUtil.nullArgCheck(valueType, &quot;valueType&quot;, Class.class);</span>
<span class="fc" id="L146">        NullUtil.nullArgCheck(valueValidator, &quot;valueValidator&quot;, Predicate.class);</span>
<span class="fc" id="L147">        return new RenderAs&lt;&gt;(this, valueType, valueValidator);</span>
    }

    &lt;V&gt; void _store(
        Class valueType,
        Predicate predicate,
        Configurator&lt;CellConf&lt;C, V&gt;&gt; valueInterpreter
    ) {
<span class="fc" id="L155">        NullUtil.nullArgCheck(valueType, &quot;valueType&quot;, Class.class);</span>
<span class="fc" id="L156">        NullUtil.nullArgCheck(predicate, &quot;predicate&quot;, Predicate.class);</span>
<span class="fc" id="L157">        NullUtil.nullArgCheck(valueInterpreter, &quot;valueInterpreter&quot;, Configurator.class);</span>
<span class="fc" id="L158">        List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; found = _rendererLookup.computeIfAbsent(valueType, k -&gt; new CellView&lt;&gt;())._configurators;</span>
<span class="fc" id="L159">        found.add(cell -&gt; {</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">            if (predicate.test(cell))</span>
<span class="fc" id="L161">                return valueInterpreter.configure((CellConf&lt;C, V&gt;) cell);</span>
            else
<span class="nc" id="L163">                return cell;</span>
        });
<span class="fc" id="L165">    }</span>

    public &lt;T extends JComponent&gt; Component _updateAndGetComponent(
            Function&lt;@Nullable Object, Component&gt; defaultRenderer,
            BiConsumer&lt;@Nullable Component, CellConf&lt;?,?&gt;&gt; saveComponent,
            CellConf&lt;T, Object&gt; cell
    ) {
<span class="fc" id="L172">        @Nullable Object value = cell.entry().orElse(null);</span>
<span class="fc" id="L173">        List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; interpreter = _find(value, _rendererLookup);</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if ( interpreter.isEmpty() )</span>
<span class="nc" id="L175">            return defaultRenderer.apply(value);</span>
        else {
           /*
               If a view is persisted from previous rendering, initialize with what is most
               like what the user would expect. This is however mainly to avoid
               rendering state left over from previous rendering.
            */
<span class="fc" id="L182">            cell = _initializeViewIfPresent(cell);</span>

<span class="fc bfc" id="L184" title="All 2 branches covered.">            for ( Configurator&lt;CellConf&lt;C,?&gt;&gt; configurator : interpreter ) {</span>
<span class="fc" id="L185">                CellConf newCell = cell;</span>
                try {
<span class="fc" id="L187">                    newCell = configurator.configure(newCell);</span>
<span class="nc" id="L188">                } catch (Exception e) {</span>
<span class="nc" id="L189">                    log.error(</span>
                            &quot;Failed to configure cell renderer for &quot; +
<span class="nc" id="L191">                                    &quot;component '&quot;+cell.getHost().getClass().getSimpleName()+&quot;'.&quot;,</span>
                            e
                    );
<span class="fc" id="L194">                }</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">                if ( newCell != null )</span>
<span class="fc" id="L196">                    cell = newCell;</span>
<span class="fc" id="L197">            }</span>
            Component choice;
<span class="fc" id="L199">            Optional&lt;Object&gt; presentationEntry = cell.presentationEntry();</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (cell.view().isPresent()) {</span>
<span class="fc" id="L201">                choice = cell.view().orElseThrow();</span>
<span class="fc" id="L202">                saveComponent.accept(choice, cell);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            } else if (presentationEntry.isPresent()) {</span>
<span class="nc" id="L204">                choice = defaultRenderer.apply(presentationEntry.get());</span>
<span class="nc" id="L205">                saveComponent.accept(null, cell);</span>
            } else {
<span class="nc" id="L207">                choice = defaultRenderer.apply(value);</span>
<span class="nc" id="L208">                saveComponent.accept(null, cell);</span>
            }

<span class="pc bpc" id="L211" title="3 of 4 branches missed.">            if (!cell.toolTips().isEmpty() &amp;&amp; choice instanceof JComponent)</span>
<span class="nc" id="L212">                ((JComponent) choice).setToolTipText(String.join(&quot;; &quot;, cell.toolTips()));</span>

<span class="fc" id="L214">            return choice;</span>
        }
    }

    private CellConf _initializeViewIfPresent(CellConf&lt;?, Object&gt; cell) {
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if ( cell.view().isPresent() ) {</span>
<span class="nc" id="L220">            Component view = cell.view().orElseThrow();</span>
<span class="nc" id="L221">            @Nullable Object value = cell.entry().orElse(null);</span>
<span class="nc" id="L222">            view.setEnabled(true);</span>
<span class="nc" id="L223">            view.setVisible(true);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if ( view instanceof AbstractButton ) {</span>
<span class="nc" id="L225">                AbstractButton button = (AbstractButton) view;</span>
<span class="nc" id="L226">                button.setSelected(false);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if ( value instanceof Boolean )</span>
<span class="nc" id="L228">                    button.setSelected((Boolean) value);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                else if ( value instanceof String )</span>
<span class="nc" id="L230">                    button.setText((String) value);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                else if ( value instanceof Icon )</span>
<span class="nc" id="L232">                    button.setIcon((Icon) value);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            } else if ( view instanceof JComboBox ) {</span>
<span class="nc" id="L234">                JComboBox&lt;?&gt; comboBox = (JComboBox&lt;?&gt;) view;</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if ( value != null )</span>
<span class="nc" id="L236">                    comboBox.setSelectedItem(value);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            } else if ( view instanceof JTextComponent) {</span>
<span class="nc" id="L238">                JTextComponent textField = (JTextComponent) view;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                if ( value != null )</span>
<span class="nc" id="L240">                    textField.setText(value.toString());</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            } else if ( view instanceof JLabel ) {</span>
<span class="nc" id="L242">                JLabel label = (JLabel) view;</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                if ( value != null )</span>
<span class="nc" id="L244">                    label.setText(value.toString());</span>
            }
        }
<span class="fc" id="L247">        return cell;</span>
    }

    class SimpleTableCellRenderer implements TableCellRenderer, TableCellEditor, TreeCellRenderer, TreeCellEditor
    {
<span class="fc" id="L252">        private final DefaultTableCellRenderer _defaultRenderer = new DefaultTableCellRenderer();</span>
<span class="fc" id="L253">        private final DefaultTreeCellRenderer _defaultTreeRenderer = new DefaultTreeCellRenderer();</span>
        private final InternalCellEditor _basicEditor;

<span class="fc" id="L256">        SimpleTableCellRenderer(Class&lt;? extends JComponent&gt; hostType) {</span>
<span class="fc" id="L257">            _basicEditor = new InternalCellEditor(hostType);</span>
<span class="fc" id="L258">        }</span>

        public @Nullable Component getEditorComponent() {
<span class="fc" id="L261">            return _basicEditor.getComponent();</span>
        }

        private @Nullable Component _loadEditor(@Nullable Object value) {
<span class="fc" id="L265">            @Nullable Component editor = findEditor(value);</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">            if ( editor != null )</span>
<span class="nc" id="L267">                editor = _setEditorComponent(editor);</span>
<span class="fc" id="L268">            return editor;</span>
        }

        private @Nullable Component _setEditorComponent(@Nullable Component editor) {
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">            if ( _basicEditor.getComponent() != editor ) {</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">                if (editor instanceof JCheckBox) {</span>
<span class="nc" id="L274">                    _basicEditor.setEditor((JCheckBox) editor);</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                } else if (editor instanceof JComboBox) {</span>
<span class="nc" id="L276">                    _basicEditor.setEditor((JComboBox&lt;?&gt;) editor);</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">                } else if (editor instanceof JTextField) {</span>
<span class="fc" id="L278">                    _basicEditor.setEditor((JTextField) editor);</span>
                }
            }
<span class="fc" id="L281">            return _basicEditor.getComponent();</span>
        }

        private void _setEditor(
                @Nullable Component newEdior,
                @Nullable Object entryFromModel,
                CellConf&lt;?,?&gt; currentCell
        ) {
<span class="fc" id="L289">            newEdior = _setEditorComponent(newEdior);</span>
<span class="fc" id="L290">            safeEditor(entryFromModel, newEdior);</span>
            try {
                // Apply user values to editor:
<span class="fc" id="L293">                Optional&lt;Object&gt; presentationEntry = currentCell.presentationEntry();</span>
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">                if ( presentationEntry.isPresent() )</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                    _basicEditor.setEntry(presentationEntry.orElse(null), entryFromModel, entryFromModel == null ? Object.class : entryFromModel.getClass());</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">                else if ( currentCell.view().isEmpty() )</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                    _basicEditor.setEntry(currentCell.entry().orElse(null), entryFromModel, entryFromModel == null ? Object.class : entryFromModel.getClass());</span>
<span class="nc" id="L298">            } catch (Exception e) {</span>
<span class="nc" id="L299">                log.error(&quot;Failed to populate cell editor!&quot;, e);</span>
<span class="fc" id="L300">            }</span>
<span class="fc" id="L301">        }</span>

        private void _setRenderer(
            @Nullable Component newRenderer,
            @Nullable Object entryFromModel,
            CellConf&lt;?,?&gt; currentCell
        ) {
<span class="fc" id="L308">            safeRenderer(entryFromModel, newRenderer);</span>
            try {
<span class="fc" id="L310">                Optional&lt;Object&gt; presentationEntry = currentCell.presentationEntry();</span>

<span class="pc bpc" id="L312" title="2 of 4 branches missed.">                if ( presentationEntry.isPresent() || currentCell.view().isEmpty() ) {</span>
<span class="nc" id="L313">                    @Nullable Object toBePresented = presentationEntry.orElse(currentCell.entry().orElse(null));</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                    if ( newRenderer instanceof AbstractButton ) {</span>
<span class="nc" id="L315">                        AbstractButton button = (AbstractButton) newRenderer;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                        if ( toBePresented instanceof Boolean )</span>
<span class="nc" id="L317">                            button.setSelected((Boolean) toBePresented);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                        else if ( toBePresented instanceof String )</span>
<span class="nc" id="L319">                            button.setText((String) toBePresented);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                        else if ( toBePresented instanceof Icon )</span>
<span class="nc" id="L321">                            button.setIcon((Icon) toBePresented);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                    } else if ( newRenderer instanceof JComboBox ) {</span>
<span class="nc" id="L323">                        JComboBox&lt;?&gt; comboBox = (JComboBox&lt;?&gt;) newRenderer;</span>
<span class="nc" id="L324">                        comboBox.setSelectedItem(toBePresented);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                    } else if ( newRenderer instanceof JTextComponent ) {</span>
<span class="nc" id="L326">                        JTextComponent textField = (JTextComponent) newRenderer;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                        textField.setText(toBePresented == null ? &quot;&quot; : toBePresented.toString());</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                    } else if ( newRenderer instanceof JLabel ) {</span>
<span class="nc" id="L329">                        JLabel label = (JLabel) newRenderer;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                        label.setText(toBePresented == null ? &quot;&quot; : toBePresented.toString());</span>
                    }
                }
<span class="nc" id="L333">            } catch (Exception e) {</span>
<span class="nc" id="L334">                log.error(&quot;Failed to populate cell editor!&quot;, e);</span>
<span class="fc" id="L335">            }</span>
<span class="fc" id="L336">        }</span>

        private Component _fit( JTable table, int row, int column, Component view ) {
            try {
<span class="pc bpc" id="L340" title="1 of 4 branches missed.">                boolean isDefaultEditor = _basicEditor.getComponent() == view &amp;&amp; _basicEditor.hasDefaultComponent();</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">                boolean isDefaultRenderer = view instanceof InternalLabelForRendering ||</span>
<span class="pc bpc" id="L342" title="3 of 6 branches missed.">                                            view.getClass() == DefaultListCellRenderer.class ||</span>
                                            view instanceof DefaultTableCellRenderer ||
                                            view instanceof DefaultTreeCellRenderer;

<span class="pc bpc" id="L346" title="1 of 4 branches missed.">                if ( !isDefaultRenderer &amp;&amp; !isDefaultEditor ) {</span>
                    /*
                        If you want the table to fit the cell size to the content,
                        then you have to use a custom view / editor!
                    */
<span class="fc" id="L351">                    Dimension minSize = view.getMinimumSize();</span>
<span class="fc" id="L352">                    TableColumn currentColumn = table.getColumnModel().getColumn(column);</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">                    if (currentColumn.getMinWidth() &lt; minSize.width)</span>
<span class="nc" id="L354">                        currentColumn.setMinWidth(minSize.width);</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">                    if (table.getRowHeight(row) &lt; minSize.height)</span>
<span class="fc" id="L356">                        table.setRowHeight(row, minSize.height);</span>
                }
<span class="nc" id="L358">            } catch (Exception e) {</span>
<span class="nc" id="L359">                log.error(&quot;Failed to fit cell size&quot;, e);</span>
<span class="fc" id="L360">            }</span>
<span class="fc" id="L361">            return view;</span>
        }

        @Override
        public Component getTableCellRendererComponent(
            final JTable           table,
            final @Nullable Object entryFromModel,
            final boolean          isSelected,
            final boolean          hasFocus,
            final int              row,
            final int              column
        ) {
<span class="fc" id="L373">            _checkTypeValidity(entryFromModel);</span>
<span class="fc" id="L374">            return _fit(table, row, column,</span>
<span class="fc" id="L375">                        _updateAndGetComponent(</span>
<span class="nc" id="L376">                             localEntry -&gt; _defaultRenderer.getTableCellRendererComponent(table, localEntry, isSelected, hasFocus, row, column),</span>
<span class="fc" id="L377">                             (choice, newRenderer) -&gt; _setRenderer(choice, entryFromModel, newRenderer),</span>
<span class="fc" id="L378">                             CellConf.of(</span>
<span class="fc" id="L379">                                 null, findRenderer(entryFromModel),</span>
                                 table, entryFromModel, isSelected, hasFocus, false, false, false, row, column,
<span class="nc" id="L381">                                 () -&gt; _defaultRenderer.getTableCellRendererComponent(table, entryFromModel, isSelected, hasFocus, row, column)</span>
                             )
                        )
                    );
        }

        @Override
        public Component getTableCellEditorComponent(
            final JTable           table,
            final @Nullable Object entryFromModel,
            final boolean          isSelected,
            final int              row,
            final int              column
        ) {
<span class="fc" id="L395">            _checkTypeValidity(entryFromModel);</span>
<span class="fc" id="L396">            _basicEditor.ini(table, row, column);</span>
<span class="fc" id="L397">            _basicEditor.updateForTable(table, column);</span>
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">            _basicEditor.setEntry(entryFromModel, entryFromModel, entryFromModel == null ? Object.class : entryFromModel.getClass());</span>
<span class="fc" id="L399">            return _fit(table, row, column,</span>
<span class="fc" id="L400">                        _updateAndGetComponent(</span>
<span class="nc" id="L401">                             localEntry -&gt; _basicEditor.getTableCellEditorComponent(table, localEntry, isSelected, row, column),</span>
<span class="fc" id="L402">                             (choice, newEditor) -&gt; _setEditor(choice, entryFromModel, newEditor),</span>
<span class="fc" id="L403">                             CellConf.of(</span>
<span class="fc" id="L404">                                 null, _loadEditor(entryFromModel),</span>
                                 table, entryFromModel, isSelected, true, true, false, false, row, column,
<span class="nc" id="L406">                                 () -&gt; _basicEditor.getTableCellEditorComponent(table, entryFromModel, isSelected, row, column)</span>
                             )
                        )
                    );
        }

        @Override
        public Component getTreeCellRendererComponent(
            final JTree            tree,
            final @Nullable Object entryFromModel,
            final boolean          selected,
            final boolean          expanded,
            final boolean          leaf,
            final int              row,
            final boolean          hasFocus
        ) {
<span class="nc" id="L422">            _checkTypeValidity(entryFromModel);</span>
<span class="nc" id="L423">            String entryAsString = tree.convertValueToText(entryFromModel, selected, expanded, leaf, row, false);</span>
<span class="nc" id="L424">            _basicEditor.ini(tree, row, 0);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">            _basicEditor.setEntry(entryAsString, entryFromModel, entryFromModel == null ? Object.class : entryFromModel.getClass());</span>
<span class="nc" id="L426">            return _updateAndGetComponent(</span>
<span class="nc" id="L427">                         localValue -&gt; _defaultTreeRenderer.getTreeCellRendererComponent(tree, localValue, selected, expanded, leaf, row, hasFocus),</span>
<span class="nc" id="L428">                         (choice, newRenderer) -&gt; _setRenderer(choice, entryFromModel, newRenderer),</span>
<span class="nc" id="L429">                         CellConf.of(</span>
<span class="nc" id="L430">                             null, findRenderer(entryFromModel),</span>
                             tree, entryFromModel, selected, hasFocus, false, expanded, leaf, row, 0,
<span class="nc" id="L432">                             () -&gt; _defaultTreeRenderer.getTreeCellRendererComponent(tree, entryFromModel, selected, expanded, leaf, row, hasFocus)</span>
                         )
                    );
        }

        @Override
        public Component getTreeCellEditorComponent(
            final JTree            tree,
            final @Nullable Object entryFromModel,
            final boolean          isSelected,
            final boolean          expanded,
            final boolean          leaf,
            final int              row
        ) {
<span class="nc" id="L446">            _checkTypeValidity(entryFromModel);</span>
<span class="nc" id="L447">            _basicEditor.ini(tree, row, 0);</span>
<span class="nc" id="L448">            return _updateAndGetComponent(</span>
<span class="nc" id="L449">                         localEntry -&gt; _basicEditor.getTreeCellEditorComponent(tree, localEntry, isSelected, expanded, leaf, row),</span>
<span class="nc" id="L450">                        (choice, newEditor) -&gt; _setEditor(choice, entryFromModel, newEditor),</span>
<span class="nc" id="L451">                         CellConf.of(</span>
<span class="nc" id="L452">                             null, _loadEditor(entryFromModel),</span>
                             tree, entryFromModel, isSelected,
                             true, true, expanded, leaf, row, 0,
<span class="nc" id="L455">                             () -&gt; _basicEditor.getTreeCellEditorComponent(tree, entryFromModel, isSelected, expanded, leaf, row)</span>
                         )
                    );
        }

        @Override
        public @Nullable Object getCellEditorValue() {
<span class="nc" id="L462">            return _basicEditor.getCellEditorValue();</span>
        }

        @Override
        public boolean isCellEditable(EventObject anEvent) {
<span class="fc" id="L467">            return _basicEditor.isCellEditable(anEvent);</span>
        }

        @Override
        public boolean shouldSelectCell(EventObject anEvent) {
<span class="nc" id="L472">            return _basicEditor.shouldSelectCell(anEvent);</span>
        }

        @Override
        public boolean stopCellEditing() {
<span class="nc" id="L477">            return _basicEditor.stopCellEditing();</span>
        }

        @Override
        public void cancelCellEditing() {
<span class="nc" id="L482">            _basicEditor.cancelCellEditing();</span>
<span class="nc" id="L483">        }</span>

        @Override
        public void addCellEditorListener(CellEditorListener l) {
<span class="fc" id="L487">            _basicEditor.addCellEditorListener(l);</span>
<span class="fc" id="L488">        }</span>

        @Override
        public void removeCellEditorListener(CellEditorListener l) {
<span class="nc" id="L492">            _basicEditor.removeCellEditorListener(l);</span>
<span class="nc" id="L493">        }</span>
    }

    private class SimpleListCellRenderer&lt;O extends C&gt; implements ListCellRenderer&lt;Object&gt;
    {
        private final O _component;
        private final ListCellRenderer&lt;Object&gt; _defaultRenderer;


<span class="fc" id="L502">        private SimpleListCellRenderer(O component) {</span>
<span class="fc" id="L503">            _component = Objects.requireNonNull(component);</span>
<span class="fc bfc" id="L504" title="All 2 branches covered.">            if ( component instanceof JComboBox )</span>
<span class="fc" id="L505">                _defaultRenderer = new BasicComboBoxRenderer.UIResource();</span>
            else
<span class="fc" id="L507">                _defaultRenderer = new DefaultListCellRenderer.UIResource();</span>
<span class="fc" id="L508">        }</span>

        @Override
        public Component getListCellRendererComponent(
            final JList   list,
            final Object  value,
            final int     row,
            final boolean isSelected,
            final boolean hasFocus
        ) {
<span class="fc" id="L518">            _checkTypeValidity(value);</span>
<span class="fc" id="L519">            List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; interpreter = _find(value, _rendererLookup);</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">            if (interpreter.isEmpty())</span>
<span class="nc" id="L521">                return _defaultRenderer.getListCellRendererComponent(list, value, row, isSelected, hasFocus);</span>
            else {
<span class="fc" id="L523">                CellConf&lt;O, Object&gt; cell = CellConf.of(</span>
                                                        list,
<span class="fc" id="L525">                                                        findRenderer(value),</span>
                                                        _component, value, isSelected,
                                                        hasFocus, false, false, false, row, 0,
<span class="nc" id="L528">                                                        ()-&gt;_defaultRenderer.getListCellRendererComponent(list, value, row, isSelected, hasFocus)</span>
                                                    );

<span class="fc bfc" id="L531" title="All 2 branches covered.">                for ( Configurator&lt;CellConf&lt;C,?&gt;&gt; configurator : interpreter ) {</span>
<span class="fc" id="L532">                    CellConf newCell = cell;</span>
                    try {
<span class="fc" id="L534">                        newCell = configurator.configure(newCell);</span>
<span class="nc" id="L535">                    } catch (Exception e) {</span>
<span class="nc" id="L536">                        log.error(</span>
                                &quot;Failed to configure cell renderer for &quot; +
<span class="nc" id="L538">                                &quot;component '&quot;+_component.getClass().getSimpleName()+&quot;'.&quot;,</span>
                                e
                            );
<span class="fc" id="L541">                    }</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">                    if ( newCell != null )</span>
<span class="fc" id="L543">                        cell = newCell;</span>
<span class="fc" id="L544">                }</span>
                Component choice;
<span class="fc" id="L546">                Optional&lt;Object&gt; presentationEntry = cell.presentationEntry();</span>
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">                if (cell.view().isPresent()) {</span>
<span class="fc" id="L548">                    choice = cell.view().orElseThrow();</span>
<span class="fc" id="L549">                    safeRenderer(value, choice);</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                } else if (presentationEntry.isPresent()) {</span>
<span class="nc" id="L551">                    choice = _defaultRenderer.getListCellRendererComponent(list, presentationEntry.get(), row, isSelected, hasFocus);</span>
<span class="nc" id="L552">                    safeRenderer(value, null);</span>
                } else {
<span class="nc" id="L554">                    choice = _defaultRenderer.getListCellRendererComponent(list, value, row, isSelected, hasFocus);</span>
<span class="nc" id="L555">                    safeRenderer(value, null);</span>
                }

<span class="pc bpc" id="L558" title="3 of 4 branches missed.">                if (!cell.toolTips().isEmpty() &amp;&amp; choice instanceof JComponent)</span>
<span class="nc" id="L559">                    ((JComponent) choice).setToolTipText(String.join(&quot;; &quot;, cell.toolTips()));</span>

<span class="fc" id="L561">                return choice;</span>
            }
        }

        Optional&lt;ComboBoxEditor&gt; establishEditor() {
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">            if ( !( _component instanceof JComboBox ) )</span>
<span class="nc" id="L567">                return Optional.empty();</span>
<span class="fc" id="L568">            JComboBox&lt;?&gt; comboBox = (JComboBox&lt;?&gt;) _component;</span>

<span class="fc" id="L570">            CellConf&lt;JComboBox&lt;?&gt;, Object&gt; cell = CellConf.of(</span>
<span class="nc" id="L571">                null, null, comboBox, null, false, false, true, false, false, 0, 0, () -&gt; null</span>
            );
<span class="fc" id="L573">            List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; interpreter = _findAll(_rendererLookup);</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">            if (interpreter.isEmpty())</span>
<span class="nc" id="L575">                return Optional.empty();</span>
            else {
<span class="fc bfc" id="L577" title="All 2 branches covered.">                for ( Configurator&lt;CellConf&lt;C,?&gt;&gt; configurator : interpreter ) {</span>
<span class="fc" id="L578">                    CellConf&lt;JComboBox&lt;?&gt;,Object&gt; newCell = cell;</span>
                    try {
<span class="fc" id="L580">                        newCell = configurator.configure((CellConf)newCell);</span>
<span class="fc" id="L581">                    } catch (Exception e) {</span>
<span class="fc" id="L582">                        log.error(</span>
                                &quot;Failed to establish cell editor through cell configurator &quot; +
<span class="fc" id="L584">                                &quot;for component '&quot;+_component.getClass().getSimpleName()+&quot;'.&quot;,</span>
                                e
                            );
<span class="fc" id="L587">                    }</span>
                    try {
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">                        if ( newCell != null )</span>
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">                            cell = newCell.updateView(v -&gt; v.update(c -&gt; c instanceof JTextField ? c : null ) );</span>
<span class="fc" id="L591">                    } catch (Exception e) {</span>
<span class="fc" id="L592">                        log.error(</span>
                                &quot;Failed to establish cell editor through cell configurator &quot; +
<span class="fc" id="L594">                                &quot;for component '&quot;+_component.getClass().getSimpleName()+&quot;'.&quot;,</span>
                                e
                            );
<span class="fc" id="L597">                    }</span>
<span class="fc" id="L598">                }</span>

<span class="fc bfc" id="L600" title="All 2 branches covered.">                if (!cell.view().isPresent())</span>
<span class="fc" id="L601">                    return Optional.empty();</span>

<span class="fc" id="L603">                Component choice = cell.view().orElseThrow();</span>

<span class="pc bpc" id="L605" title="1 of 2 branches missed.">                if ( !(choice instanceof JTextField) )</span>
<span class="nc" id="L606">                    return Optional.empty();</span>

<span class="fc" id="L608">                JTextField textField = (JTextField) choice;</span>

<span class="fc" id="L610">                return Optional.of(new InternalComboBoxCellEditor(textField));</span>
            }
        }
    }

    private static &lt;C extends JComponent&gt; List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; _find(
        @Nullable Object value,
        Map&lt;Class&lt;?&gt;, CellView&lt;C&gt;&gt; rendererLookup
    ) {
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">        Class&lt;?&gt; type = (value == null ? Object.class : value.getClass());</span>
<span class="fc" id="L620">        List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; cellRenderer = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">        for (Map.Entry&lt;Class&lt;?&gt;, CellView&lt;C&gt;&gt; e : rendererLookup.entrySet()) {</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">            if (e.getKey().isAssignableFrom(type))</span>
<span class="fc" id="L623">                cellRenderer.addAll(e.getValue()._configurators);</span>
<span class="fc" id="L624">        }</span>
        // We reverse the cell renderers, so that the most un-specific one is first
<span class="fc" id="L626">        Collections.reverse(cellRenderer);</span>
<span class="fc" id="L627">        return cellRenderer;</span>
    }

    private static &lt;C extends JComponent&gt; List&lt;Configurator&lt;CellConf&lt;C,?&gt;&gt;&gt; _findAll(
            Map&lt;Class&lt;?&gt;, CellView&lt;C&gt;&gt; rendererLookup
    ) {
<span class="fc" id="L633">        List&lt;Configurator&lt;CellConf&lt;C, ?&gt;&gt;&gt; cellRenderer = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">        for (CellView&lt;C&gt; e : rendererLookup.values()) {</span>
<span class="fc" id="L635">            cellRenderer.addAll(e._configurators);</span>
<span class="fc" id="L636">        }</span>
        // We reverse the cell renderers, so that the most un-specific one is first
<span class="fc" id="L638">        Collections.reverse(cellRenderer);</span>
<span class="fc" id="L639">        return cellRenderer;</span>
    }

    SimpleTableCellRenderer getForTable() {
<span class="fc" id="L643">        _addDefaultRendering();</span>
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">        if (JTable.class.isAssignableFrom(_componentType)) {</span>
<span class="fc" id="L645">            SimpleTableCellRenderer renderer = new SimpleTableCellRenderer(_componentType);</span>
<span class="fc" id="L646">            return renderer;</span>
        } else
<span class="nc" id="L648">            throw new IllegalArgumentException(&quot;Renderer was set up to be used for a JTable!&quot;);</span>
    }

    TreeCellRenderer getForTree() {
<span class="nc" id="L652">        _addDefaultRendering();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (JTree.class.isAssignableFrom(_componentType))</span>
<span class="nc" id="L654">            return new SimpleTableCellRenderer(_componentType);</span>
        else
<span class="nc" id="L656">            throw new IllegalArgumentException(&quot;Renderer was set up to be used for a JTree!&quot;);</span>
    }

    /**
     * Like many things in the SwingTree library, this class is
     * essentially a convenient builder for a {@link ListCellRenderer}.
     * This internal method actually builds the {@link ListCellRenderer} instance,
     * see {@link UIForList#withCell(swingtree.api.Configurator)} for more details
     * about how to use this class as pat of the main API.
     *
     * @param list The list for which the renderer is to be built.
     */
    void buildForList( C list ) {
<span class="fc" id="L669">        _addDefaultRendering();</span>
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">        if (JList.class.isAssignableFrom(_componentType)) {</span>
<span class="fc" id="L671">            SimpleListCellRenderer&lt;C&gt; renderer = new SimpleListCellRenderer&lt;&gt;(list);</span>
<span class="fc" id="L672">            JList&lt;E&gt; jList = (JList&lt;E&gt;) list;</span>
<span class="fc" id="L673">            jList.setCellRenderer(renderer);</span>
<span class="pc bnc" id="L674" title="All 2 branches missed.">        } else if (JComboBox.class.isAssignableFrom(_componentType))</span>
<span class="nc" id="L675">            throw new IllegalArgumentException(</span>
<span class="nc" id="L676">                    &quot;Renderer was set up to be used for a JList! (not &quot; + _componentType.getSimpleName() + &quot;)&quot;</span>
            );
        else
<span class="nc" id="L679">            throw new IllegalArgumentException(</span>
<span class="nc" id="L680">                    &quot;Renderer was set up to be used for an unknown component type! (cannot handle '&quot; + _componentType.getSimpleName() + &quot;')&quot;</span>
            );
<span class="fc" id="L682">    }</span>

    void buildForCombo(C comboBox, boolean establishEditorAlso) {
<span class="fc" id="L685">        _addDefaultRendering();</span>
<span class="pc bpc" id="L686" title="1 of 2 branches missed.">        if (JComboBox.class.isAssignableFrom(_componentType)) {</span>
<span class="fc" id="L687">            SimpleListCellRenderer&lt;C&gt; renderer = new SimpleListCellRenderer&lt;&gt;(comboBox);</span>
<span class="fc" id="L688">            JComboBox&lt;E&gt; combo = (JComboBox&lt;E&gt;) comboBox;</span>
<span class="fc" id="L689">            combo.setRenderer(renderer);</span>
<span class="pc bpc" id="L690" title="1 of 2 branches missed.">            if (establishEditorAlso) {</span>
<span class="fc" id="L691">                renderer.establishEditor().ifPresent(combo::setEditor);</span>
            }
<span class="fc" id="L693">        } else</span>
<span class="nc" id="L694">            throw new IllegalArgumentException(</span>
<span class="nc" id="L695">                    &quot;Renderer was set up to be used for a JComboBox! (not &quot; + _componentType.getSimpleName() + &quot;)&quot;</span>
            );
<span class="fc" id="L697">    }</span>

    private void _addDefaultRendering() {
        // We use the default text renderer for objects
<span class="fc" id="L701">        _store(Object.class, cell -&gt; true, _createDefaultTextRenderer(cell -&gt; cell.entryAsString()));</span>
<span class="fc" id="L702">    }</span>

    static class InternalLabelForRendering extends DefaultListCellRenderer {
<span class="fc" id="L705">        InternalLabelForRendering(String text) {</span>
<span class="fc" id="L706">            setText(text);</span>
<span class="fc" id="L707">            setOpaque(true);</span>
<span class="fc" id="L708">        }</span>
    }

    static &lt;C extends JComponent, V&gt; Configurator&lt;CellConf&lt;C, V&gt;&gt; _createDefaultTextRenderer(
            Function&lt;CellConf&lt;C, V&gt;, String&gt; renderer
    ) {
<span class="fc" id="L714">        Function&lt;CellConf&lt;C, V&gt;, String&gt; exceptionSafeRenderer = cell -&gt; {</span>
            try {
<span class="fc" id="L716">                return renderer.apply(cell);</span>
<span class="nc" id="L717">            } catch (Exception e) {</span>
<span class="nc" id="L718">                log.error(&quot;Failed to convert cell to displayable String!&quot;, e);</span>
<span class="nc" id="L719">                return &quot;&quot;;</span>
            }
        };
<span class="fc" id="L722">        return cell -&gt; {</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">            if ( cell.isEditing() )</span>
<span class="fc" id="L724">                return cell;</span>

<span class="fc" id="L726">            Component existing = cell.view().orElseNullable(null);</span>
<span class="fc bfc" id="L727" title="All 2 branches covered.">            InternalLabelForRendering l = (existing instanceof InternalLabelForRendering) ? (InternalLabelForRendering) existing : null;</span>
<span class="pc bpc" id="L728" title="1 of 4 branches missed.">            if ( existing != null &amp;&amp; l == null )</span>
<span class="nc" id="L729">                return cell; // The user has defined a custom renderer, so we don't touch it.</span>

<span class="fc bfc" id="L731" title="All 2 branches covered.">            if ( l == null )</span>
<span class="fc" id="L732">                l = new InternalLabelForRendering(exceptionSafeRenderer.apply(cell));</span>
            else
<span class="fc" id="L734">                l.setText(exceptionSafeRenderer.apply(cell));</span>

<span class="fc" id="L736">            Color bg = null;</span>
<span class="fc" id="L737">            Color fg = null;</span>

<span class="fc bfc" id="L739" title="All 4 branches covered.">            if ( cell.getHost() instanceof JComboBox &amp;&amp; cell.getListView().isPresent() ) {</span>
<span class="fc" id="L740">                JList&lt;?&gt; list = cell.getListView().get();</span>
<span class="pc bpc" id="L741" title="1 of 2 branches missed.">                if (cell.isSelected()) {</span>
<span class="nc" id="L742">                    bg = list.getSelectionBackground();</span>
<span class="nc" id="L743">                    fg = list.getSelectionForeground();</span>
                }
                else {
<span class="fc" id="L746">                    bg = list.getBackground();</span>
<span class="fc" id="L747">                    fg = list.getForeground();</span>
                }
<span class="pc bpc" id="L749" title="1 of 2 branches missed.">            } else if ( cell.getHost() instanceof JList ) {</span>
<span class="nc" id="L750">                JList&lt;?&gt; jList = (JList&lt;?&gt;) cell.getHost();</span>
<span class="nc" id="L751">                bg = jList.getSelectionBackground();</span>
<span class="nc" id="L752">                fg = jList.getSelectionForeground();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">                if ( bg == null )</span>
<span class="nc" id="L754">                    bg = UIManager.getColor(&quot;List.selectionBackground&quot;);</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">                if ( fg == null )</span>
<span class="nc" id="L756">                    fg = UIManager.getColor(&quot;List.selectionForeground&quot;);</span>
<span class="pc bfc" id="L757" title="All 2 branches covered.">            } else if ( cell.getHost() instanceof JTable ) {</span>
<span class="fc" id="L758">                JTable jTable = (JTable) cell.getHost();</span>
<span class="fc" id="L759">                bg = jTable.getSelectionBackground();</span>
<span class="fc" id="L760">                fg = jTable.getSelectionForeground();</span>
<span class="pc bpc" id="L761" title="1 of 2 branches missed.">                if ( bg == null )</span>
<span class="nc" id="L762">                    bg = UIManager.getColor(&quot;Table.selectionBackground&quot;);</span>
<span class="pc bpc" id="L763" title="1 of 2 branches missed.">                if ( fg == null )</span>
<span class="nc" id="L764">                    fg = UIManager.getColor(&quot;Table.selectionForeground&quot;);</span>
            }

<span class="fc bfc" id="L767" title="All 2 branches covered.">            if ( bg == null )</span>
<span class="fc" id="L768">                bg = cell.getHost().getBackground();</span>
<span class="fc bfc" id="L769" title="All 2 branches covered.">            if ( fg == null )</span>
<span class="fc" id="L770">                fg = cell.getHost().getForeground();</span>

<span class="pc bpc" id="L772" title="1 of 2 branches missed.">            if ( bg == null )</span>
<span class="nc" id="L773">                bg = UIManager.getColor( &quot;ComboBox.selectionBackground&quot; );</span>
<span class="pc bpc" id="L774" title="1 of 2 branches missed.">            if ( fg == null )</span>
<span class="nc" id="L775">                fg = UIManager.getColor( &quot;ComboBox.selectionForeground&quot; );</span>

<span class="pc bpc" id="L777" title="1 of 2 branches missed.">            if ( bg == null )</span>
<span class="nc" id="L778">                bg = UIManager.getColor( &quot;List.dropCellBackground&quot; );</span>
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">            if ( fg == null )</span>
<span class="nc" id="L780">                fg = UIManager.getColor( &quot;List.dropCellForeground&quot; );</span>

<span class="pc bpc" id="L782" title="1 of 2 branches missed.">            if ( bg == null )</span>
<span class="nc" id="L783">                bg = UIManager.getColor( &quot;ComboBox.background&quot; );</span>
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">            if ( fg == null )</span>
<span class="nc" id="L785">                fg = UIManager.getColor( &quot;ComboBox.foreground&quot; );</span>

            // Lastly we make sure the color is a user color, not a LaF color:
<span class="pc bpc" id="L788" title="1 of 2 branches missed.">            if ( bg != null ) // This is because of a weired JDK bug it seems!</span>
<span class="fc" id="L789">                bg = new Color( bg.getRGB() );</span>
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">            if ( fg != null )</span>
<span class="fc" id="L791">                fg = new Color( fg.getRGB() );</span>

<span class="pc bpc" id="L793" title="1 of 2 branches missed.">            if (cell.isSelected()) {</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                if ( bg != null ) _setBackgroundColor(l, bg);</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">                if ( fg != null ) _setForegroundColor(l, fg);</span>
            }
            else {
<span class="fc" id="L798">                Color normalBg = cell.getHost().getBackground();</span>

                // We need to make sure the color is a user color, not a LaF color:
<span class="pc bpc" id="L801" title="1 of 2 branches missed.">                if ( normalBg != null )</span>
<span class="fc" id="L802">                    normalBg = new Color( normalBg.getRGB() ); // This is because of a weired JDK bug it seems!</span>

<span class="fc bfc" id="L804" title="All 2 branches covered.">                if ( cell.row() % 2 == 1 ) {</span>
                    // We determine if the base color is more bright or dark,
                    // and then we set the foreground color accordingly
<span class="fc" id="L807">                    double brightness = (0.299 * normalBg.getRed() + 0.587 * normalBg.getGreen() + 0.114 * normalBg.getBlue()) / 255;</span>
<span class="pc bpc" id="L808" title="1 of 2 branches missed.">                    if ( brightness &lt; 0.5 )</span>
<span class="nc" id="L809">                        normalBg = brighter(normalBg);</span>
                    else
<span class="fc" id="L811">                        normalBg = darker(normalBg);</span>
                }
<span class="pc bpc" id="L813" title="1 of 2 branches missed.">                if ( bg != null )</span>
<span class="fc" id="L814">                    _setBackgroundColor( l, normalBg );</span>
<span class="pc bpc" id="L815" title="1 of 2 branches missed.">                if ( fg != null )</span>
<span class="fc" id="L816">                    _setForegroundColor( l, cell.getHost().getForeground() );</span>
            }

            // TODO:
            //l.setFont(cell.getHost().getFont()); // Is this a good idea?
<span class="pc bpc" id="L821" title="1 of 2 branches missed.">            if ( l.isEnabled() != cell.getHost().isEnabled() )</span>
<span class="nc" id="L822">                l.setEnabled(cell.getHost().isEnabled());</span>

<span class="fc" id="L824">            Border border = null;</span>
<span class="pc bpc" id="L825" title="1 of 2 branches missed.">            if ( cell.hasFocus() ) {</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">                if ( cell.isSelected() )</span>
<span class="nc" id="L827">                    border = UIManager.getBorder( &quot;List.focusSelectedCellHighlightBorder&quot; );</span>

<span class="nc bnc" id="L829" title="All 2 branches missed.">                if ( border == null )</span>
<span class="nc" id="L830">                    border = UIManager.getBorder( &quot;List.focusCellHighlightBorder&quot; );</span>
            }
            else
<span class="fc" id="L833">                border = UIManager.getBorder( &quot;List.cellNoFocusBorder&quot; );</span>

<span class="pc bpc" id="L835" title="3 of 4 branches missed.">            if ( border != null &amp;&amp; border != l.getBorder() )</span>
<span class="nc" id="L836">                l.setBorder(border);</span>

<span class="fc" id="L838">            return cell.view(l);</span>
        };
    }

    private static void _setBackgroundColor( JComponent comp, @Nullable Color color ) {
<span class="pc bpc" id="L843" title="1 of 2 branches missed.">        if ( color == null ) {</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">            if ( comp.isBackgroundSet() )</span>
<span class="nc" id="L845">                comp.setBackground(null);</span>
            else
<span class="nc" id="L847">                return; // Already null!</span>
        }
        else
<span class="fc bfc" id="L850" title="All 2 branches covered.">            if ( !Objects.equals(comp.getBackground(), color) )</span>
<span class="fc" id="L851">                comp.setBackground( color );</span>
<span class="fc" id="L852">    }</span>

    private static void _setForegroundColor( JComponent comp, @Nullable Color color ) {
<span class="pc bpc" id="L855" title="1 of 2 branches missed.">        if ( color == null ) {</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">            if ( comp.isForegroundSet() )</span>
<span class="nc" id="L857">                comp.setForeground(null);</span>
            else
<span class="nc" id="L859">                return; // Already null!</span>
        }
        else
<span class="pc bpc" id="L862" title="1 of 2 branches missed.">            if ( !Objects.equals(comp.getForeground(), color) )</span>
<span class="nc" id="L863">                comp.setForeground( color );</span>
<span class="fc" id="L864">    }</span>


    private static Color darker( Color c ) {
<span class="fc" id="L868">        final double PERCENTAGE = (242*3.0)/(255*3.0);</span>
<span class="fc" id="L869">        return new Color(</span>
<span class="fc" id="L870">                (int)(c.getRed()*PERCENTAGE),</span>
<span class="fc" id="L871">                (int)(c.getGreen()*PERCENTAGE),</span>
<span class="fc" id="L872">                (int)(c.getBlue()*PERCENTAGE)</span>
        );
    }

    private static Color brighter( Color c ) {
<span class="nc" id="L877">        final double FACTOR = (242*3.0)/(255*3.0);</span>
<span class="nc" id="L878">        int r = c.getRed();</span>
<span class="nc" id="L879">        int g = c.getGreen();</span>
<span class="nc" id="L880">        int b = c.getBlue();</span>
<span class="nc" id="L881">        int alpha = c.getAlpha();</span>

<span class="nc" id="L883">        int i = (int)(1.0/(1.0-FACTOR));</span>
<span class="nc bnc" id="L884" title="All 6 branches missed.">        if ( r == 0 &amp;&amp; g == 0 &amp;&amp; b == 0) {</span>
<span class="nc" id="L885">            return new Color(i, i, i, alpha);</span>
        }
<span class="nc bnc" id="L887" title="All 4 branches missed.">        if ( r &gt; 0 &amp;&amp; r &lt; i ) r = i;</span>
<span class="nc bnc" id="L888" title="All 4 branches missed.">        if ( g &gt; 0 &amp;&amp; g &lt; i ) g = i;</span>
<span class="nc bnc" id="L889" title="All 4 branches missed.">        if ( b &gt; 0 &amp;&amp; b &lt; i ) b = i;</span>

<span class="nc" id="L891">        return new Color(Math.min((int)(r/FACTOR), 255),</span>
<span class="nc" id="L892">                Math.min((int)(g/FACTOR), 255),</span>
<span class="nc" id="L893">                Math.min((int)(b/FACTOR), 255),</span>
                alpha);
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>