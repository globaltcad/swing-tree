<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComponentExtension.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree.style</a> &gt; <span class="el_source">ComponentExtension.java</span></div><h1>ComponentExtension.java</h1><pre class="source lang-java linenums">package swingtree.style;

import swingtree.UI;
import swingtree.animation.AnimationState;
import swingtree.api.Painter;
import swingtree.api.Styler;

import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.text.JTextComponent;
import java.awt.*;
import java.util.List;
import java.util.*;

/**
 *  Is attached to UI components in the form of a client property.
 *  It exists to give Swing-Tree components some custom style and animation capabilities.
 */
public final class ComponentExtension&lt;C extends JComponent&gt;
{
    /**
     * Returns the {@link ComponentExtension} associated with the given component.
     * If the component does not have an extension, a new one is created and associated with the component.
     */
    public static &lt;C extends JComponent&gt; ComponentExtension&lt;C&gt; from( C comp ) {
<span class="fc" id="L26">        ComponentExtension&lt;C&gt; ext = (ComponentExtension&lt;C&gt;) comp.getClientProperty( ComponentExtension.class );</span>
<span class="fc bfc" id="L27" title="All 2 branches covered.">        if ( ext == null ) {</span>
<span class="fc" id="L28">            ext = new ComponentExtension&lt;&gt;(comp);</span>
<span class="fc" id="L29">            comp.putClientProperty( ComponentExtension.class, ext );</span>
        }
<span class="fc" id="L31">        return ext;</span>
    }

<span class="fc" id="L34">    public static void makeSureComponentHasExtension( JComponent comp ) { from(comp); }</span>

    private final C _owner;

<span class="fc" id="L38">    private final List&lt;Expirable&lt;Painter&gt;&gt; _animationPainters = new ArrayList&lt;&gt;(0);</span>

<span class="fc" id="L40">    private final List&lt;String&gt; _styleGroups = new ArrayList&lt;&gt;(0);</span>

<span class="fc" id="L42">    private StylePainter&lt;C&gt; _currentStylePainter = StylePainter.none();</span>

<span class="fc" id="L44">    private DynamicLaF _laf = DynamicLaF.none();</span>

<span class="fc" id="L46">    private StyleSource&lt;C&gt; _styleSource = StyleSource.create();</span>

<span class="fc" id="L48">    private Color _initialBackgroundColor = null;</span>

<span class="fc" id="L50">    private Shape _mainClip = null;</span>


<span class="fc" id="L53">    private ComponentExtension( C owner ) {</span>
<span class="fc" id="L54">        _owner = Objects.requireNonNull(owner);</span>
<span class="fc" id="L55">    }</span>

<span class="fc" id="L57">    C getOwner() { return _owner; }</span>

<span class="fc" id="L59">    StylePainter&lt;C&gt; getCurrentStylePainter() { return _currentStylePainter; }</span>

<span class="fc" id="L61">    Shape getMainClip() { return _mainClip; }</span>

    public void addStyling( Styler&lt;C&gt; styler ) {
<span class="fc" id="L64">        Objects.requireNonNull(styler);</span>
<span class="fc" id="L65">        _styleSource = _styleSource.withLocalStyler(styler, _owner);</span>
<span class="fc" id="L66">        establishStyle();</span>
<span class="fc" id="L67">    }</span>

    public void establishStyle() {
<span class="fc" id="L70">        _currentStylePainter = _currentStylePainter.update(_calculateAndApplyStyle());</span>
<span class="fc" id="L71">    }</span>

    void _establishCurrentMainPaintClip(Graphics g) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if ( _mainClip == null )</span>
<span class="fc" id="L75">            _mainClip = g.getClip();</span>
<span class="fc" id="L76">    }</span>

    public void setStyleGroups( String... styleName ) {
<span class="fc" id="L79">        Objects.requireNonNull(styleName);</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if ( !_styleGroups.isEmpty() )</span>
<span class="nc" id="L81">            throw new IllegalStateException(&quot;Style groups already specified!&quot;);</span>

<span class="fc" id="L83">        _styleGroups.addAll( java.util.Arrays.asList(styleName) );</span>
<span class="fc" id="L84">    }</span>

<span class="fc" id="L86">    public List&lt;String&gt; getStyleGroups() { return Collections.unmodifiableList(_styleGroups); }</span>

    public void clearAnimationRenderer() {
<span class="fc" id="L89">        _animationPainters.clear();</span>
<span class="fc" id="L90">        _styleSource = _styleSource.withoutAnimationStylers();</span>
<span class="fc" id="L91">    }</span>

    public void addAnimationPainter( AnimationState state, swingtree.api.Painter painter ) {
<span class="nc" id="L94">        _animationPainters.add(new Expirable&lt;&gt;(Objects.requireNonNull(state.lifetime()), Objects.requireNonNull(painter)));</span>
<span class="nc" id="L95">        _installCustomBorderBasedStyleAndAnimationRenderer();</span>
<span class="nc" id="L96">    }</span>

    public void addAnimationStyler( AnimationState state, Styler&lt;C&gt; styler ) {
<span class="fc" id="L99">        _styleSource = _styleSource.withAnimationStyler(state.lifetime(), styler);</span>
<span class="fc" id="L100">        _installCustomBorderBasedStyleAndAnimationRenderer();</span>
<span class="fc" id="L101">    }</span>

<span class="fc" id="L103">    public void updateUI() { _laf.updateUIFor(_owner); }</span>

    StylePainter&lt;C&gt; _establishStyleAndBeginPainting() {
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if ( !_currentStylePainter.isPainting() )</span>
<span class="fc" id="L107">            _currentStylePainter = _currentStylePainter.beginPaintingWith( _calculateAndApplyStyle() );</span>

<span class="fc" id="L109">        return _currentStylePainter;</span>
    }

    public void paintBackgroundStyle( Graphics g )
    {
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if ( _laf.customLookAndFeelIsInstalled() )</span>
<span class="fc" id="L115">            return; // We render through the custom installed UI!</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if ( _componentIsDeclaredInUI(_owner) )</span>
<span class="fc" id="L118">            _paintBackground(g);</span>
        else
<span class="nc" id="L120">            _currentStylePainter = _currentStylePainter.endPainting(); // custom style rendering unfortunately not possible for this component :/</span>
<span class="fc" id="L121">    }</span>

    void _paintBackground(Graphics g)
    {
<span class="fc" id="L125">        _mainClip = null;</span>
<span class="fc" id="L126">        _establishCurrentMainPaintClip(g);</span>

<span class="fc" id="L128">        _currentStylePainter = _currentStylePainter.beginPaintingWith( _calculateAndApplyStyle() );</span>
<span class="fc" id="L129">        _currentStylePainter.renderBackgroundStyle( (Graphics2D) g, _owner );</span>
<span class="fc" id="L130">    }</span>


    public void _renderAnimations( Graphics2D g2d )
    {
        // We remember if antialiasing was enabled before we render:
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        boolean antialiasingWasEnabled = g2d.getRenderingHint( RenderingHints.KEY_ANTIALIASING ) == RenderingHints.VALUE_ANTIALIAS_ON;</span>

        // We enable antialiasing:
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if ( StylePainter.DO_ANTIALIASING() )</span>
<span class="fc" id="L140">            g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON );</span>

        // Animations are last: they are rendered on top of everything else:
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        for ( Expirable&lt;Painter&gt; expirablePainter : _animationPainters )</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if ( expirablePainter.isExpired() )</span>
<span class="nc" id="L145">                _animationPainters.remove(expirablePainter);</span>
            else {
                try {
<span class="nc" id="L148">                    expirablePainter.get().paint(g2d);</span>
<span class="nc" id="L149">                } catch ( Exception e ) {</span>
<span class="nc" id="L150">                    e.printStackTrace();</span>
                    // An exception inside a painter should not prevent everything else from being painted!
<span class="nc" id="L152">                }</span>
            }

        // Reset antialiasing to its previous state:
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, antialiasingWasEnabled ? RenderingHints.VALUE_ANTIALIAS_ON : RenderingHints.VALUE_ANTIALIAS_OFF );</span>
<span class="fc" id="L157">    }</span>

    public void paintForegroundStyle( Graphics2D g2d ) {
        // We remember if antialiasing was enabled before we render:
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        boolean antialiasingWasEnabled = g2d.getRenderingHint( RenderingHints.KEY_ANTIALIASING ) == RenderingHints.VALUE_ANTIALIAS_ON;</span>
        // Reset antialiasing to its previous state:
<span class="fc bfc" id="L163" title="All 2 branches covered.">        if ( StylePainter.DO_ANTIALIASING() )</span>
<span class="fc" id="L164">            g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON );</span>

        // We remember the clip:
<span class="fc" id="L167">        Shape formerClip = g2d.getClip();</span>

<span class="fc" id="L169">        _currentStylePainter.paintForegroundStyle(g2d, _owner);</span>

        // We restore the clip:
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if ( g2d.getClip() != formerClip )</span>
<span class="fc" id="L173">            g2d.setClip(formerClip);</span>

        // Reset antialiasing to its previous state:
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        g2d.setRenderingHint( RenderingHints.KEY_ANTIALIASING, antialiasingWasEnabled ? RenderingHints.VALUE_ANTIALIAS_ON : RenderingHints.VALUE_ANTIALIAS_OFF );</span>
<span class="fc" id="L177">    }</span>

    private Style _calculateAndApplyStyle() {
<span class="fc" id="L180">        Style style = _styleSource.calculateStyleFor(_owner);</span>
<span class="fc" id="L181">        _styleSource = _styleSource.withoutExpiredAnimationStylers(); // Clean up expired animation stylers!</span>
<span class="fc" id="L182">        return _applyStyleToComponentState(style);</span>
    }

    private Style _applyStyleToComponentState( Style style )
    {
<span class="fc" id="L187">        Objects.requireNonNull(style);</span>

<span class="fc bfc" id="L189" title="All 2 branches covered.">        if ( _currentStylePainter.getStyle().equals(style) )</span>
<span class="fc" id="L190">            return style;</span>

<span class="fc" id="L192">        final Style.Report styleReport = style.getReport();</span>

<span class="fc" id="L194">        boolean isNotStyled                     = styleReport.isNotStyled();</span>
<span class="fc" id="L195">        boolean onlyDimensionalityIsStyled      = styleReport.onlyDimensionalityIsStyled();</span>
<span class="fc" id="L196">        boolean styleCanBeRenderedThroughBorder = StyleAndAnimationBorder.canFullyPaint(styleReport);</span>

<span class="fc bfc" id="L198" title="All 4 branches covered.">        if ( _owner instanceof JTextField &amp;&amp; style.margin().isPositive() )</span>
<span class="fc" id="L199">            styleCanBeRenderedThroughBorder = false;</span>

<span class="fc bfc" id="L201" title="All 4 branches covered.">        if ( isNotStyled || onlyDimensionalityIsStyled ) {</span>
<span class="fc" id="L202">            _laf = _laf._uninstallCustomLaF(_owner);</span>
<span class="pc bpc" id="L203" title="2 of 4 branches missed.">            if ( _styleSource.hasNoAnimationStylers() &amp;&amp; _animationPainters.isEmpty() )</span>
<span class="fc" id="L204">                _uninstallCustomBorderBasedStyleAndAnimationRenderer();</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">            if ( _initialBackgroundColor != null ) {</span>
<span class="fc" id="L206">                _owner.setBackground(_initialBackgroundColor);</span>
<span class="fc" id="L207">                _initialBackgroundColor = null;</span>
            }
<span class="fc bfc" id="L209" title="All 2 branches covered.">            if ( isNotStyled )</span>
<span class="fc" id="L210">                return style;</span>
        }

<span class="fc" id="L213">        boolean hasBorderRadius = style.border().hasAnyNonZeroArcs();</span>
<span class="fc" id="L214">        boolean hasBackground   = style.base().backgroundColor().isPresent();</span>

<span class="fc bfc" id="L216" title="All 4 branches covered.">        if ( hasBackground &amp;&amp; !Objects.equals( _owner.getBackground(), style.base().backgroundColor().get() ) ) {</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            _initialBackgroundColor = _initialBackgroundColor != null ? _initialBackgroundColor :  _owner.getBackground();</span>
<span class="fc" id="L218">            _owner.setBackground( style.base().backgroundColor().get() );</span>
        }

        // If the style has a border radius set we need to make sure that we have a background color:
<span class="fc bfc" id="L222" title="All 4 branches covered.">        if ( hasBorderRadius &amp;&amp; !hasBackground ) {</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">            _initialBackgroundColor = _initialBackgroundColor != null ? _initialBackgroundColor :  _owner.getBackground();</span>
<span class="fc" id="L224">            style = style.backgroundColor(_initialBackgroundColor);</span>
        }

<span class="fc bfc" id="L227" title="All 4 branches covered.">        if ( style.base().foregroundColo().isPresent() &amp;&amp; !Objects.equals( _owner.getForeground(), style.base().foregroundColo().get() ) )</span>
<span class="fc" id="L228">            _owner.setForeground( style.base().foregroundColo().get() );</span>

<span class="fc" id="L230">        style.base().cursor().ifPresent( cursor -&gt; {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if ( !Objects.equals( _owner.getCursor(), cursor ) )</span>
<span class="fc" id="L232">                _owner.setCursor( cursor );</span>
<span class="fc" id="L233">        });</span>

<span class="fc bfc" id="L235" title="All 4 branches covered.">        if ( style.dimensionality().minWidth().isPresent() || style.dimensionality().minHeight().isPresent() ) {</span>
<span class="fc" id="L236">            Dimension minSize = _owner.getMinimumSize();</span>

<span class="pc bpc" id="L238" title="1 of 2 branches missed.">            int minWidth  = style.dimensionality().minWidth().orElse(minSize == null ? 0 : minSize.width);</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">            int minHeight = style.dimensionality().minHeight().orElse(minSize == null ? 0 : minSize.height);</span>

<span class="fc" id="L241">            Dimension newMinSize = new Dimension(minWidth, minHeight);</span>

<span class="pc bpc" id="L243" title="1 of 2 branches missed.">            if ( ! newMinSize.equals(minSize) )</span>
<span class="fc" id="L244">                _owner.setMinimumSize(newMinSize);</span>
        }

<span class="fc bfc" id="L247" title="All 4 branches covered.">        if ( style.dimensionality().maxWidth().isPresent() || style.dimensionality().maxHeight().isPresent() ) {</span>
<span class="fc" id="L248">            Dimension maxSize = _owner.getMaximumSize();</span>

<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            int maxWidth  = style.dimensionality().maxWidth().orElse(maxSize == null  ? Integer.MAX_VALUE : maxSize.width);</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">            int maxHeight = style.dimensionality().maxHeight().orElse(maxSize == null ? Integer.MAX_VALUE : maxSize.height);</span>

<span class="fc" id="L253">            Dimension newMaxSize = new Dimension(maxWidth, maxHeight);</span>

<span class="pc bpc" id="L255" title="1 of 2 branches missed.">            if ( ! newMaxSize.equals(maxSize) )</span>
<span class="fc" id="L256">                _owner.setMaximumSize(newMaxSize);</span>
        }

<span class="fc bfc" id="L259" title="All 4 branches covered.">        if ( style.dimensionality().preferredWidth().isPresent() || style.dimensionality().preferredHeight().isPresent() ) {</span>
<span class="fc" id="L260">            Dimension prefSize = _owner.getPreferredSize();</span>

<span class="pc bpc" id="L262" title="1 of 2 branches missed.">            int prefWidth  = style.dimensionality().preferredWidth().orElse(prefSize == null ? 0 : prefSize.width);</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">            int prefHeight = style.dimensionality().preferredHeight().orElse(prefSize == null ? 0 : prefSize.height);</span>

<span class="fc" id="L265">            Dimension newPrefSize = new Dimension(prefWidth, prefHeight);</span>

<span class="pc bpc" id="L267" title="1 of 2 branches missed.">            if ( !newPrefSize.equals(prefSize) )</span>
<span class="fc" id="L268">                _owner.setPreferredSize(newPrefSize);</span>
        }

<span class="fc bfc" id="L271" title="All 4 branches covered.">        if ( style.dimensionality().width().isPresent() || style.dimensionality().height().isPresent() ) {</span>
<span class="fc" id="L272">            Dimension size = _owner.getSize();</span>

<span class="pc bpc" id="L274" title="1 of 2 branches missed.">            int width  = style.dimensionality().width().orElse(size == null ? 0 : size.width);</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">            int height = style.dimensionality().height().orElse(size == null ? 0 : size.height);</span>

<span class="fc" id="L277">            Dimension newSize = new Dimension(width, height);</span>

<span class="fc bfc" id="L279" title="All 2 branches covered.">            if ( ! newSize.equals(size) )</span>
<span class="fc" id="L280">                _owner.setSize(newSize);</span>
        }

<span class="fc bfc" id="L283" title="All 2 branches covered.">        if ( _owner instanceof JTextComponent ) {</span>
<span class="fc" id="L284">            JTextComponent tc = (JTextComponent) _owner;</span>
<span class="fc bfc" id="L285" title="All 4 branches covered.">            if ( style.font().selectionColor().isPresent() &amp;&amp; ! Objects.equals( tc.getSelectionColor(), style.font().selectionColor().get() ) )</span>
<span class="fc" id="L286">                tc.setSelectionColor(style.font().selectionColor().get());</span>
        }

<span class="fc bfc" id="L289" title="All 2 branches covered.">        if ( _owner instanceof JComboBox ) {</span>
<span class="fc" id="L290">            int bottom = style.margin().bottom().orElse(0);</span>
            // We adjust the position of the popup menu:
            try {
<span class="nc" id="L293">                Point location = _owner.getLocationOnScreen();</span>
<span class="nc" id="L294">                int x = location.x;</span>
<span class="nc" id="L295">                int y = location.y + _owner.getHeight() - bottom;</span>
<span class="nc" id="L296">                JComboBox&lt;?&gt; comboBox = (JComboBox&lt;?&gt;) _owner;</span>
<span class="nc" id="L297">                JPopupMenu popup = (JPopupMenu) comboBox.getAccessibleContext().getAccessibleChild(0);</span>
<span class="nc" id="L298">                Point oldLocation = popup.getLocation();</span>
<span class="nc bnc" id="L299" title="All 6 branches missed.">                if ( popup.isShowing() &amp;&amp; (oldLocation.x != x || oldLocation.y != y) )</span>
<span class="nc" id="L300">                    popup.setLocation(x, y);</span>
<span class="fc" id="L301">            } catch ( Exception e ) {</span>
                // ignore
<span class="nc" id="L303">            }</span>
        }

<span class="fc" id="L306">        style.font()</span>
<span class="fc" id="L307">             .createDerivedFrom(_owner.getFont())</span>
<span class="fc" id="L308">             .ifPresent( newFont -&gt; {</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">                    if ( !newFont.equals(_owner.getFont()) )</span>
<span class="fc" id="L310">                        _owner.setFont( newFont );</span>
<span class="fc" id="L311">                });</span>

<span class="fc" id="L313">        style.font().horizontalAlignment().ifPresent( alignment -&gt; {</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if ( _owner instanceof JLabel ) {</span>
<span class="fc" id="L315">                JLabel label = (JLabel) _owner;</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">                if ( !Objects.equals( label.getHorizontalAlignment(), alignment.forSwing() ) )</span>
<span class="fc" id="L317">                    label.setHorizontalAlignment( alignment.forSwing() );</span>
            }
<span class="fc bfc" id="L319" title="All 2 branches covered.">            if ( _owner instanceof AbstractButton ) {</span>
<span class="fc" id="L320">                AbstractButton button = (AbstractButton) _owner;</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">                if ( !Objects.equals( button.getHorizontalAlignment(), alignment.forSwing() ) )</span>
<span class="fc" id="L322">                    button.setHorizontalAlignment( alignment.forSwing() );</span>
            }
<span class="fc bfc" id="L324" title="All 2 branches covered.">            if ( _owner instanceof JTextField ) {</span>
<span class="fc" id="L325">                JTextField textField = (JTextField) _owner;</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">                if ( !Objects.equals( textField.getHorizontalAlignment(), alignment.forSwing() ) )</span>
<span class="fc" id="L327">                    textField.setHorizontalAlignment( alignment.forSwing() );</span>
            }
<span class="fc" id="L329">        });</span>
<span class="fc" id="L330">        style.font().verticalAlignment().ifPresent( alignment -&gt; {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            if ( _owner instanceof JLabel ) {</span>
<span class="nc" id="L332">                JLabel label = (JLabel) _owner;</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if ( !Objects.equals( label.getVerticalAlignment(), alignment.forSwing() ) )</span>
<span class="nc" id="L334">                    label.setVerticalAlignment( alignment.forSwing() );</span>
            }
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if ( _owner instanceof AbstractButton ) {</span>
<span class="nc" id="L337">                AbstractButton button = (AbstractButton) _owner;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if ( !Objects.equals( button.getVerticalAlignment(), alignment.forSwing() ) )</span>
<span class="nc" id="L339">                    button.setVerticalAlignment( alignment.forSwing() );</span>
            }
<span class="nc" id="L341">        });</span>

<span class="fc bfc" id="L343" title="All 2 branches covered.">        if ( !onlyDimensionalityIsStyled ) {</span>
<span class="fc" id="L344">            _installCustomBorderBasedStyleAndAnimationRenderer();</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">            if ( !styleCanBeRenderedThroughBorder )</span>
<span class="fc" id="L346">                _laf = _laf.establishLookAndFeelFor(style, _owner);</span>
        }

<span class="fc bfc" id="L349" title="All 2 branches covered.">        if ( style.hasCustomForegroundPainters() )</span>
<span class="fc" id="L350">            _makeAllChildrenTransparent(_owner);</span>

<span class="pc bpc" id="L352" title="1 of 4 branches missed.">        if ( style.hasActiveBackgroundGradients() &amp;&amp; _owner.isOpaque() )</span>
<span class="nc" id="L353">            _owner.setOpaque(false);</span>

<span class="fc" id="L355">        return style;</span>
    }

    /**
     *  Note that the foreground painter is intended to paint over all children of the component, &lt;br&gt;
     *  which is why it will be called at the end of {@code JComponent::paintChildren(Graphics)}.
     *  &lt;br&gt;
     *  However, there is a problem with this approach! &lt;br&gt;
     *  If not all children are transparent, the result of the foreground painter can be overwritten
     *  by {@link JComponent#paintImmediately(int, int, int, int)} when certain events occur
     *  (like a child component is a text field with a blinking cursor, or a button with hover effect).
     *  This type of repaint does unfortunately not call {@code JComponent::paintChildren(Graphics)},
     *  in fact it completely bypasses the rendering of this current component!
     *  In order to ensure that the stuff painted by the foreground painter is not overwritten
     *  in these types of cases,
     *  we make all children transparent (non-opaque) so that the foreground painter is always visible.
     *
     * @param c The component to make all children transparent.
     */
    private void _makeAllChildrenTransparent( JComponent c ) {
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">        if ( c.isOpaque() )</span>
<span class="nc" id="L376">            c.setOpaque(false);</span>

<span class="pc bpc" id="L378" title="1 of 2 branches missed.">        for ( Component child : c.getComponents() ) {</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">            if ( child instanceof JComponent ) {</span>
<span class="nc" id="L380">                JComponent jChild = (JComponent) child;</span>
<span class="nc" id="L381">                _makeAllChildrenTransparent(jChild);</span>
            }
        }
<span class="fc" id="L384">    }</span>

    private void _installCustomBorderBasedStyleAndAnimationRenderer() {
<span class="fc" id="L387">        Border currentBorder = _owner.getBorder();</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">        if ( !(currentBorder instanceof StyleAndAnimationBorder) )</span>
<span class="fc" id="L389">            _owner.setBorder(new StyleAndAnimationBorder&lt;&gt;(this, currentBorder));</span>
<span class="fc" id="L390">    }</span>

    private void _uninstallCustomBorderBasedStyleAndAnimationRenderer() {
<span class="fc" id="L393">        Border currentBorder = _owner.getBorder();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">        if ( currentBorder instanceof StyleAndAnimationBorder) {</span>
<span class="fc" id="L395">            StyleAndAnimationBorder&lt;?&gt; border = (StyleAndAnimationBorder&lt;?&gt;) currentBorder;</span>
<span class="fc" id="L396">            _owner.setBorder(border.getFormerBorder());</span>
        }
<span class="fc" id="L398">    }</span>

    static boolean _componentIsDeclaredInUI(JComponent comp ) {
        // The component must be a subtype of one of the classes enclosed in this UI class!
        // Let's get all the classes declared in UI:
<span class="fc" id="L403">        Class&lt;?&gt;[] declaredInUI = UI.class.getDeclaredClasses();</span>
        // We want to ensure that the component is a sub-type of any of the classes declared in UI.
<span class="fc" id="L405">        Class&lt;?&gt; clazz = comp.getClass();</span>
<span class="fc" id="L406">        boolean isSwingTreeComponent = false;</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">        while ( clazz != null ) {</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">            for ( Class&lt;?&gt; c : declaredInUI )</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">                if ( c.isAssignableFrom(clazz) ) {</span>
<span class="fc" id="L410">                    isSwingTreeComponent = true;</span>
<span class="fc" id="L411">                    break;</span>
                }

<span class="fc" id="L414">            clazz = clazz.getSuperclass();</span>
        }
<span class="fc" id="L416">        return isSwingTreeComponent;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>