<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StyleInstaller.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree.style</a> &gt; <span class="el_source">StyleInstaller.java</span></div><h1>StyleInstaller.java</h1><pre class="source lang-java linenums">package swingtree.style;

import net.miginfocom.layout.CC;
import net.miginfocom.layout.ConstraintParser;
import net.miginfocom.layout.DimConstraint;
import net.miginfocom.layout.UnitValue;
import net.miginfocom.swing.MigLayout;
import swingtree.UI;
import swingtree.components.JIcon;

import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.text.JTextComponent;
import java.awt.*;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

/**
 *  Contains all the logic for installing a style on a component.
 * @param &lt;C&gt; The type of the component.
 */
<span class="fc" id="L23">final class StyleInstaller&lt;C extends JComponent&gt;</span>
{
<span class="fc" id="L25">    private DynamicLaF _dynamicLaF = DynamicLaF.none(); // Not null, but can be DynamicLaF.none().</span>
<span class="fc" id="L26">    private Color      _initialBackgroundColor = null;</span>
<span class="fc" id="L27">    private Boolean    _initialIsOpaque = null;</span>


    void installCustomBorderBasedStyleAndAnimationRenderer(C owner ) {
<span class="fc" id="L31">        Border currentBorder = owner.getBorder();</span>
<span class="fc bfc" id="L32" title="All 2 branches covered.">        if ( !(currentBorder instanceof StyleAndAnimationBorder) )</span>
<span class="fc" id="L33">            owner.setBorder(new StyleAndAnimationBorder&lt;&gt;(ComponentExtension.from(owner), currentBorder));</span>
<span class="fc" id="L34">    }</span>

    void installCustomUIFor( C owner ) {
<span class="fc" id="L37">        _dynamicLaF.installCustomUIFor(owner);</span>
<span class="fc" id="L38">    }</span>

    boolean customLookAndFeelIsInstalled() {
<span class="fc" id="L41">        return _dynamicLaF.customLookAndFeelIsInstalled();</span>
    }

    Style applyStyleToComponentState( C owner, Style newStyle, StyleSource&lt;C&gt; styleSource, StyleEngine styleEngine )
    {
<span class="fc" id="L46">        final Style.Report styleReport = newStyle.getReport();</span>

<span class="fc" id="L48">        boolean isNotStyled                     = styleReport.isNotStyled();</span>
<span class="fc" id="L49">        boolean onlyDimensionalityIsStyled      = styleReport.onlyDimensionalityIsStyled();</span>
<span class="pc bpc" id="L50" title="2 of 18 branches missed.">        boolean styleCanBeRenderedThroughBorder = (</span>
                                                       styleReport.noBaseStyle    &amp;&amp;
                                                       (styleReport.noShadowStyle || styleReport.allShadowsAreBorderShadows)     &amp;&amp;
                                                       (styleReport.noPainters    || styleReport.allPaintersAreBorderPainters)   &amp;&amp;
                                                       (styleReport.noGradients   || styleReport.allGradientsAreBorderGradients) &amp;&amp;
                                                       (styleReport.noImages      || styleReport.allImagesAreBorderImages)
                                                   );

<span class="fc bfc" id="L58" title="All 4 branches covered.">        if ( isNotStyled || onlyDimensionalityIsStyled ) {</span>
<span class="fc" id="L59">            _dynamicLaF = _dynamicLaF._uninstallCustomLaF(owner);</span>
<span class="pc bpc" id="L60" title="2 of 4 branches missed.">            if ( styleSource.hasNoAnimationStylers() &amp;&amp; styleEngine.hasNoPainters() )</span>
<span class="fc" id="L61">                _uninstallCustomBorderBasedStyleAndAnimationRenderer(owner);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">            if ( _initialBackgroundColor != null ) {</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">                if ( !Objects.equals( owner.getBackground(), _initialBackgroundColor ) )</span>
<span class="fc" id="L64">                    owner.setBackground(_initialBackgroundColor);</span>
<span class="fc" id="L65">                _initialBackgroundColor = null;</span>
            }
<span class="fc bfc" id="L67" title="All 2 branches covered.">            if ( _initialIsOpaque != null ) {</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">                if ( owner.isOpaque() != _initialIsOpaque )</span>
<span class="fc" id="L69">                    owner.setOpaque(_initialIsOpaque);</span>
<span class="fc" id="L70">                _initialIsOpaque = null;</span>
            }
<span class="fc bfc" id="L72" title="All 2 branches covered.">            if ( isNotStyled )</span>
<span class="fc" id="L73">                return newStyle;</span>
        }

<span class="fc bfc" id="L76" title="All 2 branches covered.">        if ( _initialIsOpaque == null )</span>
<span class="fc" id="L77">            _initialIsOpaque = owner.isOpaque();</span>

<span class="fc" id="L79">        final List&lt;UI.ComponentArea&gt; opaqueGradientAreas = newStyle.gradientCoveredAreas();</span>
<span class="fc" id="L80">        final boolean hasBackgroundGradients             = newStyle.hasVisibleGradientsOnLayer(UI.Layer.BACKGROUND);</span>
<span class="fc" id="L81">        final boolean hasBackgroundPainters              = newStyle.hasPaintersOnLayer(UI.Layer.BACKGROUND);</span>
<span class="fc" id="L82">        final boolean hasBackgroundImages                = newStyle.hasImagesOnLayer(UI.Layer.BACKGROUND);</span>
<span class="fc" id="L83">        final boolean hasBackgroundShadows               = newStyle.hasVisibleShadows(UI.Layer.BACKGROUND);</span>
<span class="fc" id="L84">        final boolean hasBorderRadius                    = newStyle.border().hasAnyNonZeroArcs();</span>
<span class="fc" id="L85">        final boolean hasBackground                      = newStyle.base().backgroundColor().isPresent();</span>
<span class="fc" id="L86">        final boolean hasMargin                          = newStyle.margin().isPositive();</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">        final boolean hasOpaqueBorder                    = !(255 &gt; newStyle.border().color().map(Color::getAlpha).orElse(0));</span>


<span class="fc bfc" id="L90" title="All 4 branches covered.">        if ( !hasBackground &amp;&amp; _initialIsOpaque ) {</span>
            // If the style has a border radius set we need to make sure that we have a background color:
<span class="fc bfc" id="L92" title="All 4 branches covered.">            if ( hasBorderRadius || newStyle.border().margin().isPositive() ) {</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">                _initialBackgroundColor = _initialBackgroundColor != null ? _initialBackgroundColor : owner.getBackground();</span>
<span class="fc" id="L94">                newStyle = newStyle.backgroundColor(_initialBackgroundColor);</span>
            }
        }

<span class="fc bfc" id="L98" title="All 2 branches covered.">        if ( hasBackground ) {</span>
<span class="fc" id="L99">            boolean backgroundIsAlreadySet = Objects.equals( owner.getBackground(), newStyle.base().backgroundColor().get() );</span>
<span class="fc bfc" id="L100" title="All 4 branches covered.">            if ( !backgroundIsAlreadySet || newStyle.base().backgroundColor().get() == UI.COLOR_UNDEFINED )</span>
            {
<span class="fc bfc" id="L102" title="All 2 branches covered.">                _initialBackgroundColor = _initialBackgroundColor != null ? _initialBackgroundColor :  owner.getBackground();</span>
<span class="fc" id="L103">                Color newColor =  newStyle.base().backgroundColor().get();</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">                if ( newColor == UI.COLOR_UNDEFINED)</span>
<span class="fc" id="L105">                    newColor = null;</span>

<span class="fc bfc" id="L107" title="All 2 branches covered.">                if ( !Objects.equals( owner.getBackground(), newColor ) ) {</span>
<span class="fc" id="L108">                    owner.setBackground( newColor );</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">                    if ( owner instanceof JScrollPane ) {</span>
<span class="fc" id="L110">                        JScrollPane scrollPane = (JScrollPane) owner;</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">                        if ( scrollPane.getViewport() != null ) {</span>
<span class="fc" id="L112">                            newColor = newStyle.base().backgroundColor().get();</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                            if ( newColor == UI.COLOR_UNDEFINED)</span>
<span class="nc" id="L114">                                newColor = null;</span>

<span class="fc" id="L116">                            JViewport viewport = scrollPane.getViewport();</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">                            if ( !Objects.equals( viewport.getBackground(), newColor ) )</span>
<span class="fc" id="L118">                                viewport.setBackground( newColor );</span>
                        }
                    }
                }
            }
        }

<span class="fc bfc" id="L125" title="All 2 branches covered.">        if ( !onlyDimensionalityIsStyled ) {</span>
<span class="fc" id="L126">            installCustomBorderBasedStyleAndAnimationRenderer(owner);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">            if ( !styleCanBeRenderedThroughBorder )</span>
<span class="fc" id="L128">                _dynamicLaF = _dynamicLaF.establishLookAndFeelFor(newStyle, owner);</span>
        }

<span class="fc" id="L131">        boolean canBeOpaque = true;</span>

<span class="pc bpc" id="L133" title="1 of 2 branches missed.">        if ( !opaqueGradientAreas.contains(UI.ComponentArea.ALL) ) {</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">            boolean hasOpaqueFoundation = 255 == newStyle.base().foundationColor().map(Color::getAlpha).orElse(0);</span>
<span class="fc bfc" id="L135" title="All 4 branches covered.">            boolean hasOpaqueBackground = 255 == newStyle.base().backgroundColor().map( c -&gt; c != UI.COLOR_UNDEFINED ? c : _initialBackgroundColor ).map(Color::getAlpha).orElse(255);</span>
<span class="fc" id="L136">            boolean hasBorder           = newStyle.border().widths().isPositive();</span>

<span class="pc bpc" id="L138" title="1 of 4 branches missed.">            if ( !hasOpaqueFoundation &amp;&amp; !opaqueGradientAreas.contains(UI.ComponentArea.EXTERIOR) ) {</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">                if ( hasBorderRadius )</span>
<span class="fc" id="L140">                    canBeOpaque = false;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">                else if ( hasMargin )</span>
<span class="fc" id="L142">                    canBeOpaque = false;</span>
            }

<span class="pc bpc" id="L145" title="1 of 6 branches missed.">            if ( hasBorder &amp;&amp; (!hasOpaqueBorder &amp;&amp; !opaqueGradientAreas.contains(UI.ComponentArea.BORDER)) )</span>
<span class="fc" id="L146">                canBeOpaque = false;</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">            if (</span>
                !hasOpaqueBackground &amp;&amp;
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                !opaqueGradientAreas.contains(UI.ComponentArea.INTERIOR) &amp;&amp;</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                !opaqueGradientAreas.contains(UI.ComponentArea.BODY)</span>
            )
<span class="fc" id="L153">                canBeOpaque = false;</span>
        }

<span class="fc bfc" id="L156" title="All 2 branches covered.">        if ( !canBeOpaque ) {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if ( owner.isOpaque() )</span>
<span class="fc" id="L158">                owner.setOpaque(false);</span>
        }
        else
        {
<span class="fc" id="L162">            boolean isSwingTreeComponent = _isNestedClassInUINamespace(owner);</span>

<span class="fc bfc" id="L164" title="All 2 branches covered.">            if ( !isSwingTreeComponent ) {</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">                if ( owner.isOpaque() )</span>
<span class="fc" id="L166">                    owner.setOpaque(false);</span>
            } else {
<span class="fc bfc" id="L168" title="All 2 branches covered.">                if ( !owner.isOpaque() )</span>
<span class="fc" id="L169">                    owner.setOpaque(true);</span>

<span class="fc" id="L171">                boolean requiresBackgroundPainting = hasBackgroundGradients;</span>
<span class="fc bfc" id="L172" title="All 4 branches covered.">                requiresBackgroundPainting = requiresBackgroundPainting || hasBackgroundShadows;</span>
<span class="fc bfc" id="L173" title="All 4 branches covered.">                requiresBackgroundPainting = requiresBackgroundPainting || hasBackgroundPainters;</span>
<span class="fc bfc" id="L174" title="All 4 branches covered.">                requiresBackgroundPainting = requiresBackgroundPainting || hasBackgroundImages;</span>
<span class="fc bfc" id="L175" title="All 4 branches covered.">                requiresBackgroundPainting = requiresBackgroundPainting || hasBorderRadius;</span>
<span class="fc bfc" id="L176" title="All 4 branches covered.">                requiresBackgroundPainting = requiresBackgroundPainting || hasMargin;</span>

<span class="fc bfc" id="L178" title="All 4 branches covered.">                if ( requiresBackgroundPainting &amp;&amp; !Objects.equals( owner.getBackground(), UI.COLOR_UNDEFINED ) )</span>
<span class="fc" id="L179">                    owner.setBackground(UI.COLOR_UNDEFINED);</span>
                /*
                    The above line looks very strange, but it is very important!
                    To understand what is going on here, you have to know that when a component is
                    flagged to be opaque, then every Swing look and feel will, before painting
                    anything else, first fill out the entire background of the component with
                    the background color of the component.

                    Now this is a problem when you have the background layer of your SwingTree component
                    styled using various things like gradients, shadows, images, etc.

                    We could simply set the opaque flag to false, but then we would lose the
                    performance benefits of having the opaque flag set to true (avoiding the
                    traversal repaint of parent components, and their parent components, etc).

                    In this branch we have already determined that the style configuration
                    leads to an opaque component, and we also have the ability to render
                    the background of the component ourselves due to the
                    component being a SwingTree component (it has the paint method overridden).

                    So what we do here is we set the background color of the component to
                    UI.COLOR_UNDEFINED, which is a special color that is actually fully transparent.

                    This way, when the Swing look and feel tries to paint the background of the
                    component, it will actually paint nothing, and we can do the background
                    painting ourselves in the paint method of the component.
                */
            }
        }

<span class="fc bfc" id="L209" title="All 2 branches covered.">        if ( owner instanceof AbstractButton) {</span>
<span class="fc" id="L210">            AbstractButton b = (AbstractButton) owner;</span>

<span class="fc bfc" id="L212" title="All 4 branches covered.">            boolean shouldButtonBeFilled = !hasBackgroundGradients &amp;&amp; !hasBackgroundPainters;</span>

<span class="fc bfc" id="L214" title="All 2 branches covered.">            if ( shouldButtonBeFilled != b.isContentAreaFilled() )</span>
<span class="fc" id="L215">                b.setContentAreaFilled( shouldButtonBeFilled );</span>
        }

<span class="fc" id="L218">        _applyGenericBaseStyleTo(owner, newStyle);</span>
<span class="fc" id="L219">        _applyIconStyleTo(owner, newStyle);</span>
<span class="fc" id="L220">        _applyLayoutStyleTo(owner, newStyle);</span>
<span class="fc" id="L221">        _applyDimensionalityStyleTo(owner, newStyle);</span>
<span class="fc" id="L222">        _applyFontStyleTo(owner, newStyle);</span>
<span class="fc" id="L223">        _applyPropertiesTo(owner, newStyle);</span>
<span class="fc" id="L224">        _doComboBoxMarginAdjustment(owner, newStyle);</span>

<span class="fc bfc" id="L226" title="All 2 branches covered.">        if ( newStyle.hasPaintersOnLayer(UI.Layer.FOREGROUND) )</span>
<span class="fc" id="L227">            _makeAllChildrenTransparent(owner);</span>

<span class="fc" id="L229">        return newStyle;</span>
    }

    private void _applyGenericBaseStyleTo( final C owner, final Style styleConf )
    {
<span class="fc bfc" id="L234" title="All 4 branches covered.">        if ( styleConf.base().foregroundColor().isPresent() &amp;&amp; !Objects.equals( owner.getForeground(), styleConf.base().foregroundColor().get() ) ) {</span>
<span class="fc" id="L235">            Color newColor = styleConf.base().foregroundColor().get();</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">            if ( newColor == UI.COLOR_UNDEFINED)</span>
<span class="fc" id="L237">                newColor = null;</span>

<span class="fc bfc" id="L239" title="All 2 branches covered.">            if ( !Objects.equals( owner.getForeground(), newColor ) )</span>
<span class="fc" id="L240">                owner.setForeground( newColor );</span>
        }

<span class="fc" id="L243">        styleConf.base().cursor().ifPresent( cursor -&gt; {</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">            if ( !Objects.equals( owner.getCursor(), cursor ) )</span>
<span class="fc" id="L245">                owner.setCursor( cursor );</span>
<span class="fc" id="L246">        });</span>

<span class="fc bfc" id="L248" title="All 2 branches covered.">        if ( styleConf.base().orientation() != UI.ComponentOrientation.UNKNOWN ) {</span>
<span class="fc" id="L249">            ComponentOrientation currentOrientation = owner.getComponentOrientation();</span>
<span class="fc" id="L250">            UI.ComponentOrientation newOrientation = styleConf.base().orientation();</span>
<span class="pc bpc" id="L251" title="1 of 3 branches missed.">            switch ( newOrientation ) {</span>
                case LEFT_TO_RIGHT:
<span class="fc bfc" id="L253" title="All 2 branches covered.">                    if ( !Objects.equals( currentOrientation, ComponentOrientation.LEFT_TO_RIGHT ) )</span>
<span class="fc" id="L254">                        owner.applyComponentOrientation(ComponentOrientation.LEFT_TO_RIGHT);</span>
                    break;
                case RIGHT_TO_LEFT:
<span class="fc bfc" id="L257" title="All 2 branches covered.">                    if ( !Objects.equals( currentOrientation, ComponentOrientation.RIGHT_TO_LEFT ) )</span>
<span class="fc" id="L258">                        owner.applyComponentOrientation(ComponentOrientation.RIGHT_TO_LEFT);</span>
                    break;
                default:
<span class="nc bnc" id="L261" title="All 2 branches missed.">                    if ( !Objects.equals( currentOrientation, ComponentOrientation.UNKNOWN ) )</span>
<span class="nc" id="L262">                        owner.applyComponentOrientation(ComponentOrientation.UNKNOWN);</span>
                    break;
            }
        }
<span class="fc" id="L266">    }</span>

    private void _applyIconStyleTo( final C owner, Style styleConf )
    {
<span class="fc" id="L270">        UI.FitComponent fit = styleConf.base().fit();</span>
<span class="fc" id="L271">        styleConf.base().icon().ifPresent( icon -&gt; {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if ( icon instanceof SvgIcon) {</span>
<span class="nc" id="L273">                SvgIcon svgIcon = (SvgIcon) icon;</span>
<span class="nc" id="L274">                icon = svgIcon.withFitComponent(fit);</span>
            }
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if ( owner instanceof AbstractButton ) {</span>
<span class="nc" id="L277">                AbstractButton button = (AbstractButton) owner;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                if ( !Objects.equals( button.getIcon(), icon ) )</span>
<span class="nc" id="L279">                    button.setIcon( icon );</span>
            }
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if ( owner instanceof JLabel ) {</span>
<span class="nc" id="L282">                JLabel label = (JLabel) owner;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                if ( !Objects.equals( label.getIcon(), icon ) )</span>
<span class="nc" id="L284">                    label.setIcon( icon );</span>
            }
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if ( owner instanceof JIcon ) {</span>
<span class="nc" id="L287">                JIcon jIcon = (JIcon) owner;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">                if ( !Objects.equals( jIcon.getIcon(), icon ) )</span>
<span class="nc" id="L289">                    jIcon.setIcon( icon );</span>
            }
<span class="nc" id="L291">        });</span>
<span class="fc" id="L292">    }</span>

    private void _applyLayoutStyleTo( final C owner, final Style styleConf )
    {
<span class="fc" id="L296">        final LayoutStyle style = styleConf.layout();</span>

        // Generic Layout stuff:

<span class="fc" id="L300">        styleConf.layout().alignmentX().ifPresent( alignmentX -&gt; {</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">            if ( !Objects.equals( owner.getAlignmentX(), alignmentX ) )</span>
<span class="fc" id="L302">                owner.setAlignmentX( alignmentX );</span>
<span class="fc" id="L303">        });</span>

<span class="fc" id="L305">        styleConf.layout().alignmentY().ifPresent( alignmentY -&gt; {</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">            if ( !Objects.equals( owner.getAlignmentY(), alignmentY ) )</span>
<span class="fc" id="L307">                owner.setAlignmentY( alignmentY );</span>
<span class="fc" id="L308">        });</span>

        // Install Generic Layout:
<span class="fc" id="L311">        styleConf.layout().layout().installFor(owner);</span>

        // Now on to MigLayout stuff:

<span class="fc" id="L315">        Optional&lt;Float&gt; alignmentX = style.alignmentX();</span>
<span class="fc" id="L316">        Optional&lt;Float&gt; alignmentY = style.alignmentY();</span>

<span class="pc bpc" id="L318" title="1 of 4 branches missed.">        if ( !alignmentX.isPresent() &amp;&amp; !alignmentY.isPresent() )</span>
<span class="fc" id="L319">            return;</span>

<span class="fc bfc" id="L321" title="All 2 branches covered.">        LayoutManager layout = ( owner.getParent() == null ? null : owner.getParent().getLayout() );</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">        if ( layout instanceof MigLayout ) {</span>
<span class="fc" id="L323">            MigLayout migLayout = (MigLayout) layout;</span>
<span class="fc" id="L324">            Object rawComponentConstraints = migLayout.getComponentConstraints(owner);</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">            if ( rawComponentConstraints instanceof String )</span>
<span class="nc" id="L326">                rawComponentConstraints = ConstraintParser.parseComponentConstraint(rawComponentConstraints.toString());</span>

<span class="pc bpc" id="L328" title="1 of 2 branches missed.">            CC componentConstraints = (rawComponentConstraints instanceof CC ? (CC) rawComponentConstraints : null);</span>

<span class="pc bpc" id="L330" title="1 of 2 branches missed.">            final CC finalComponentConstraints = ( componentConstraints == null ? new CC() : componentConstraints );</span>

<span class="fc" id="L332">            String x = alignmentX.map( a -&gt; (int) ( a * 100f ) )</span>
<span class="fc" id="L333">                                  .map( a -&gt; a + &quot;%&quot; )</span>
<span class="fc" id="L334">                                  .orElse(&quot;&quot;);</span>

<span class="fc" id="L336">            String y = alignmentY.map( a -&gt; (int) ( a * 100f ) )</span>
<span class="fc" id="L337">                                  .map( a -&gt; a + &quot;%&quot; )</span>
<span class="fc" id="L338">                                  .orElse(&quot;&quot;);</span>

<span class="fc" id="L340">            DimConstraint horizontalDimConstraint = finalComponentConstraints.getHorizontal();</span>
<span class="fc" id="L341">            DimConstraint verticalDimConstraint   = finalComponentConstraints.getVertical();</span>

<span class="fc" id="L343">            UnitValue xAlign = horizontalDimConstraint.getAlign();</span>
<span class="fc" id="L344">            UnitValue yAlign = verticalDimConstraint.getAlign();</span>

<span class="pc bpc" id="L346" title="2 of 4 branches missed.">            boolean xChange = !x.equals( xAlign == null ? &quot;&quot; : xAlign.getConstraintString() );</span>
<span class="pc bpc" id="L347" title="2 of 4 branches missed.">            boolean yChange = !y.equals( yAlign == null ? &quot;&quot; : yAlign.getConstraintString() );</span>

<span class="pc bpc" id="L349" title="2 of 4 branches missed.">            if ( !x.isEmpty() &amp;&amp; xChange )</span>
<span class="fc" id="L350">                finalComponentConstraints.alignX(x);</span>

<span class="pc bpc" id="L352" title="2 of 4 branches missed.">            if ( !y.isEmpty() &amp;&amp; yChange )</span>
<span class="fc" id="L353">                finalComponentConstraints.alignY(y);</span>

<span class="pc bpc" id="L355" title="3 of 4 branches missed.">            if ( xChange || yChange ) {</span>
<span class="fc" id="L356">                migLayout.setComponentConstraints(owner, finalComponentConstraints);</span>
<span class="fc" id="L357">                owner.getParent().revalidate();</span>
            }
        }
<span class="fc" id="L360">    }</span>

    private void _applyDimensionalityStyleTo( final C owner, final Style styleConf )
    {
<span class="fc" id="L364">        final DimensionalityStyle dimensionalityStyle = styleConf.dimensionality();</span>

<span class="fc bfc" id="L366" title="All 4 branches covered.">        if ( dimensionalityStyle.minWidth().isPresent() || dimensionalityStyle.minHeight().isPresent() ) {</span>
<span class="fc" id="L367">            Dimension minSize = owner.getMinimumSize();</span>

<span class="pc bpc" id="L369" title="1 of 2 branches missed.">            int minWidth  = dimensionalityStyle.minWidth().orElse(minSize == null ? 0 : minSize.width);</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">            int minHeight = dimensionalityStyle.minHeight().orElse(minSize == null ? 0 : minSize.height);</span>

<span class="fc" id="L372">            Dimension newMinSize = new Dimension(minWidth, minHeight);</span>

<span class="fc bfc" id="L374" title="All 2 branches covered.">            if ( ! newMinSize.equals(minSize) )</span>
<span class="fc" id="L375">                owner.setMinimumSize(newMinSize);</span>
        }

<span class="fc bfc" id="L378" title="All 4 branches covered.">        if ( dimensionalityStyle.maxWidth().isPresent() || dimensionalityStyle.maxHeight().isPresent() ) {</span>
<span class="fc" id="L379">            Dimension maxSize = owner.getMaximumSize();</span>

<span class="pc bpc" id="L381" title="1 of 2 branches missed.">            int maxWidth  = dimensionalityStyle.maxWidth().orElse(maxSize == null  ? Integer.MAX_VALUE : maxSize.width);</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">            int maxHeight = dimensionalityStyle.maxHeight().orElse(maxSize == null ? Integer.MAX_VALUE : maxSize.height);</span>

<span class="fc" id="L384">            Dimension newMaxSize = new Dimension(maxWidth, maxHeight);</span>

<span class="fc bfc" id="L386" title="All 2 branches covered.">            if ( ! newMaxSize.equals(maxSize) )</span>
<span class="fc" id="L387">                owner.setMaximumSize(newMaxSize);</span>
        }

<span class="fc bfc" id="L390" title="All 4 branches covered.">        if ( dimensionalityStyle.preferredWidth().isPresent() || dimensionalityStyle.preferredHeight().isPresent() ) {</span>
<span class="fc" id="L391">            Dimension prefSize = owner.getPreferredSize();</span>

<span class="pc bpc" id="L393" title="1 of 2 branches missed.">            int prefWidth  = dimensionalityStyle.preferredWidth().orElse(prefSize == null ? 0 : prefSize.width);</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">            int prefHeight = dimensionalityStyle.preferredHeight().orElse(prefSize == null ? 0 : prefSize.height);</span>

<span class="fc" id="L396">            Dimension newPrefSize = new Dimension(prefWidth, prefHeight);</span>

<span class="fc bfc" id="L398" title="All 2 branches covered.">            if ( !newPrefSize.equals(prefSize) )</span>
<span class="fc" id="L399">                owner.setPreferredSize(newPrefSize);</span>
        }

<span class="fc bfc" id="L402" title="All 4 branches covered.">        if ( dimensionalityStyle.width().isPresent() || dimensionalityStyle.height().isPresent() ) {</span>
<span class="fc" id="L403">            Dimension size = owner.getSize();</span>

<span class="pc bpc" id="L405" title="1 of 2 branches missed.">            int width  = dimensionalityStyle.width().orElse(size == null ? 0 : size.width);</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">            int height = dimensionalityStyle.height().orElse(size == null ? 0 : size.height);</span>

<span class="fc" id="L408">            Dimension newSize = new Dimension(width, height);</span>

<span class="fc bfc" id="L410" title="All 2 branches covered.">            if ( ! newSize.equals(size) )</span>
<span class="fc" id="L411">                owner.setSize(newSize);</span>
        }
<span class="fc" id="L413">    }</span>

    private void _applyFontStyleTo( final C owner, final Style styleConf )
    {
<span class="fc" id="L417">        final FontStyle fontStyle = styleConf.font();</span>

<span class="fc bfc" id="L419" title="All 2 branches covered.">        if ( owner instanceof JTextComponent ) {</span>
<span class="fc" id="L420">            JTextComponent tc = (JTextComponent) owner;</span>
<span class="fc bfc" id="L421" title="All 4 branches covered.">            if ( fontStyle.selectionColor().isPresent() &amp;&amp; ! Objects.equals( tc.getSelectionColor(), fontStyle.selectionColor().get() ) )</span>
<span class="fc" id="L422">                tc.setSelectionColor(fontStyle.selectionColor().get());</span>
        }

<span class="fc" id="L425">        fontStyle</span>
<span class="fc" id="L426">             .createDerivedFrom(owner.getFont())</span>
<span class="fc" id="L427">             .ifPresent( newFont -&gt; {</span>
<span class="fc bfc" id="L428" title="All 2 branches covered.">                    if ( !newFont.equals(owner.getFont()) )</span>
<span class="fc" id="L429">                        owner.setFont( newFont );</span>
<span class="fc" id="L430">                });</span>

<span class="fc" id="L432">        fontStyle.horizontalAlignment().ifPresent( alignment -&gt; {</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">            if ( owner instanceof JLabel ) {</span>
<span class="fc" id="L434">                JLabel label = (JLabel) owner;</span>
<span class="fc bfc" id="L435" title="All 2 branches covered.">                if ( !Objects.equals( label.getHorizontalAlignment(), alignment.forSwing() ) )</span>
<span class="fc" id="L436">                    label.setHorizontalAlignment( alignment.forSwing() );</span>
            }
<span class="fc bfc" id="L438" title="All 2 branches covered.">            if ( owner instanceof AbstractButton ) {</span>
<span class="fc" id="L439">                AbstractButton button = (AbstractButton) owner;</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">                if ( !Objects.equals( button.getHorizontalAlignment(), alignment.forSwing() ) )</span>
<span class="fc" id="L441">                    button.setHorizontalAlignment( alignment.forSwing() );</span>
            }
<span class="fc bfc" id="L443" title="All 2 branches covered.">            if ( owner instanceof JTextField ) {</span>
<span class="fc" id="L444">                JTextField textField = (JTextField) owner;</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">                if ( !Objects.equals( textField.getHorizontalAlignment(), alignment.forSwing() ) )</span>
<span class="fc" id="L446">                    textField.setHorizontalAlignment( alignment.forSwing() );</span>
            }
<span class="fc" id="L448">        });</span>
<span class="fc" id="L449">        fontStyle.verticalAlignment().ifPresent( alignment -&gt; {</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">            if ( owner instanceof JLabel ) {</span>
<span class="nc" id="L451">                JLabel label = (JLabel) owner;</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                if ( !Objects.equals( label.getVerticalAlignment(), alignment.forSwing() ) )</span>
<span class="nc" id="L453">                    label.setVerticalAlignment( alignment.forSwing() );</span>
            }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">            if ( owner instanceof AbstractButton ) {</span>
<span class="nc" id="L456">                AbstractButton button = (AbstractButton) owner;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                if ( !Objects.equals( button.getVerticalAlignment(), alignment.forSwing() ) )</span>
<span class="nc" id="L458">                    button.setVerticalAlignment( alignment.forSwing() );</span>
            }
<span class="fc" id="L460">        });</span>
<span class="fc" id="L461">    }</span>

    private void _applyPropertiesTo( final C owner, final Style styleConf ) {
<span class="fc" id="L464">        styleConf.properties().forEach( property -&gt; {</span>
<span class="fc" id="L465">            Object oldValue = owner.getClientProperty(property.name());</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">            if ( property.style().equals(oldValue) )</span>
<span class="fc" id="L467">                return;</span>

<span class="pc bpc" id="L469" title="1 of 2 branches missed.">            if ( property.style().isEmpty() )</span>
<span class="nc" id="L470">                owner.putClientProperty(property.name(), null); // remove property</span>
            else
<span class="fc" id="L472">                owner.putClientProperty(property.name(), property.style());</span>
<span class="fc" id="L473">        });</span>
<span class="fc" id="L474">    }</span>

    private void _doComboBoxMarginAdjustment( final C owner, final Style styleConf ) {
<span class="fc bfc" id="L477" title="All 2 branches covered.">        if ( owner instanceof JComboBox ) {</span>
<span class="fc" id="L478">            int bottom = styleConf.margin().bottom().map(Number::intValue).orElse(0);</span>
            // We adjust the position of the popup menu:
            try {
<span class="nc" id="L481">                Point location = owner.getLocationOnScreen();</span>
<span class="nc" id="L482">                int x = location.x;</span>
<span class="nc" id="L483">                int y = location.y + owner.getHeight() - bottom;</span>
<span class="nc" id="L484">                JComboBox&lt;?&gt; comboBox = (JComboBox&lt;?&gt;) owner;</span>
<span class="nc" id="L485">                JPopupMenu popup = (JPopupMenu) comboBox.getAccessibleContext().getAccessibleChild(0);</span>
<span class="nc" id="L486">                Point oldLocation = popup.getLocation();</span>
<span class="nc bnc" id="L487" title="All 6 branches missed.">                if ( popup.isShowing() &amp;&amp; (oldLocation.x != x || oldLocation.y != y) )</span>
<span class="nc" id="L488">                    popup.setLocation(x, y);</span>
<span class="fc" id="L489">            } catch ( Exception e ) {</span>
                // ignore
<span class="nc" id="L491">            }</span>
        }
<span class="fc" id="L493">    }</span>

    private boolean _isNestedClassInUINamespace( C owner ) {
<span class="fc" id="L496">        Class&lt;UI&gt; uiClass = UI.class;</span>
<span class="fc" id="L497">        Class&lt;?&gt;  componentClass = owner.getClass();</span>
        /*
            Inside the UI namespace are nested classes extending various Swing components.
            Here we check if the component is one of those nested classes.
        */
<span class="fc bfc" id="L502" title="All 2 branches covered.">        while ( componentClass != null ) {</span>
<span class="fc bfc" id="L503" title="All 2 branches covered.">            if ( componentClass.getEnclosingClass() == uiClass )</span>
<span class="fc" id="L504">                return true;</span>
<span class="fc" id="L505">            componentClass = componentClass.getSuperclass();</span>
        }
<span class="fc" id="L507">        return false;</span>
    }

    private void _uninstallCustomBorderBasedStyleAndAnimationRenderer( C owner ) {
<span class="fc" id="L511">        Border currentBorder = owner.getBorder();</span>
<span class="fc bfc" id="L512" title="All 2 branches covered.">        if ( currentBorder instanceof StyleAndAnimationBorder) {</span>
<span class="fc" id="L513">            StyleAndAnimationBorder&lt;?&gt; border = (StyleAndAnimationBorder&lt;?&gt;) currentBorder;</span>
<span class="fc" id="L514">            owner.setBorder(border.getFormerBorder());</span>
        }
<span class="fc" id="L516">    }</span>

    /**
     *  Note that the foreground painter is intended to paint over all children of the component, &lt;br&gt;
     *  which is why it will be called at the end of {@code JComponent::paintChildren(Graphics)}.
     *  &lt;br&gt;
     *  However, there is a problem with this approach! &lt;br&gt;
     *  If not all children are transparent, the result of the foreground painter can be overwritten
     *  by {@link JComponent#paintImmediately(int, int, int, int)} when certain events occur
     *  (like a child component is a text field with a blinking cursor, or a button with hover effect).
     *  This type of repaint does unfortunately not call {@code JComponent::paintChildren(Graphics)},
     *  in fact it completely bypasses the rendering of this current component!
     *  In order to ensure that the stuff painted by the foreground painter is not overwritten
     *  in these types of cases,
     *  we make all children transparent (non-opaque) so that the foreground painter is always visible.
     *
     * @param c The component to make all children transparent.
     */
    private void _makeAllChildrenTransparent( JComponent c ) {
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">        if ( !c.isVisible() )</span>
<span class="nc" id="L536">            return;</span>

<span class="pc bpc" id="L538" title="1 of 2 branches missed.">        if ( c.isOpaque() )</span>
<span class="nc" id="L539">            c.setOpaque(false);</span>

<span class="pc bpc" id="L541" title="1 of 2 branches missed.">        for ( Component child : c.getComponents() ) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if ( child instanceof JComponent ) {</span>
<span class="nc" id="L543">                JComponent jChild = (JComponent) child;</span>
<span class="nc" id="L544">                _makeAllChildrenTransparent(jChild);</span>
            }
        }
<span class="fc" id="L547">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>