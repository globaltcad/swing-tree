<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SVGIcon.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree.style</a> &gt; <span class="el_source">SVGIcon.java</span></div><h1>SVGIcon.java</h1><pre class="source lang-java linenums">package swingtree.style;

import com.github.weisj.jsvg.SVGDocument;
import com.github.weisj.jsvg.attributes.ViewBox;
import com.github.weisj.jsvg.geometry.size.FloatSize;
import com.github.weisj.jsvg.parser.SVGLoader;
import org.slf4j.Logger;
import swingtree.UI;

import javax.swing.ImageIcon;
import javax.swing.JComponent;
import javax.swing.border.Border;
import java.awt.Component;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.Insets;
import java.awt.geom.AffineTransform;
import java.awt.image.BufferedImage;
import java.net.URL;
import java.util.Optional;

/**
 *   A specialized {@link ImageIcon} subclass that allows you to use SVG based icon images in your UI.
 *   This in essence just a wrapper around the JSVG library, which renders SVG images into Java2D graphics API.
 */
public class SVGIcon extends ImageIcon
{
<span class="fc" id="L28">    private static final Logger log = org.slf4j.LoggerFactory.getLogger(SVGIcon.class);</span>

    /**
     *  This enum is used to specify how the SVG image should be scaled to fit the
     *  dimensions of the component that it is being rendered into
     *  using the {@link SVGIcon#paintIcon(java.awt.Component, java.awt.Graphics, int, int, int, int)} method.
     */
<span class="fc" id="L35">    public enum FitComponent {</span>
<span class="fc" id="L36">        WIDTH,</span>
<span class="fc" id="L37">        HEIGHT,</span>
<span class="fc" id="L38">        WIDTH_AND_HEIGHT,</span>
<span class="fc" id="L39">        MAX_DIM,</span>
<span class="fc" id="L40">        MIN_DIM</span>
    }

    private final SVGDocument svgDocument;

    private int _width;
    private int _height;

    private FitComponent _fitComponent;


    public SVGIcon( URL svgUrl, int width, int height, FitComponent fitComponent ) {
<span class="fc" id="L52">        super();</span>
<span class="fc" id="L53">        _width = width;</span>
<span class="fc" id="L54">        _height = height;</span>
<span class="fc" id="L55">        _fitComponent = fitComponent;</span>

<span class="fc" id="L57">        SVGDocument tempSVGDocument = null;</span>
        try {
<span class="fc" id="L59">            SVGLoader loader = new SVGLoader();</span>
<span class="fc" id="L60">            tempSVGDocument = loader.load(svgUrl);</span>
<span class="nc" id="L61">        } catch (Exception e) {</span>
<span class="nc" id="L62">            log.error(&quot;Failed to load SVG document from URL: &quot; + svgUrl, e);</span>
<span class="fc" id="L63">        }</span>
<span class="fc" id="L64">        this.svgDocument = tempSVGDocument;</span>
<span class="fc" id="L65">    }</span>

    public SVGIcon( URL svgUrl, int width, int height ) {
<span class="fc" id="L68">        this(svgUrl, width, height, FitComponent.MIN_DIM);</span>
<span class="fc" id="L69">    }</span>

    public SVGIcon( String path, int width, int height ) {
<span class="nc" id="L72">        this(SVGIcon.class.getResource(path), width, height);</span>
<span class="nc" id="L73">    }</span>

<span class="nc" id="L75">    public SVGIcon( String path ) { this(path, -1, -1); }</span>

<span class="fc" id="L77">    public SVGIcon( URL svgUrl ) { this(svgUrl, -1, -1); }</span>


    @Override
<span class="fc" id="L81">    public int getIconWidth() { return _width; }</span>

<span class="fc" id="L83">    public void setIconWidth( int width ) { _width = width; }</span>

    @Override
<span class="fc" id="L86">    public int getIconHeight() { return _height; }</span>

<span class="fc" id="L88">    public void setIconHeight( int height ) { _height = height; }</span>

<span class="nc" id="L90">    public void setFitComponent( FitComponent fit ) { _fitComponent = fit; }</span>

<span class="nc" id="L92">    public FitComponent getFitComponent() { return _fitComponent; }</span>

    @Override
    public Image getImage() {
        // We create a new buffered image, render into it, and then return it.
<span class="nc" id="L97">        BufferedImage image = new BufferedImage(getIconWidth(), getIconHeight(), BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if ( svgDocument != null )</span>
<span class="nc" id="L99">            svgDocument.render(</span>
                    null,
<span class="nc" id="L101">                    image.createGraphics(),</span>
<span class="nc" id="L102">                    new ViewBox(0, 0, getIconWidth(), getIconHeight())</span>
                );

<span class="nc" id="L105">        return image;</span>
    }

    @Override
    public void setImage( Image image ) {
        // We don't support this.
<span class="nc" id="L111">    }</span>

    @Override
    public void paintIcon( java.awt.Component c, java.awt.Graphics g, int x, int y )
    {
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if ( svgDocument == null )</span>
<span class="nc" id="L117">            return;</span>

<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        Insets insets = Optional.ofNullable( c instanceof JComponent ? ((JComponent)c).getBorder() : null )</span>
<span class="fc" id="L120">                                .map( b -&gt; {</span>
                                    try {
<span class="fc" id="L122">                                        return _determineInsetsForBorder(b, c);</span>
<span class="nc" id="L123">                                    } catch (Exception e) {</span>
<span class="nc" id="L124">                                        return new Insets(0,0,0,0);</span>
                                    }
                                })
<span class="fc" id="L127">                                .orElse(new Insets(0,0,0,0));</span>
<span class="fc" id="L128">        x = insets.left;</span>
<span class="fc" id="L129">        y = insets.top;</span>

<span class="fc" id="L131">        int width  = c.getWidth();</span>
<span class="fc" id="L132">        int height = c.getHeight();</span>

<span class="fc" id="L134">        width  = width  - insets.right  - insets.left;</span>
<span class="fc" id="L135">        height = height - insets.bottom - insets.top;</span>

<span class="fc" id="L137">        paintIcon( c, g, x, y, width, height );</span>
<span class="fc" id="L138">    }</span>

    private Insets _determineInsetsForBorder( Border b, Component c )
    {
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if ( b == null )</span>
<span class="nc" id="L143">            return new Insets(0,0,0,0);</span>

<span class="fc bfc" id="L145" title="All 2 branches covered.">        if ( b instanceof StyleAndAnimationBorder )</span>
<span class="fc" id="L146">            return ((StyleAndAnimationBorder&lt;?&gt;)b).getFullPaddingInsets();</span>

        // Compound border
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if ( b instanceof javax.swing.border.CompoundBorder ) {</span>
<span class="nc" id="L150">            javax.swing.border.CompoundBorder cb = (javax.swing.border.CompoundBorder) b;</span>
<span class="nc" id="L151">            return cb.getOutsideBorder().getBorderInsets(c);</span>
        }

        try {
<span class="fc" id="L155">            return b.getBorderInsets(c);</span>
<span class="nc" id="L156">        } catch (Exception e) {</span>
            // Ignore
        }
<span class="nc" id="L159">        return new Insets(0,0,0,0);</span>
    }

    public void paintIcon(
        java.awt.Component c,
        java.awt.Graphics g,
        int x,
        int y,
        int width,
        int height
    ) {
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        width  = ( width  &lt; 0 ? getIconWidth()  : width  );</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        height = ( height &lt; 0 ? getIconHeight() : height );</span>

<span class="fc" id="L173">        Graphics2D g2d = (Graphics2D) g.create();</span>

<span class="fc" id="L175">        FloatSize svgSize = svgDocument.size();</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        float svgRefWidth  = ( svgSize.width  &gt; svgSize.height ? 1f : svgSize.width  / svgSize.height );</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        float svgRefHeight = ( svgSize.height &gt; svgSize.width  ? 1f : svgSize.height / svgSize.width  );</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        float imgRefWidth  = (     width      &gt;=   height      ? 1f :  (float) width /   height       );</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        float imgRefHeight = (     height     &gt;=   width       ? 1f : (float) height /   width        );</span>

<span class="fc" id="L181">        float scaleX = imgRefWidth  / svgRefWidth;</span>
<span class="fc" id="L182">        float scaleY = imgRefHeight / svgRefHeight;</span>

<span class="pc bpc" id="L184" title="3 of 4 branches missed.">        if ( _fitComponent == FitComponent.MIN_DIM || _fitComponent == FitComponent.MAX_DIM ) {</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            if ( width &lt; height )</span>
<span class="nc" id="L186">                scaleX = 1f;</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">            if ( height &lt; width )</span>
<span class="nc" id="L188">                scaleY = 1f;</span>
        }

<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if ( _fitComponent == FitComponent.WIDTH )</span>
<span class="nc" id="L192">            scaleX = 1f;</span>

<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if ( _fitComponent == FitComponent.HEIGHT )</span>
<span class="nc" id="L195">            scaleY = 1f;</span>

<span class="fc" id="L197">        ViewBox viewBox = new ViewBox(x, y, width, height);</span>
<span class="fc" id="L198">        float boxX      = viewBox.x  / scaleX;</span>
<span class="fc" id="L199">        float boxY      = viewBox.y  / scaleY;</span>
<span class="fc" id="L200">        float boxWidth  = viewBox.width  / scaleX;</span>
<span class="fc" id="L201">        float boxHeight = viewBox.height / scaleY;</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if ( _fitComponent == FitComponent.MAX_DIM ) {</span>
            // We now want to make sure that the
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if ( boxWidth &lt; boxHeight ) {</span>
                // We find the scale factor of the heights between the two rectangles:
<span class="nc" id="L206">                float scaleHeight = ( viewBox.height / svgSize.height );</span>
                // We now want to scale the view box so that both have the same heights:
<span class="nc" id="L208">                float newWidth  = svgSize.width  * scaleHeight;</span>
<span class="nc" id="L209">                float newHeight = svgSize.height * scaleHeight;</span>
<span class="nc" id="L210">                float newX = viewBox.x + (viewBox.width - newWidth) / 2f;</span>
<span class="nc" id="L211">                float newY = viewBox.y;</span>
<span class="nc" id="L212">                viewBox = new ViewBox(newX, newY, newWidth, newHeight);</span>
<span class="nc" id="L213">            } else {</span>
                // We find the scale factor of the widths between the two rectangles:
<span class="nc" id="L215">                float scaleWidth = ( viewBox.width / svgSize.width );</span>
                // We now want to scale the view box so that both have the same widths:
<span class="nc" id="L217">                float newWidth  = svgSize.width  * scaleWidth;</span>
<span class="nc" id="L218">                float newHeight = svgSize.height * scaleWidth;</span>
<span class="nc" id="L219">                float newX = viewBox.x;</span>
<span class="nc" id="L220">                float newY = viewBox.y + (viewBox.height - newHeight) / 2f;</span>
<span class="nc" id="L221">                viewBox = new ViewBox(newX, newY, newWidth, newHeight);</span>
<span class="nc" id="L222">            }</span>
        }
        else
<span class="fc" id="L225">            viewBox = new ViewBox(boxX, boxY, boxWidth, boxHeight);</span>

        // Let's check if the view box exists:
<span class="pc bpc" id="L228" title="2 of 4 branches missed.">        if ( viewBox.width &lt;= 0 || viewBox.height &lt;= 0 )</span>
<span class="nc" id="L229">            return;</span>

        // Also let's check if the view box has valid values:
<span class="pc bpc" id="L232" title="4 of 8 branches missed.">        if ( Float.isNaN(viewBox.x) || Float.isNaN(viewBox.y) || Float.isNaN(viewBox.width) || Float.isNaN(viewBox.height) )</span>
<span class="nc" id="L233">            return;</span>

        // Now onto the actual rendering:

<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        boolean doAntiAliasing  = UI.scale() &lt; 1.5;</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        boolean wasAntiAliasing = g2d.getRenderingHint( java.awt.RenderingHints.KEY_ANTIALIASING ) == java.awt.RenderingHints.VALUE_ANTIALIAS_ON;</span>
<span class="pc bpc" id="L239" title="2 of 4 branches missed.">        if ( doAntiAliasing &amp;&amp; !wasAntiAliasing )</span>
<span class="fc" id="L240">            g2d.setRenderingHint( java.awt.RenderingHints.KEY_ANTIALIASING, java.awt.RenderingHints.VALUE_ANTIALIAS_ON );</span>

<span class="fc" id="L242">        AffineTransform oldTransform = g2d.getTransform();</span>
<span class="fc" id="L243">        AffineTransform newTransform = new AffineTransform(oldTransform);</span>
<span class="fc" id="L244">        newTransform.scale(scaleX, scaleY);</span>

<span class="fc" id="L246">        g2d.setTransform(newTransform);</span>

        try {
            // We also have to scale x and y, this is because the SVGDocument does not
            // account for the scale of the transform with respect to the view box!
<span class="fc" id="L251">            svgDocument.render((JComponent) c, g2d, viewBox);</span>
<span class="nc" id="L252">        } catch (Exception e) {</span>
<span class="nc" id="L253">            log.warn(&quot;Failed to render SVG document: &quot; + svgDocument, e);</span>
<span class="fc" id="L254">        }</span>

<span class="fc" id="L256">        g2d.setTransform(oldTransform);</span>

<span class="pc bpc" id="L258" title="2 of 4 branches missed.">        if ( doAntiAliasing &amp;&amp; !wasAntiAliasing )</span>
<span class="fc" id="L259">            g2d.setRenderingHint( java.awt.RenderingHints.KEY_ANTIALIASING, java.awt.RenderingHints.VALUE_ANTIALIAS_OFF );</span>

<span class="fc" id="L261">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>