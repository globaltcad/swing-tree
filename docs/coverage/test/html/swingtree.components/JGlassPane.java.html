<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JGlassPane.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree.components</a> &gt; <span class="el_source">JGlassPane.java</span></div><h1>JGlassPane.java</h1><pre class="source lang-java linenums">package swingtree.components;


import net.miginfocom.swing.MigLayout;
import org.jspecify.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import swingtree.ComponentDelegate;
import swingtree.DragAwayComponentConf;
import swingtree.UI;
import swingtree.layout.Bounds;
import swingtree.layout.Position;
import swingtree.layout.Size;
import swingtree.style.ComponentExtension;
import swingtree.style.StylableComponent;

import javax.swing.*;
import javax.swing.event.EventListenerList;
import javax.swing.plaf.ComponentUI;
import javax.swing.text.JTextComponent;
import java.awt.*;
import java.awt.datatransfer.StringSelection;
import java.awt.datatransfer.Transferable;
import java.awt.dnd.*;
import java.awt.event.*;
import java.awt.image.BufferedImage;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.WeakHashMap;

import static java.awt.AWTEvent.*;
import static java.awt.event.MouseEvent.*;
import static javax.swing.SwingUtilities.*;

/**
 *  A more advanced glass pane implementation than the default Swing
 *  glass pane of a {@link JRootPane} object (A regular {@link JPanel}.
 *  In contrast to the default glass pane ({@link JPanel}) of a {@link JRootPane},
 *  this pane &lt;b&gt;handles any mouse events, without interrupting the controls underneath
 *  the glass pane (in the content pane of the root pane)&lt;/b&gt;.
 *  Also, cursors are handled as if the glass pane was invisible
 *  (if no cursor gets explicitly set to the glass pane).
 */
public class JGlassPane extends JPanel implements AWTEventListener, StylableComponent
{
    private static final long serialVersionUID = 1L;
<span class="fc" id="L48">    private static final Logger log = LoggerFactory.getLogger(JGlassPane.class);</span>

<span class="fc" id="L50">    private final EventListenerList listeners = new EventListenerList();</span>

    protected @Nullable JRootPane rootPane;
<span class="fc" id="L53">    private static final Map&lt;JGlassPane, ActiveDrag&gt; activeDrags = new WeakHashMap&lt;&gt;();</span>


<span class="fc" id="L56">    public JGlassPane() {</span>
<span class="fc" id="L57">        setLayout(new MigLayout(&quot;fill, ins 0&quot;));</span>
<span class="fc" id="L58">        Toolkit.getDefaultToolkit()</span>
<span class="fc" id="L59">                .addAWTEventListener(</span>
                    this,
                    MOUSE_WHEEL_EVENT_MASK | MOUSE_MOTION_EVENT_MASK | MOUSE_EVENT_MASK
                );

<span class="fc" id="L64">        final DragSource dragSource = DragSource.getDefaultDragSource();</span>
<span class="fc" id="L65">        DragGestureRecognizer[] gestureRecognizer = {null};</span>
<span class="fc" id="L66">        gestureRecognizer[0] = dragSource.createDefaultDragGestureRecognizer(this, DnDConstants.ACTION_COPY, (dragTrigger) -&gt; {</span>
<span class="nc" id="L67">            ActiveDrag activeDrag = getActiveDrag();</span>
<span class="nc" id="L68">            Point dragStart = dragTrigger.getDragOrigin();</span>
<span class="nc" id="L69">            activeDrag = activeDrag.begin(dragStart, rootPane);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if ( activeDrag.equals(ActiveDrag.none()) )</span>
<span class="nc" id="L71">                return;</span>
            else
<span class="nc" id="L73">                setActiveDrag(activeDrag);</span>
<span class="nc" id="L74">            BufferedImage bufferedImage = activeDrag.currentDragImage();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if ( !DragSource.isDragImageSupported() )</span>
<span class="nc" id="L76">                bufferedImage = null;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            int offsetX = bufferedImage == null ? 0 : -bufferedImage.getWidth(null) / 2;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            int offsetY = bufferedImage == null ? 0 : -bufferedImage.getHeight(null) / 2;</span>

<span class="nc" id="L80">            UI.DragAction dragAction = activeDrag.dragConf().map(DragAwayComponentConf::dragAction).orElse(UI.DragAction.NONE);</span>

<span class="nc" id="L82">            gestureRecognizer[0].setSourceActions(dragAction.toIntCode());</span>
<span class="nc" id="L83">            Component draggedComponent = activeDrag.draggedComponent();</span>
<span class="nc" id="L84">            dragTrigger.startDrag(</span>
<span class="nc" id="L85">                    activeDrag.dragConf().map(DragAwayComponentConf::cursor).map(UI.Cursor::toAWTCursor).orElse(Cursor.getDefaultCursor()),</span>
                    bufferedImage,
                    new Point(offsetX, offsetY),
<span class="nc" id="L88">                    activeDrag.dragConf().flatMap(DragAwayComponentConf::payload).orElseGet(() -&gt; _findRelevantDataFor(draggedComponent)),</span>
                    new GlassPaneDragSourceListener()
            );
<span class="nc" id="L91">            activeDrag.dragConf().ifPresent(conf -&gt; {</span>
                try {
<span class="nc" id="L93">                    conf.onDragStart().accept(new ComponentDelegate(conf.component(), dragTrigger));</span>
<span class="nc" id="L94">                } catch (Exception ex) {</span>
<span class="nc" id="L95">                    log.error(</span>
                            &quot;Error while executing drag start event handlers.&quot;,
                            ex
                    );
<span class="nc" id="L99">                }</span>
<span class="nc" id="L100">            });</span>
<span class="nc" id="L101">        });</span>
<span class="fc" id="L102">        dragSource.addDragSourceMotionListener(event -&gt; {</span>
<span class="nc" id="L103">            ActiveDrag activeDrag = getActiveDrag();</span>

<span class="nc bnc" id="L105" title="All 4 branches missed.">            if ( !activeDrag.equals(ActiveDrag.none()) &amp;&amp; rootPane != null ) {</span>
<span class="nc" id="L106">                Point dragStartPoint = determineCurrentDragDropLocationInWindow(event.getLocation(), rootPane);</span>
<span class="nc" id="L107">                MouseEvent e = new MouseEvent(JGlassPane.this, MOUSE_DRAGGED, System.currentTimeMillis(), 0, dragStartPoint.x, dragStartPoint.y, 1, false);</span>
<span class="nc" id="L108">                activeDrag.dragConf().ifPresent(conf -&gt; {</span>
                    try {
<span class="nc" id="L110">                        conf.onDragMove().accept(new ComponentDelegate(conf.component(), event));</span>
<span class="nc" id="L111">                    } catch (Exception ex) {</span>
<span class="nc" id="L112">                        log.error(</span>
                                &quot;Error while executing drag movement event handlers.&quot;,
                                ex
                        );
<span class="nc" id="L116">                    }</span>
<span class="nc" id="L117">                });</span>
<span class="nc" id="L118">                ActiveDrag previousActiveDrag = activeDrag;</span>
<span class="nc" id="L119">                activeDrag = activeDrag.dragged(e, rootPane);</span>
<span class="nc" id="L120">                setActiveDrag(activeDrag);</span>
                /*
                    Note that if the drag image is not supported by the platform, we
                    do the image rendering ourselves directly on the Graphics object
                    of the glass pane of the root pane.
                    But for this to work we need to repaint the area where the drag image was
                    previously rendered and the area where it will be rendered next.
                */
<span class="nc" id="L128">                repaintRootPaneFor(previousActiveDrag, activeDrag);</span>
            }
<span class="nc" id="L130">        });</span>
<span class="fc" id="L131">        setActiveDrag(ActiveDrag.none());</span>
<span class="fc" id="L132">    }</span>

    public JGlassPane(JRootPane rootPane) {
<span class="nc" id="L135">        this();</span>
<span class="nc" id="L136">        Objects.requireNonNull(rootPane);</span>
<span class="nc" id="L137">        attachToRootPane(rootPane);</span>
<span class="nc" id="L138">    }</span>

    private ActiveDrag getActiveDrag() {
<span class="fc" id="L141">        return Optional.ofNullable(activeDrags.get(this)).orElse(ActiveDrag.none());</span>
    }

    private void setActiveDrag(ActiveDrag activeDrag) {
<span class="fc" id="L145">        activeDrags.put(this, activeDrag);</span>
<span class="fc" id="L146">    }</span>

    private void repaintRootPaneFor(ActiveDrag previousActiveDrag, ActiveDrag currentActiveDrag) {
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if ( rootPane == null )</span>
<span class="nc" id="L150">            return;</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        if ( !currentActiveDrag.hasDraggedComponent() )</span>
<span class="nc" id="L153">            return;</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if ( !DragSource.isDragImageSupported() ) {</span>
            /*
                If the drag image is not supported by the platform, we
                do the image rendering ourselves directly on the Graphics object
                of the glass pane of the root pane.
                But for this to work we need to repaint the area where the drag image was
                previously rendered and the area where it will be rendered next.
            */
<span class="nc" id="L163">            Position previousWhereToRender = previousActiveDrag.getRenderPosition();</span>
<span class="nc" id="L164">            Position whereToRenderNext = currentActiveDrag.getRenderPosition();</span>
<span class="nc" id="L165">            Size size = currentActiveDrag.draggedComponentSize();</span>
<span class="nc" id="L166">            Bounds previousArea = Bounds.of(previousWhereToRender, size);</span>
<span class="nc" id="L167">            Bounds nextArea     = Bounds.of(whereToRenderNext, size);</span>
<span class="nc" id="L168">            Bounds mergedArea   = previousArea.merge(nextArea);</span>
<span class="nc" id="L169">            rootPane.repaint(mergedArea.toRectangle());</span>
            /*
                Maybe the local drag operation is currently hovering over another window.
                Let's check that and then repaint the other window's glass pane.
            */
<span class="nc bnc" id="L174" title="All 2 branches missed.">            for (JGlassPane otherWindowGlassPane : activeDrags.keySet()) {</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">                if ( otherWindowGlassPane != this &amp;&amp; otherWindowGlassPane.rootPane != this.rootPane ) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                    if ( otherWindowGlassPane.rootPane == null )</span>
<span class="nc" id="L177">                        continue;</span>

<span class="nc" id="L179">                    ActiveDrag convertedPreviousActiveDrag = convertActiveDragToOtherGlassPane(this, previousActiveDrag, otherWindowGlassPane);</span>
<span class="nc" id="L180">                    ActiveDrag convertedCurrentActiveDrag = convertActiveDragToOtherGlassPane(this, currentActiveDrag, otherWindowGlassPane);</span>
<span class="nc" id="L181">                    Bounds otherPreviousArea = convertedPreviousActiveDrag.getBounds();</span>
<span class="nc" id="L182">                    Bounds otherNextArea = convertedCurrentActiveDrag.getBounds();</span>
<span class="nc" id="L183">                    Bounds otherMergedArea = otherPreviousArea.merge(otherNextArea);</span>
                    // Let's check if the drag image is in the bounds of this glass pane
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    if ( otherWindowGlassPane.getBounds().intersects(otherMergedArea.toRectangle()) ) {</span>
<span class="nc" id="L186">                        otherWindowGlassPane.rootPane.repaint(otherMergedArea.toRectangle());</span>
                    }
                }
<span class="nc" id="L189">            }</span>
        }
<span class="nc" id="L191">    }</span>

    private Point determineCurrentDragDropLocationInWindow( Point locationOnDesktop, JRootPane rootPane ) {
<span class="nc" id="L194">        int relativeX = 0;</span>
<span class="nc" id="L195">        int relativeY = 0;</span>
        // First we try something reliable:
<span class="nc" id="L197">        Point mousePositionInFrame = getMousePosition();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if ( mousePositionInFrame != null ) {</span>
<span class="nc" id="L199">            relativeX = mousePositionInFrame.x;</span>
<span class="nc" id="L200">            relativeY = mousePositionInFrame.y;</span>
        } else {
            // We calculate the mouse position in the frame using the drag event
            try {
<span class="nc" id="L204">                Point rootPaneLocationOnDesktop = rootPane.getLocationOnScreen();</span>
<span class="nc" id="L205">                relativeX = locationOnDesktop.x - rootPaneLocationOnDesktop.x;</span>
<span class="nc" id="L206">                relativeY = locationOnDesktop.y - rootPaneLocationOnDesktop.y;</span>
<span class="nc" id="L207">            } catch (Exception e) {</span>
<span class="nc" id="L208">                log.debug(&quot;Error while calculating the relative position of a drag.&quot;, e);</span>
<span class="nc" id="L209">            }</span>
        }
<span class="nc" id="L211">        return new Point(relativeX, relativeY);</span>
    }

    /** {@inheritDoc} */
    @Override public void paintComponent(Graphics g){
<span class="fc" id="L216">        paintBackground(g, super::paintComponent);</span>
<span class="fc" id="L217">    }</span>

    /** {@inheritDoc} */
    @Override public void paintChildren(Graphics g) {
<span class="fc" id="L221">        paintForeground(g, super::paintChildren);</span>
<span class="fc" id="L222">        getActiveDrag().paint(g);</span>
        /*
            Maybe another window has a glass pane with an ongoing drag operation
            which is currently hovering over our window.
            Let's check that and then paint this other drag image
            on our glass pane.
        */
<span class="fc bfc" id="L229" title="All 2 branches covered.">        for (JGlassPane otherWindowGlassPane : activeDrags.keySet()) {</span>
<span class="pc bpc" id="L230" title="1 of 4 branches missed.">            if ( otherWindowGlassPane != this &amp;&amp; otherWindowGlassPane.rootPane != this.rootPane ) {</span>
<span class="fc" id="L231">                ActiveDrag foreignDrag = otherWindowGlassPane.getActiveDrag();</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">                if ( foreignDrag.equals(ActiveDrag.none()) )</span>
<span class="fc" id="L233">                    continue;</span>
<span class="nc" id="L234">                ActiveDrag foreignDragInLocalCoordinates = convertActiveDragToOtherGlassPane(otherWindowGlassPane, foreignDrag, this);</span>
<span class="nc" id="L235">                Bounds otherBounds = foreignDragInLocalCoordinates.getBounds();</span>
                // Let's check if the drag image is in the bounds of this glass pane
<span class="nc bnc" id="L237" title="All 2 branches missed.">                if ( this.getBounds().intersects(otherBounds.toRectangle()) ) {</span>
<span class="nc" id="L238">                    foreignDragInLocalCoordinates.paint(g);</span>
                }
            }
<span class="fc" id="L241">        }</span>
<span class="fc" id="L242">    }</span>

    private ActiveDrag convertActiveDragToOtherGlassPane(
        JGlassPane sourceGlassPane,
        ActiveDrag sourceDrag,
        JGlassPane targetGlassPane
    ) {
        /*
            We want to convert the other active drag position,
            which is relative to the glass pane, to a position
            relative to this glass pane.
        */
<span class="nc" id="L254">        Point sourcePositionOnDesktop = sourceGlassPane.getLocationOnScreen();</span>
<span class="nc" id="L255">        Point targetPositionOnDesktop = targetGlassPane.getLocationOnScreen();</span>
<span class="nc" id="L256">        Point sourceActiveDragRelativePosition = sourceDrag.getStart().toPoint();</span>
<span class="nc" id="L257">        Point targetActiveDragRelativePosition = new Point(</span>
                sourceActiveDragRelativePosition.x - (targetPositionOnDesktop.x - sourcePositionOnDesktop.x),
                sourceActiveDragRelativePosition.y - (targetPositionOnDesktop.y - sourcePositionOnDesktop.y)
        );
        // Is the other active drag image currently hovering over this glass pane?
<span class="nc" id="L262">        return sourceDrag.withStart(</span>
<span class="nc" id="L263">                        Position.of(</span>
                                targetActiveDragRelativePosition.x,
                                targetActiveDragRelativePosition.y
                        )
                    );
    }

    @Override public void setUISilently( ComponentUI ui ) {
<span class="nc" id="L271">        this.ui = ui;</span>
<span class="nc" id="L272">    }</span>

    /**
     * Resets the UI property with a value from the current look and feel.
     *
     * @see JComponent#updateUI
     */
    @Override
    public void updateUI() {
<span class="fc" id="L281">        ComponentExtension.from(this).installCustomUIIfPossible();</span>
        /*
            The JGlassPane is a SwingTree native type, so it also
            enjoys the perks of having a SwingTree based look and feel!
        */
<span class="fc" id="L286">    }</span>

    /**
     *  Marries this glass pane to the supplied {@link JRootPane} object
     *  and detaches it from the previous root pane using the {@link #detachFromRootPane(JRootPane)} method,
     *  if a previous root pane was attached.
     *
     * @param rootPane The {@link JRootPane} object to which this glass
     *                 pane should be attached.
     */
    protected void attachToRootPane(JRootPane rootPane) {
<span class="fc" id="L297">        Objects.requireNonNull(rootPane);</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if ( this.rootPane != null ) this.detachFromRootPane(this.rootPane);</span>
<span class="fc" id="L299">        this.setOpaque(false);</span>
<span class="fc" id="L300">        ( this.rootPane = rootPane ).setGlassPane(this);</span>
<span class="fc" id="L301">        this.setVisible(true);</span>
<span class="fc" id="L302">    }</span>

    /**
     *  Detaches this glass pane from the supplied {@link JRootPane} object,
     *  if the {@link JRootPane#getGlassPane()} method returns this glass pane.
     *
     * @param rootPane The {@link JRootPane} object from which this glass pane should be detached.
     */
    protected void detachFromRootPane( @Nullable JRootPane rootPane ) {
<span class="nc" id="L311">        Objects.requireNonNull(rootPane);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if ( rootPane.getGlassPane() == this ) {</span>
<span class="nc" id="L313">            rootPane.setGlassPane(null);</span>
<span class="nc" id="L314">            setVisible(false);</span>
        }
<span class="nc" id="L316">    }</span>

    /**
     *  Marries this glass pane to a {@link JRootPane} object.
     *  Note that it is expected that the supplied {@link JRootPane}
     *  is the same root pane that this current glass pane is attached to.
     *  If the supplied {@link JRootPane} is {@code null}, then this glass pane
     *  is detached from the current root pane.
     *
     * @param pane The {@link JRootPane} object to which this glass pane should be attached.
     */
    public void toRootPane(@Nullable JRootPane pane) {
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">        if( pane != null )</span>
<span class="fc" id="L329">            attachToRootPane(pane);</span>
        else
<span class="nc" id="L331">            detachFromRootPane(rootPane);</span>
<span class="fc" id="L332">    }</span>

    @Override public final synchronized MouseListener[] getMouseListeners() {
<span class="nc" id="L335">        return listeners.getListeners(MouseListener.class);</span>
    }
    @Override public final synchronized void addMouseListener(MouseListener listener) {
<span class="fc" id="L338">        listeners.add(MouseListener.class,listener);</span>
<span class="fc" id="L339">    }</span>
    @Override public final synchronized void removeMouseListener(MouseListener listener) {
<span class="nc" id="L341">        listeners.remove(MouseListener.class,listener);</span>
<span class="nc" id="L342">    }</span>

    @Override public final synchronized MouseMotionListener[] getMouseMotionListeners() {
<span class="nc" id="L345">        return listeners.getListeners(MouseMotionListener.class);</span>
    }
    @Override public final synchronized void addMouseMotionListener(MouseMotionListener listener) {
<span class="fc" id="L348">        listeners.add(MouseMotionListener.class,listener);</span>
<span class="fc" id="L349">    }</span>
    @Override public final synchronized void removeMouseMotionListener(MouseMotionListener listener) {
<span class="nc" id="L351">        listeners.remove(MouseMotionListener.class,listener);</span>
<span class="nc" id="L352">    }</span>

    @Override public final synchronized MouseWheelListener[] getMouseWheelListeners() {
<span class="nc" id="L355">        return listeners.getListeners(MouseWheelListener.class);</span>
    }
    @Override public final synchronized void addMouseWheelListener(MouseWheelListener listener) {
<span class="nc" id="L358">        listeners.add(MouseWheelListener.class,listener);</span>
<span class="nc" id="L359">    }</span>
    @Override public final synchronized void removeMouseWheelListener(MouseWheelListener listener) {
<span class="nc" id="L361">        listeners.remove(MouseWheelListener.class,listener);</span>
<span class="nc" id="L362">    }</span>

    @Override
    public void eventDispatched( AWTEvent event ) {
<span class="pc bpc" id="L366" title="1 of 4 branches missed.">        if ( rootPane != null &amp;&amp; event instanceof MouseEvent ) {</span>
<span class="fc" id="L367">            MouseEvent mouseEvent = (MouseEvent)event, newMouseEvent;</span>

<span class="fc" id="L369">            Object source = event.getSource();</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">            if ( source instanceof Component ) {</span>
<span class="fc" id="L371">                Component sourceComponent = (Component) source;</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">                if ( SwingUtilities.getRootPane(sourceComponent) != rootPane )</span>
<span class="fc" id="L373">                    return; //it's not our root pane (e.g. different window)</span>

                /* change source and coordinate system of event to glass pane, DON'T use setSource on AWTEvent's! */
<span class="nc" id="L376">                newMouseEvent = convertMouseEvent(sourceComponent, mouseEvent, this);</span>
<span class="nc" id="L377">            } else newMouseEvent = convertMouseEvent(null, mouseEvent, this);</span>

<span class="nc bnc" id="L379" title="All 9 branches missed.">            switch( event.getID() ) {</span>
                case MOUSE_CLICKED:
<span class="nc bnc" id="L381" title="All 2 branches missed.">                    for(MouseListener listener:listeners.getListeners(MouseListener.class))</span>
<span class="nc" id="L382">                        listener.mouseClicked(newMouseEvent);</span>
<span class="nc" id="L383">                    break;</span>
                case MOUSE_PRESSED:
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    for(MouseListener listener:listeners.getListeners(MouseListener.class))</span>
<span class="nc" id="L386">                        listener.mousePressed(newMouseEvent);</span>
<span class="nc" id="L387">                    break;</span>
                case MOUSE_RELEASED:
<span class="nc bnc" id="L389" title="All 2 branches missed.">                    for(MouseListener listener:listeners.getListeners(MouseListener.class))</span>
<span class="nc" id="L390">                        listener.mouseReleased(newMouseEvent);</span>
<span class="nc" id="L391">                    break;</span>
                case MOUSE_MOVED:
<span class="nc bnc" id="L393" title="All 2 branches missed.">                    for(MouseMotionListener listener:listeners.getListeners(MouseMotionListener.class))</span>
<span class="nc" id="L394">                        listener.mouseMoved(newMouseEvent);</span>
<span class="nc" id="L395">                    break;</span>
                case MOUSE_ENTERED:
<span class="nc bnc" id="L397" title="All 2 branches missed.">                    for(MouseListener listener:listeners.getListeners(MouseListener.class))</span>
<span class="nc" id="L398">                        listener.mouseEntered(newMouseEvent);</span>
<span class="nc" id="L399">                    break;</span>
                case MOUSE_EXITED:
<span class="nc bnc" id="L401" title="All 2 branches missed.">                    for(MouseListener listener:listeners.getListeners(MouseListener.class))</span>
<span class="nc" id="L402">                        listener.mouseExited(newMouseEvent);</span>
<span class="nc" id="L403">                    break;</span>
                case MOUSE_DRAGGED:
<span class="nc bnc" id="L405" title="All 2 branches missed.">                    for(MouseMotionListener listener:listeners.getListeners(MouseMotionListener.class))</span>
<span class="nc" id="L406">                        listener.mouseDragged(newMouseEvent);</span>
<span class="nc" id="L407">                    break;</span>
                case MOUSE_WHEEL:
<span class="nc bnc" id="L409" title="All 2 branches missed.">                    for(MouseWheelListener listener:listeners.getListeners(MouseWheelListener.class))</span>
<span class="nc" id="L410">                        listener.mouseWheelMoved((MouseWheelEvent)newMouseEvent);</span>
                    break;
            }

            /* consume the original mouse event, if the new mouse event was consumed */
<span class="nc bnc" id="L415" title="All 2 branches missed.">            if ( newMouseEvent.isConsumed() )</span>
<span class="nc" id="L416">                mouseEvent.consume();</span>
        }
<span class="fc" id="L418">    }</span>


    /**
     * If someone sets a new cursor to the GlassPane
     * we expect that they know what they are doing
     * and return the super.contains(x,y)
     * otherwise we return false to respect the cursors
     * for the underneath components
     */
    @Override
    public boolean contains(int x, int y) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if ( rootPane == null )</span>
<span class="nc" id="L431">            return false;</span>
<span class="nc" id="L432">        Container container = rootPane.getContentPane();</span>
<span class="nc" id="L433">        Point containerPoint = convertPoint(this, x, y, container);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        if ( containerPoint.y &gt; 0 ) {</span>
<span class="nc" id="L435">            Component component = getDeepestComponentAt(</span>
                                        container,
                                        containerPoint.x,
                                        containerPoint.y
                                    );

<span class="nc bnc" id="L441" title="All 4 branches missed.">            return component == null || component.getCursor() == Cursor.getDefaultCursor();</span>
        }
<span class="nc" id="L443">        else return true;</span>
    }

<span class="nc" id="L446">    class GlassPaneDragSourceListener implements DragSourceListener {</span>
        @Override
        public void dragEnter(DragSourceDragEvent event) {
<span class="nc" id="L449">            getActiveDrag().dragConf().ifPresent(conf -&gt; {</span>
                try {
<span class="nc" id="L451">                    conf.onDragEnter().accept(new ComponentDelegate(conf.component(), event));</span>
<span class="nc" id="L452">                } catch (Exception ex) {</span>
<span class="nc" id="L453">                    log.error(</span>
                            &quot;Error while executing drag enter event handlers.&quot;,
                            ex
                    );
<span class="nc" id="L457">                }</span>
<span class="nc" id="L458">            });</span>
<span class="nc" id="L459">        }</span>
        @Override
        public void dragOver(DragSourceDragEvent event) {
<span class="nc" id="L462">            getActiveDrag().dragConf().ifPresent(conf -&gt; {</span>
                try {
<span class="nc" id="L464">                    conf.onDragOver().accept(new ComponentDelegate(conf.component(), event));</span>
<span class="nc" id="L465">                } catch (Exception ex) {</span>
<span class="nc" id="L466">                    log.error(</span>
                            &quot;Error while executing drag over event handlers.&quot;,
                            ex
                    );
<span class="nc" id="L470">                }</span>
<span class="nc" id="L471">            });</span>
<span class="nc" id="L472">        }</span>
        @Override
        public void dropActionChanged(DragSourceDragEvent event) {
<span class="nc" id="L475">            getActiveDrag().dragConf().ifPresent(conf -&gt; {</span>
                try {
<span class="nc" id="L477">                    conf.onDropActionChanged().accept(new ComponentDelegate(conf.component(), event));</span>
<span class="nc" id="L478">                } catch (Exception ex) {</span>
<span class="nc" id="L479">                    log.error(</span>
                            &quot;Error while executing drop action changed event handlers.&quot;,
                            ex
                    );
<span class="nc" id="L483">                }</span>
<span class="nc" id="L484">            });</span>
<span class="nc" id="L485">        }</span>
        @Override
        public void dragExit(DragSourceEvent event) {
<span class="nc" id="L488">            getActiveDrag().dragConf().ifPresent(conf -&gt; {</span>
                try {
<span class="nc" id="L490">                    conf.onDragExit().accept(new ComponentDelegate(conf.component(), event));</span>
<span class="nc" id="L491">                } catch (Exception ex) {</span>
<span class="nc" id="L492">                    log.error(</span>
                            &quot;Error while executing drag exit event handlers.&quot;,
                            ex
                    );
<span class="nc" id="L496">                }</span>
<span class="nc" id="L497">            });</span>
<span class="nc" id="L498">        }</span>

        @Override
        public void dragDropEnd(DragSourceDropEvent event) {
<span class="nc" id="L502">            ActiveDrag activeDrag = getActiveDrag();</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">            if ( activeDrag.equals(ActiveDrag.none()) )</span>
<span class="nc" id="L504">                return;</span>

<span class="nc" id="L506">            activeDrag.dragConf().ifPresent(conf -&gt; {</span>
                try {
<span class="nc" id="L508">                    conf.onDragDropEnd().accept(new ComponentDelegate(conf.component(), event));</span>
<span class="nc" id="L509">                } catch (Exception ex) {</span>
<span class="nc" id="L510">                    log.error(</span>
                            &quot;Error while executing drag drop end event handlers.&quot;,
                            ex
                    );
<span class="nc" id="L514">                }</span>
<span class="nc" id="L515">            });</span>
<span class="nc" id="L516">            repaintRootPaneFor(activeDrag, activeDrag);</span>
<span class="nc" id="L517">            setActiveDrag(ActiveDrag.none());</span>
<span class="nc" id="L518">        }</span>
    }

    private static Transferable _findRelevantDataFor(@Nullable Component component) {
        try {
<span class="nc bnc" id="L523" title="All 2 branches missed.">            if (component == null)</span>
<span class="nc" id="L524">                return new StringSelection(&quot;&quot;);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">            if (component instanceof TextComponent) {</span>
<span class="nc" id="L526">                String text = ((TextComponent) component).getText();</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                if (text == null)</span>
<span class="nc" id="L528">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L529">                return new StringSelection(text);</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">            } else if (component instanceof JTextComponent) {</span>
<span class="nc" id="L531">                String text = ((JTextComponent) component).getText();</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                if (text == null)</span>
<span class="nc" id="L533">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L534">                return new StringSelection(text);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">            } else if (component instanceof AbstractButton) {</span>
<span class="nc" id="L536">                String text = ((AbstractButton) component).getText();</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                if (text == null)</span>
<span class="nc" id="L538">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            } else if (component instanceof JLabel) {</span>
<span class="nc" id="L540">                String text = ((JLabel) component).getText();</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                if (text == null)</span>
<span class="nc" id="L542">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L543">                return new StringSelection(text);</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">            } else if (component instanceof JList) {</span>
<span class="nc" id="L545">                Object selectedValue = ((JList&lt;?&gt;) component).getSelectedValue();</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (selectedValue == null)</span>
<span class="nc" id="L547">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">            } else if (component instanceof JTable) {</span>
<span class="nc" id="L549">                JTable table = (JTable) component;</span>
<span class="nc" id="L550">                int row = table.getSelectedRow();</span>
<span class="nc" id="L551">                int column = table.getSelectedColumn();</span>
<span class="nc" id="L552">                Object value = table.getValueAt(row, column);</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">                if (value == null)</span>
<span class="nc" id="L554">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L555">                return new StringSelection(value.toString());</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">            } else if (component instanceof JTree) {</span>
<span class="nc" id="L557">                JTree tree = (JTree) component;</span>
<span class="nc" id="L558">                Object lastSelectedPathComponent = tree.getLastSelectedPathComponent();</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                if (lastSelectedPathComponent == null)</span>
<span class="nc" id="L560">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L561">                return new StringSelection(lastSelectedPathComponent.toString());</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">            } else if (component instanceof JTabbedPane) {</span>
<span class="nc" id="L563">                JTabbedPane tabbedPane = (JTabbedPane) component;</span>
<span class="nc" id="L564">                int selectedIndex = tabbedPane.getSelectedIndex();</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">                if (selectedIndex == -1)</span>
<span class="nc" id="L566">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L567">                String titleAt = tabbedPane.getTitleAt(selectedIndex);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (titleAt == null)</span>
<span class="nc" id="L569">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L570">                return new StringSelection(titleAt);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">            } else if (component instanceof JSpinner) {</span>
<span class="nc" id="L572">                Object value = ((JSpinner) component).getValue();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                if (value == null)</span>
<span class="nc" id="L574">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L575">                return new StringSelection(value.toString());</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">            } else if (component instanceof JSlider) {</span>
<span class="nc" id="L577">                int value = ((JSlider) component).getValue();</span>
<span class="nc" id="L578">                return new StringSelection(String.valueOf(value));</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            } else if (component instanceof JProgressBar) {</span>
<span class="nc" id="L580">                int value = ((JProgressBar) component).getValue();</span>
<span class="nc" id="L581">                return new StringSelection(String.valueOf(value));</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">            } else if (component instanceof JComboBox) {</span>
<span class="nc" id="L583">                Object selectedItem = ((JComboBox&lt;?&gt;) component).getSelectedItem();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                if (selectedItem == null)</span>
<span class="nc" id="L585">                    return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L586">                return new StringSelection(selectedItem.toString());</span>
            }
<span class="nc" id="L588">        } catch (Exception ignored) {</span>
<span class="nc" id="L589">            return new StringSelection(&quot;&quot;);</span>
<span class="nc" id="L590">        }</span>
<span class="nc" id="L591">        return new StringSelection(&quot;&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>