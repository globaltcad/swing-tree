<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComponentAnimator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swing-tree</a> &gt; <a href="index.source.html" class="el_package">swingtree.animation</a> &gt; <span class="el_source">ComponentAnimator.java</span></div><h1>ComponentAnimator.java</h1><pre class="source lang-java linenums">package swingtree.animation;

import org.slf4j.Logger;

import javax.swing.JComponent;
import java.awt.Component;
import java.awt.event.ActionEvent;
import java.lang.ref.WeakReference;
import java.util.Objects;
import java.util.Optional;
import java.util.concurrent.TimeUnit;

/**
 *  Runs an {@link Animation} on a {@link Component} according to a {@link LifeTime} and a {@link RunCondition}.
 */
class ComponentAnimator
{
<span class="fc" id="L18">    private static final Logger log = org.slf4j.LoggerFactory.getLogger(ComponentAnimator.class);</span>

    private final WeakReference&lt;Component&gt; _compRef;
    private final LifeTime      _lifeTime;
    private final RunCondition _condition;
    private final Animation     _animation;


    ComponentAnimator(
        Component     component, // may be null if the animation is not associated with a specific component
        LifeTime      lifeTime,
        RunCondition condition,
        Animation     animation
<span class="fc" id="L31">    ) {</span>
<span class="fc bfc" id="L32" title="All 2 branches covered.">        _compRef   = component == null ? null : new WeakReference&lt;&gt;(component);</span>
<span class="fc" id="L33">        _lifeTime  = Objects.requireNonNull(lifeTime);</span>
<span class="fc" id="L34">        _condition = Objects.requireNonNull(condition);</span>
<span class="fc" id="L35">        _animation = Objects.requireNonNull(animation);</span>
<span class="fc" id="L36">    }</span>

    public Optional&lt;JComponent&gt; component() {
<span class="fc bfc" id="L39" title="All 2 branches covered.">        if ( _compRef == null ) return Optional.empty();</span>
<span class="fc" id="L40">        Component _component = this._compRef.get();</span>
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">        return Optional.ofNullable( _component instanceof JComponent ? (JComponent) _component : null );</span>
    }

    private AnimationState _createState( long now, ActionEvent event ) {
<span class="fc" id="L45">        long duration = _lifeTime.getDurationIn(TimeUnit.MILLISECONDS);</span>
<span class="fc" id="L46">        long howLongIsRunning = Math.max(0, now - _lifeTime.getStartTimeIn(TimeUnit.MILLISECONDS));</span>
<span class="fc" id="L47">        long howLongCurrentLoop = howLongIsRunning % duration;</span>
<span class="fc" id="L48">        long howManyLoops       = howLongIsRunning / duration;</span>
<span class="fc" id="L49">        double progress         = howLongCurrentLoop / (double) duration;</span>
<span class="fc" id="L50">        return new AnimationState() {</span>
<span class="fc" id="L51">            @Override public double     progress()  { return progress;     }</span>
<span class="fc" id="L52">            @Override public long        repeats()  { return howManyLoops; }</span>
<span class="fc" id="L53">            @Override public LifeTime    lifetime() { return _lifeTime;    }</span>
<span class="nc" id="L54">            @Override public ActionEvent event()    { return event;        }</span>
        };
    }

    boolean run( long now, ActionEvent event )
    {
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if ( now &lt; _lifeTime.getStartTimeIn(TimeUnit.MILLISECONDS) )</span>
<span class="nc" id="L61">            return true;</span>

<span class="fc" id="L63">        AnimationState state = _createState(now, event);</span>
<span class="fc" id="L64">        boolean shouldContinue = false;</span>

        try {
<span class="fc" id="L67">            shouldContinue = _condition.shouldContinue(state);</span>
<span class="nc" id="L68">        } catch ( Exception e ) {</span>
<span class="nc" id="L69">            log.warn(&quot;An exception occurred while checking if an animation should continue!&quot;, e);</span>
            /*
                 If exceptions happen in user provided animation stop conditions,
                 then we don't want to mess up the rest of the animation logic, so we catch
                 any exceptions right here!

				 We log as warning because exceptions during rendering are not considered
				 as harmful as elsewhere!

                 Hi there! If you are reading this, you are probably a developer using the SwingTree
                 library, thank you for using it! Good luck finding out what went wrong! :)
            */
<span class="fc" id="L81">        }</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">        Component component = _compRef == null ? null : _compRef.get();</span>

<span class="pc bpc" id="L85" title="1 of 4 branches missed.">        if ( _compRef != null &amp;&amp; component == null )</span>
<span class="nc" id="L86">            return false; // There was a component but it has been garbage collected.</span>

<span class="fc bfc" id="L88" title="All 2 branches covered.">        if ( !shouldContinue ) {</span>
            try {
<span class="fc" id="L90">                _animation.finish(state); // An animation may want to do something when it is finished (e.g. reset the component to its original state).</span>
<span class="nc" id="L91">            } catch ( Exception e ) {</span>
<span class="nc" id="L92">                log.warn(&quot;An exception occurred while executing the finish procedure of an animation!&quot;, e);</span>
                /*
                     If exceptions happen in the finishing procedure of animations provided by the user,
                     then we don't want to mess up the execution of the rest of the animations,
                     so we catch any exceptions right here!

				     We log as warning because exceptions during rendering are not considered
				     as harmful as elsewhere!

                     Hi there! If you are reading this, you are probably a developer using the SwingTree
                     library, thank you for using it! Good luck finding out what went wrong! :)
                */
<span class="fc" id="L104">            }</span>
<span class="fc" id="L105">            return false;</span>
        }

        try {
<span class="fc" id="L109">            _animation.run(state);</span>
<span class="nc" id="L110">        } catch ( Exception e ) {</span>
<span class="nc" id="L111">            log.warn(&quot;An exception occurred while executing an animation!&quot;, e);</span>
            /*
                 If exceptions happen in the animations provided by the user,
                 then we don't want to mess up the execution of the rest of the animations,
                 so we catch any exceptions right here!

				 We log as warning because exceptions during rendering are not considered
				 as harmful as elsewhere!

                 Hi there! If you are reading this, you are probably a developer using the SwingTree
                 library, thank you for using it! Good luck finding out what went wrong! :)
            */
<span class="fc" id="L123">        }</span>

<span class="fc bfc" id="L125" title="All 2 branches covered.">        if ( component != null ) {</span>
<span class="fc" id="L126">            component.revalidate();</span>
<span class="fc" id="L127">            component.repaint();</span>
        }

<span class="fc" id="L130">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>